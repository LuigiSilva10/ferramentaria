    <!DOCTYPE html>
        <html lang="pt-br">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>LDC | Ferramentaria Pro</title>
            
            <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ†Ô∏è</text></svg>">
            <script src="https://cdn.tailwindcss.com"></script>
            <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
            <script src="https://unpkg.com/lucide@latest"></script>

            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
            <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
            <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

            <style>
                @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap');
                
                :root {
                    --brand-primary: #0F172A;
                    --brand-action: #2563EB;
                    --bg-main: #F8FAFC;
                }

                body { 
                    font-family: 'Plus Jakarta Sans', sans-serif; 
                    background-color: var(--bg-main); 
                    display: flex;
                    height: 100vh;
                    overflow-y: hidden;
                    color: #1E293B;
                }

                .sidebar { width: 280px; transition: all 0.3s ease; background-color: #0B1120; border-right: 1px solid #1E293B; }
                .sidebar.collapsed { width: 80px; }
                
                .main-content { flex: 1; display: none; opacity: 0; transform: translateY(10px); transition: all 0.4s ease; overflow-y: auto; }
                .main-content.active-section { display: block; opacity: 1; transform: translateY(0); }
                
                .nav-btn { width: 100%; display: flex; align-items: center; gap: 1rem; padding: 0.75rem 1rem; border-radius: 0.75rem; font-weight: 700; color: #64748B; transition: all 0.2s; border: none; cursor: pointer; background: transparent; }
                .nav-btn:hover { color: #F1F5F9; background-color: #1E293B; }
                .nav-btn.active { background-color: var(--brand-action); color: white; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3); }
                
                .custom-scrollbar::-webkit-scrollbar { width: 8px; }
                .custom-scrollbar::-webkit-scrollbar-thumb { background: #94A3B8; border-radius: 10px; }
                
                .status-quebrado { background-color: #FFF1F2 !important; color: #E11D48 !important; border: 1px solid #FDA4AF; font-weight: 700; }
                
                .filter-pill { padding: 0.5rem 1.25rem; border-radius: 20px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; transition: all 0.2s; border: 1px solid transparent; cursor: pointer; }
                .filter-pill.active { border-color: currentColor; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }

                .img-container { cursor: pointer !important; }

                .dashboard-filter-btn {
                    background-color: #e2e8f0;
                    color: #475569;
                    padding: 0.25rem 0.75rem;
                    border-radius: 0.5rem;
                    font-size: 0.75rem;
                    font-weight: 700;
                    text-transform: uppercase;
                    border: none;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                .dashboard-filter-btn:hover { background-color: #cbd5e1; }
                .dashboard-filter-btn.active { background-color: var(--brand-action); color: white; }

                .soft-ui-panel {
                    background: #F8FAFC;
                    border-radius: 1.5rem;
                    padding: 1.5rem;
                    box-shadow: 8px 8px 16px #d1d9e6, -8px -8px 16px #ffffff;
                }

                /* Flatpickr Customization for Gray/Silver Theme */
                .flatpickr-calendar {
                    background: #F8FAFC;
                    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                    border: 1px solid #E2E8F0;
                    border-radius: 1rem;
                }
                .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange, .flatpickr-day.selected.inRange, .flatpickr-day.startRange.inRange, .flatpickr-day.endRange.inRange, .flatpickr-day.selected:focus, .flatpickr-day.startRange:focus, .flatpickr-day.endRange:focus, .flatpickr-day.selected:hover, .flatpickr-day.startRange:hover, .flatpickr-day.endRange:hover, .flatpickr-day.selected.prevMonthDay, .flatpickr-day.startRange.prevMonthDay, .flatpickr-day.endRange.prevMonthDay, .flatpickr-day.selected.nextMonthDay, .flatpickr-day.startRange.nextMonthDay, .flatpickr-day.endRange.nextMonthDay {
                    background: #64748B; /* Slate-500 */
                    border-color: #64748B;
                    color: #fff;
                }
                .flatpickr-day.today {
                    border-color: #94A3B8; /* Slate-400 */
                }
                .flatpickr-day:hover {
                    background: #E2E8F0;
                }
                .flatpickr-months .flatpickr-month, .flatpickr-current-month .flatpickr-monthDropdown-months, .flatpickr-weekdays {
                    background: #F8FAFC;
                    color: #1E293B;
                    fill: #1E293B;
                }
                span.flatpickr-weekday {
                    color: #64748B;
                }
            </style>
        </head>
        <body class="bg-slate-50">

            <aside id="sidebar" class="sidebar text-slate-400 flex flex-col sticky top-0 h-screen z-50">
                <div class="p-6 flex items-center justify-between">
                    <h1 class="text-white font-black text-xl sidebar-text uppercase tracking-tighter">LDC PRO</h1>
                    <button onclick="toggleSidebar()" class="text-slate-400 hover:text-white bg-transparent border-none cursor-pointer"><i data-lucide="menu"></i></button>
                </div>
                <nav class="flex-1 px-4 space-y-2 mt-4">
                    <button id="btn-main" onclick="showSection('main')" class="nav-btn active"><i data-lucide="layout-dashboard"></i> <span class="sidebar-text">Painel Principal</span></button>
                    <button id="btn-catalog" onclick="showSection('catalog')" class="nav-btn"><i data-lucide="archive"></i> <span class="sidebar-text">Estoque</span></button>
                    <button id="btn-team" onclick="showSection('team')" class="nav-btn"><i data-lucide="users"></i> <span class="sidebar-text">Equipe</span></button>
                    <button id="btn-maintenance" onclick="showSection('maintenance')" class="nav-btn"><i data-lucide="wrench"></i> <span class="sidebar-text">FollowUp</span></button>
                    <button id="btn-logs" onclick="showSection('logs')" class="nav-btn"><i data-lucide="history"></i> <span class="sidebar-text">Hist√≥rico</span></button>
                    <button id="btn-database" onclick="showSection('database')" class="nav-btn"><i data-lucide="database"></i> <span class="sidebar-text">Backup</span></button>
                            <button id="btn-tests" onclick="showSection('tests')" class="nav-btn"><i data-lucide="beaker"></i> <span class="sidebar-text">Testes</span></button>
                </nav>
            </aside>

            <main id="section-main" class="main-content p-4 md:p-8 active-section">
                <div class="max-w-[1400px] mx-auto">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900 uppercase tracking-tighter">Invent√°rio Operacional</h2>
                            <p id="currentDateDisplay" class="text-slate-500 text-[10px] font-bold uppercase tracking-widest"></p>
                        </div>
                        <div class="flex flex-row gap-3 flex-wrap">
                            <button onclick="openAddModal('disponivel')" class="bg-emerald-600 text-white px-4 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg text-[10px] uppercase tracking-widest hover:bg-emerald-700 transition-all border-none cursor-pointer"><i data-lucide="plus" size="16"></i> Novo Item</button>
                            <button onclick="openMaterialModal()" id="mainCheckoutBtn" class="relative bg-indigo-600 text-white px-4 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg text-[10px] uppercase tracking-widest hover:bg-indigo-700 transition-all border-none cursor-pointer">
                                <i data-lucide="package-minus" size="16"></i>
                                <span>Sa√≠da de Ferramentas</span>
                                <span id="mainOverdueBadge" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-rose-500 rounded-full border-2 border-slate-50"></span>
                            </button>
                            <button onclick="openMaintenanceModal()" class="bg-red-600 text-white px-4 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg text-[10px] uppercase tracking-widest hover:bg-red-700 transition-all border-none cursor-pointer"><i data-lucide="wrench" size="16"></i> Reportar Manuten√ß√£o</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div class="lg:col-span-12 space-y-6">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="soft-ui-panel"><p class="text-slate-400 text-[10px] font-bold uppercase mb-1">Total Geral</p><h2 id="totalCount" class="text-2xl font-black">0</h2></div>
                                <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm"><p class="text-emerald-500 text-[10px] font-bold uppercase mb-1">Dispon√≠veis</p><h2 id="availCount" class="text-2xl font-black text-emerald-600">0</h2></div>
                                <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm"><p class="text-orange-500 text-[10px] font-bold uppercase mb-1">Em Uso</p><h2 id="loanCount" class="text-2xl font-black text-orange-500">0</h2></div>
                                <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm"><p class="text-red-500 text-[10px] font-bold uppercase mb-1">Manuten√ß√£o</p><h2 id="brokenCount" class="text-2xl font-black text-red-600">0</h2></div>
                            </div>
                            
                            <div class="bg-white rounded-[2rem] shadow-xl overflow-hidden border border-slate-100">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-slate-50 text-slate-500 text-[10px] font-bold uppercase tracking-wider">
                                        <tr><th class="px-8 py-4">Equipamento</th><th class="px-8 py-4">Status / Respons√°vel</th><th class="px-8 py-4 text-right">A√ß√µes</th></tr>
                                    </thead>
                                    <tbody id="toolList" class="divide-y divide-slate-50"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <main id="section-catalog" class="main-content p-4 md:p-8">
                <div class="max-w-[1400px] mx-auto">
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 tracking-tighter uppercase">Estoque</h2>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="relative w-full md:w-80">
                                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size="16"></i>
                                <input type="text" id="catalogSearchInput" onkeyup="handleSearchInput(this, renderCatalog)" placeholder="BUSCAR POR NOME, C√ìDIGO OU MARCA..." class="w-full bg-white border-2 border-slate-100 rounded-xl pl-12 pr-10 py-3 font-bold uppercase text-xs outline-none focus:border-blue-500 transition-all">
                                <button onclick="clearSearch('catalogSearchInput', renderCatalog)" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-rose-500 hidden z-10"><i data-lucide="x-circle" size="16"></i></button>
                            </div>
                        </div>
                    </div>
                    <button id="overdueBtn" onclick="openOverdueModal()" class="hidden w-full mb-8 relative bg-rose-600 text-white px-6 py-4 rounded-2xl font-bold flex items-center gap-3 shadow-lg text-sm uppercase tracking-widest hover:bg-rose-700 transition-all border-none cursor-pointer">
                        <i data-lucide="alert-triangle" class="text-rose-200"></i>
                        <span id="overdueCountBadge" class="font-black">0</span>
                        <span>Ferramenta(s) com devolu√ß√£o atrasada. Clique para ver.</span>
                    </button>
                    <div class="flex gap-4 mb-8">
                        <button onclick="setCatalogFilter('all')" id="filter-all" class="filter-pill active bg-slate-200 text-slate-700">Todos</button>
                        <button onclick="setCatalogFilter('disponivel')" id="filter-disponivel" class="filter-pill bg-emerald-100 text-emerald-600">Dispon√≠veis</button>
                        <button onclick="setCatalogFilter('em uso')" id="filter-uso" class="filter-pill bg-orange-100 text-orange-600">Em Uso</button>
                        <button onclick="setCatalogFilter('quebrado')" id="filter-quebrado" class="filter-pill bg-red-100 text-red-600">Manuten√ß√£o</button>
                        <div class="flex-1 flex justify-end gap-4 flex-wrap">
                            <div class="bg-white p-3 px-5 rounded-xl border border-slate-100 shadow-sm text-right">
                                <p class="text-slate-400 text-[8px] font-bold uppercase">Valor Total</p><h2 id="catalogTotalValue" class="text-lg font-black text-emerald-600">R$ 0,00</h2>
                            </div>
                            <div class="bg-white p-3 px-5 rounded-xl border border-slate-100 shadow-sm text-right">
                                <p class="text-slate-400 text-[8px] font-bold uppercase">Pe√ßas Totais</p>
                                <h2 class="text-lg font-black text-slate-800 flex items-center justify-end gap-2"><i data-lucide="box" size="20" class="text-slate-400"></i><span id="catalogTotalQty">0</span></h2>
                            </div>
                        </div>
                    </div>
                    <div id="catalogGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8"></div>
                </div>
            </main>

            <main id="section-logs" class="main-content p-4 md:p-8">
                <div class="max-w-[1400px] mx-auto">
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
                        <h2 class="text-3xl font-black text-slate-900 tracking-tighter uppercase">Hist√≥rico</h2>
                        <div class="flex flex-col md:flex-row gap-2 items-center flex-wrap">
                            <div class="relative w-full md:w-72">
                                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size="16"></i>
                                <input type="text" id="historySearchInput" onkeyup="handleSearchInput(this, renderHistory)" placeholder="PESQUISAR..." class="w-full bg-white border-2 border-slate-100 rounded-xl pl-12 pr-10 py-3 font-bold uppercase text-xs outline-none focus:border-blue-500 transition-all">
                                <button onclick="clearSearch('historySearchInput', renderHistory)" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-rose-500 hidden z-10"><i data-lucide="x-circle" size="16"></i></button>
                            </div>
                            <div class="relative">
                                <i data-lucide="calendar-days" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size="16"></i>
                                <input type="text" id="historyDateInput" placeholder="FILTRAR POR DATA..." class="w-full md:w-56 bg-white border-2 border-slate-100 rounded-xl pl-12 pr-10 py-3 font-bold uppercase text-xs outline-none focus:border-blue-500 transition-all h-[47px] cursor-pointer">
                                <button id="clearDateBtn" onclick="clearHistoryDateFilter()" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-rose-500 hidden z-10"><i data-lucide="x-circle" size="16"></i></button>
                            </div>
                        </div>
                    </div>
                    <div id="historyGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
            </main>

            <main id="section-team" class="main-content p-4 md:p-8">
                <div class="max-w-[1400px] mx-auto">
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 tracking-tighter uppercase">Gest√£o de Equipe</h2>
                        </div>
                        <div class="flex-1 flex justify-end gap-2 flex-wrap">
                            <input type="text" id="workerNameInput" placeholder="NOME DO COLABORADOR" class="w-full md:w-48 border-2 border-slate-100 rounded-xl px-4 py-3 font-bold uppercase text-xs outline-none focus:border-blue-500 transition-all">
                            <input type="text" id="workerCompanyInput" placeholder="EMPRESA / DEPARTAMENTO" class="w-full md:w-48 border-2 border-slate-100 rounded-xl px-4 py-3 font-bold uppercase text-xs outline-none focus:border-blue-500 transition-all">
                            <button onclick="addWorker()" class="bg-blue-600 text-white px-5 rounded-xl border-none cursor-pointer hover:bg-blue-700 transition-all shadow-md"><i data-lucide="plus"></i></button>
                        </div>
                    </div>
                    <div class="relative mb-8 w-full md:w-80">
                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size="16"></i>
                        <input type="text" id="teamSearchInput" onkeyup="handleSearchInput(this, renderTeam)" placeholder="PESQUISAR POR NOME OU EMPRESA..." class="w-full bg-white border-2 border-slate-100 rounded-xl pl-12 pr-10 py-3 font-bold uppercase text-xs outline-none focus:border-blue-500 transition-all">
                        <button onclick="clearSearch('teamSearchInput', renderTeam)" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-rose-500 hidden z-10"><i data-lucide="x-circle" size="16"></i></button>
                    </div>
                    <div id="teamGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
                </div>
            </main>

            <main id="section-maintenance" class="main-content p-4 md:p-8">
                <div class="max-w-[1400px] mx-auto">
                    <div class="flex justify-between items-start mb-8">
                        <h2 class="text-3xl font-black text-slate-900 tracking-tighter uppercase">Follow-Up de Manuten√ß√£o</h2>
                        <div class="bg-white p-3 px-5 rounded-xl border border-slate-100 shadow-sm text-right">
                            <p class="text-slate-400 text-[8px] font-bold uppercase">Total em Manuten√ß√£o</p>
                            <h2 class="text-lg font-black text-red-600 flex items-center justify-end gap-2"><i data-lucide="wrench" size="20" class="text-red-400"></i><span id="maintenanceTotalCount">0</span></h2>
                        </div>
                    </div>
                    <div class="relative mb-8 w-full md:w-80">
                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size="16"></i>
                        <input type="text" id="maintenanceSearchInput" onkeyup="handleSearchInput(this, renderMaintenance)" placeholder="PESQUISAR POR NOME, C√ìDIGO OU RESPONS√ÅVEL..." class="w-full bg-white border-2 border-slate-100 rounded-xl pl-12 pr-10 py-3 font-bold uppercase text-xs outline-none focus:border-blue-500 transition-all">
                        <button onclick="clearSearch('maintenanceSearchInput', renderMaintenance)" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-rose-500 hidden z-10"><i data-lucide="x-circle" size="16"></i></button>
                    </div>
                    <div class="flex gap-2 mb-8 flex-wrap">
                        <button onclick="setMaintenanceFilter('all')" id="maint-filter-all" class="filter-pill active bg-slate-200 text-slate-700">Todos</button>
                        <button onclick="setMaintenanceFilter('Aguardando Or√ßamento')" id="maint-filter-aguardando-or√ßamento" class="filter-pill bg-amber-100 text-amber-600">Aguardando Or√ßamento</button>
                        <button onclick="setMaintenanceFilter('Aguardando Aprova√ß√£o')" id="maint-filter-aguardando-aprova√ß√£o" class="filter-pill bg-sky-100 text-sky-600">Aguardando Aprova√ß√£o</button>
                        <button onclick="setMaintenanceFilter('Em Conserto')" id="maint-filter-em-conserto" class="filter-pill bg-indigo-100 text-indigo-600">Em Conserto</button>
                        <button onclick="setMaintenanceFilter('Finalizado')" id="maint-filter-finalizado" class="filter-pill bg-emerald-100 text-emerald-600">Finalizados</button>
                    </div>
                    <div id="maintenanceGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
            </main>

            <div id="zoomModal" class="fixed inset-0 bg-black/90 hidden z-[950] flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeModal('zoomModal')">

                <button onclick="closeModal('zoomModal'); event.stopPropagation();" class="absolute top-5 right-5 text-white bg-transparent border-none cursor-pointer z-[951]"><i data-lucide="x" size="32"></i></button>
                <div id="zoomContainer" class="w-full h-full flex items-center justify-center overflow-hidden">
                    <img id="zoomImage" class="max-w-full max-h-full object-contain rounded-xl shadow-2xl transition-transform duration-200 ease-out cursor-zoom-in" onclick="event.stopPropagation()">
                    <iframe id="zoomIframe" class="w-full h-full max-w-5xl bg-white rounded-xl shadow-2xl hidden" onclick="event.stopPropagation()"></iframe>
                </div>
            </div>

            <div id="deleteModal" class="fixed inset-0 bg-slate-900/80 hidden z-[960] flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeModal('deleteModal')">
                <div class="bg-white rounded-[2rem] p-8 w-full max-w-sm text-center shadow-2xl" onclick="event.stopPropagation()">
                    <div class="w-16 h-16 bg-rose-50 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="alert-circle" size="32"></i></div>
                    <h3 class="text-lg font-black text-slate-900 uppercase mb-2">Excluir Item?</h3>
                    <p class="text-slate-500 text-sm mb-6">Voc√™ tem certeza que deseja remover este item? Esta a√ß√£o n√£o pode ser desfeita.</p>
                    <div class="flex gap-3">
                        <button onclick="closeModal('deleteModal')" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold uppercase text-[10px] cursor-pointer border-none">Cancelar</button>
                        <button id="confirmDeleteBtn" class="flex-1 py-3 bg-rose-600 text-white rounded-xl font-bold uppercase text-[10px] cursor-pointer border-none shadow-lg hover:bg-rose-700 transition-all">Confirmar</button>
                    </div>
                </div>
            </div>

            <div id="alertModal" class="fixed inset-0 bg-slate-900/80 hidden z-[900] flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeModal('alertModal')">
                <div class="bg-white rounded-[2rem] p-8 w-full max-w-sm text-center shadow-2xl" onclick="event.stopPropagation()">
                    <div class="w-16 h-16 bg-orange-50 text-orange-500 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="alert-triangle" size="32"></i></div>
                    <h3 id="alertModalTitle" class="text-lg font-black text-slate-900 uppercase mb-2">Aten√ß√£o</h3>
                    <p id="alertModalText" class="text-slate-500 text-sm mb-6">Mensagem de alerta.</p>
                    <button onclick="closeModal('alertModal')" class="w-full py-3 bg-slate-100 text-slate-600 rounded-xl font-bold uppercase text-[10px] cursor-pointer border-none hover:bg-slate-200 transition-all">Entendido</button>
                </div>
            </div>

            <div id="returnModal" class="fixed inset-0 bg-slate-900/80 hidden z-[700] flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeModal('returnModal')">
                <div class="bg-white rounded-[2rem] p-8 w-full max-w-sm text-center shadow-2xl" onclick="event.stopPropagation()">
                    <div class="w-16 h-16 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="activity" size="32"></i></div>
                    <h3 id="returnModalTitle" class="text-lg font-black text-slate-900 uppercase mb-2">Estado da Ferramenta</h3>
                    <p id="returnModalText" class="text-slate-500 text-sm mb-6">Qual o estado de devolu√ß√£o do item?</p>
                    <div class="flex gap-3">
                        <button id="btnReturnBroken" class="flex-1 py-3 bg-rose-600 text-white rounded-xl font-bold uppercase text-[10px] cursor-pointer border-none shadow-lg hover:bg-rose-700">Quebrado</button>
                        <button id="btnReturnWorking" class="flex-1 py-3 bg-emerald-500 text-white rounded-xl font-bold uppercase text-[10px] cursor-pointer border-none shadow-lg hover:bg-emerald-600">Funcionando</button>
                    </div>
                    <button onclick="closeModal('returnModal')" class="w-full mt-6 py-4 bg-slate-100 text-slate-600 rounded-2xl font-black uppercase text-xs border-none cursor-pointer hover:bg-slate-200">Cancelar</button>
                </div>
            </div>

            <div id="addModal" class="fixed inset-0 bg-slate-900/90 hidden z-[800] flex items-center justify-center p-4 backdrop-blur-md" onclick="closeModal('addModal')">
                <div class="bg-white rounded-[2.5rem] w-full max-w-2xl overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
                    <div class="bg-slate-50 p-6 border-b border-slate-100 flex justify-between items-center">
                        <h3 id="addModalTitle" class="font-black uppercase tracking-tighter text-slate-900">Novo Item</h3>
                        <button onclick="closeModal('addModal'); event.stopPropagation();" class="text-slate-400 hover:text-rose-500 bg-transparent border-none cursor-pointer"><i data-lucide="x"></i></button>
                    </div>
                    <div class="p-8 max-h-[80vh] overflow-y-auto custom-scrollbar">
                        <div class="space-y-3">
                            <div class="border-2 border-dashed border-slate-200 rounded-2xl p-4 text-center h-40 flex items-center justify-center cursor-pointer hover:bg-slate-50 transition-colors group" onclick="document.getElementById('fileInput').click()">
                                <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="previewImage(this)">
                                <div id="uploadPlaceholder" class="text-slate-400">
                                    <i data-lucide="camera" class="mx-auto" size="24"></i>
                                    <p class="text-[8px] font-black uppercase">Adicionar Foto</p>
                                </div>
                                <div id="imagePreviewContainer" class="hidden relative h-full" title="Clique para alterar a imagem"><img id="imagePreview" class="h-full object-contain rounded-lg transition-opacity group-hover:opacity-80"><button onclick="removeImage(event)" class="absolute top-1 right-1 bg-rose-500 text-white rounded-full p-0.5 leading-none shadow-md border-2 border-white cursor-pointer" title="Remover Imagem"><i data-lucide="x" size="14"></i></button></div>
                            </div>
                            <div>
                                <label for="toolCodeInput" class="text-[10px] font-black uppercase text-slate-400 ml-4">C√≥digo (#)</label>
                                <input type="text" id="toolCodeInput" placeholder="C√ìDIGO / TAG" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 font-bold uppercase text-xs outline-none focus:border-emerald-500 transition-all">
                            </div>
                            <div>
                                <label for="toolNameInput" class="text-[10px] font-black uppercase text-slate-400 ml-4">Nome do Equipamento</label>
                                <input type="text" id="toolNameInput" placeholder="NOME DA FERRAMENTA" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 font-bold uppercase text-xs outline-none focus:border-emerald-500 transition-all">
                            </div>
                            <div>
                                <label for="toolBrandInput" class="text-[10px] font-black uppercase text-slate-400 ml-4">Marca</label>
                                <input type="text" id="toolBrandInput" placeholder="MARCA DA FERRAMENTA" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 font-bold uppercase text-xs outline-none focus:border-emerald-500 transition-all">
                            </div>
                            <div>
                                <label for="toolWeightInput" class="text-[10px] font-black uppercase text-slate-400 ml-4">Peso</label>
                                <input type="number" id="toolWeightInput" placeholder="PESO (KG)" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 font-bold uppercase text-xs outline-none focus:border-emerald-500 transition-all">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label for="toolValueInput" class="text-[10px] font-black uppercase text-slate-400 ml-4">Valor (R$)</label>
                                    <input type="number" id="toolValueInput" placeholder="150,00" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 font-bold text-xs outline-none focus:border-emerald-500 transition-all">
                                </div>
                                <div>
                                    <label for="toolQtyInput" class="text-[10px] font-black uppercase text-slate-400 ml-4">Quantidade</label>
                                    <input type="number" id="toolQtyInput" placeholder="1" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 font-bold text-xs outline-none focus:border-emerald-500 transition-all">
                                </div>
                            </div>
                        </div>
                        <button id="btnSaveTool" class="w-full mt-6 py-4 bg-emerald-600 text-white rounded-2xl font-black uppercase text-xs shadow-lg border-none cursor-pointer hover:bg-emerald-700 transition-all">Salvar</button>
                    </div>
                </div>
            </div>

            <main id="section-database" class="main-content p-4 md:p-8">
                <div class="max-w-4xl mx-auto mt-10">
                    <h2 class="text-3xl font-black text-slate-900 tracking-tighter uppercase mb-10 text-center">Backup e Relat√≥rios</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div onclick="exportToolsToExcel()" class="bg-white p-10 rounded-[2.5rem] shadow-xl cursor-pointer border-2 border-transparent hover:border-teal-500 text-center">
                            <div class="w-16 h-16 bg-teal-50 text-teal-600 rounded-2xl flex items-center justify-center mx-auto mb-4"><i data-lucide="sheet"></i></div>
                            <h3 class="font-black uppercase text-slate-800">Exportar Excel</h3>
                        </div>
                        <div onclick="exportToPDF()" class="bg-white p-10 rounded-[2.5rem] shadow-xl cursor-pointer border-2 border-transparent hover:border-rose-500 text-center">
                            <div class="w-16 h-16 bg-rose-50 text-rose-600 rounded-2xl flex items-center justify-center mx-auto mb-4"><i data-lucide="file-down"></i></div>
                            <h3 class="font-black uppercase text-slate-800">Exportar PDF</h3>
                        </div>
                        <div onclick="exportData()" class="bg-white p-10 rounded-[2.5rem] shadow-xl cursor-pointer border-2 border-transparent hover:border-blue-500 text-center">
                            <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4"><i data-lucide="download-cloud"></i></div>
                            <h3 class="font-black uppercase text-slate-800">Exportar Dados</h3>
                        </div>
                        <div onclick="document.getElementById('importInput').click()" class="bg-white p-10 rounded-[2.5rem] shadow-xl cursor-pointer border-2 border-transparent hover:border-emerald-500 text-center">
                            <input type="file" id="importInput" class="hidden" accept=".json" onchange="importData(this)">
                            <div class="w-16 h-16 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center mx-auto mb-4"><i data-lucide="upload-cloud"></i></div>
                            <h3 class="font-black uppercase text-slate-800">Importar Dados</h3>
                        </div>
                    </div>
                </div>
            </main>

            <main id="section-tests" class="main-content p-4 md:p-8">
                <div class="max-w-[1400px] mx-auto">
                    <h2 class="text-3xl font-black text-slate-900 tracking-tighter uppercase mb-8">Testes de Funcionalidade</h2>
                    <div class="bg-white p-8 rounded-2xl shadow-lg border border-slate-100 space-y-4">
                        <p class="text-slate-600">Use os bot√µes abaixo para simular cen√°rios espec√≠ficos e testar as funcionalidades de alerta do sistema.</p>
                        <div class="flex gap-4 pt-4 flex-wrap">
                            <button onclick="simulateOverdue()" class="bg-yellow-500 text-white px-4 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg text-[10px] uppercase tracking-widest hover:bg-yellow-600 transition-all border-none cursor-pointer"><i data-lucide="clock" size="16"></i> Simular Atraso de 24h</button>
                            <button onclick="stopSimulation()" class="bg-slate-500 text-white px-4 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg text-[10px] uppercase tracking-widest hover:bg-slate-600 transition-all border-none cursor-pointer"><i data-lucide="x-circle" size="16"></i> Parar Simula√ß√£o</button>
                        </div>
                    </div>
                </div>
            </main>

            <div id="maintenanceModal" class="fixed inset-0 bg-slate-900/90 hidden z-[800] flex items-center justify-center p-4 backdrop-blur-md" onclick="closeModal('maintenanceModal')">
                <div class="bg-white rounded-[2.5rem] w-full max-w-2xl overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
                    <div class="bg-slate-50 p-6 border-b border-slate-100 flex justify-between items-center">
                        <h3 class="font-black uppercase tracking-tighter text-slate-900">Reportar Manuten√ß√£o</h3>
                        <button onclick="closeModal('maintenanceModal'); event.stopPropagation();" class="text-slate-400 hover:text-rose-500 bg-transparent border-none cursor-pointer"><i data-lucide="x"></i></button>
                    </div>
                    <div class="p-8">
                        <div id="step-selecionar-ferramenta">
                            <p class="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-widest">1. Qual ferramenta quebrou?</p>
                            <div class="relative mb-4">
                                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size="16"></i>
                                <input type="text" id="maintenanceToolSearchInput" onkeyup="handleSearchInput(this, () => openMaintenanceModal(true))" placeholder="BUSCAR POR NOME, C√ìDIGO OU MARCA..." class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl pl-12 pr-10 py-3 font-bold uppercase text-xs outline-none focus:border-blue-500 transition-all">
                                <button onclick="clearSearch('maintenanceToolSearchInput', () => openMaintenanceModal(true))" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-rose-500 hidden z-10"><i data-lucide="x-circle" size="16"></i></button>
                            </div>
                            <div id="toolGridMaintenance" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 max-h-[55vh] overflow-y-auto p-1 custom-scrollbar"></div>
                        </div>
                        <div id="step-detalhes-manutencao" class="hidden">
                            <p class="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-widest">2. Detalhes do problema</p>
                            <div id="selectedToolMaintenance" class="mb-4"></div>
                            <div id="maintenanceQtyContainer" class="hidden mb-4">
                                <div class="flex justify-between items-center ml-4 mb-1">
                                    <label for="maintenanceQtyInput" class="text-[10px] font-black uppercase text-slate-400">Quantidade para Manuten√ß√£o</label>
                                    <span id="maintenanceMaxQty" class="text-[10px] font-bold text-slate-400"></span>
                                </div>
                                <input type="number" id="maintenanceQtyInput" value="1" min="1" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 font-bold text-xs outline-none focus:border-red-500 transition-all">
                            </div>
                            <textarea id="maintenanceNoteInput" placeholder="Descreva o problema ou o motivo da manuten√ß√£o..." class="w-full h-24 border-2 border-slate-100 rounded-xl p-3 font-medium text-sm outline-none focus:border-red-500 transition-all"></textarea>
                            <div class="flex gap-3 mt-4">
                                <button onclick="resetMaintenance()" class="flex-1 py-4 bg-slate-100 text-slate-500 rounded-2xl font-black uppercase text-[10px] cursor-pointer border-none">Voltar</button>
                                <button id="btnFinalizeMaintenance" class="flex-1 py-4 bg-red-600 text-white rounded-2xl font-black uppercase text-[10px] shadow-lg border-none cursor-pointer hover:bg-red-700">Confirmar Manuten√ß√£o</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="materialModal" class="fixed inset-0 bg-slate-900/90 hidden z-[800] flex items-center justify-center p-4 backdrop-blur-md" onclick="closeModal('materialModal')">
                <div class="bg-white rounded-[2.5rem] w-full max-w-2xl overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
                    <div class="bg-slate-50 p-6 border-b border-slate-100 flex justify-between items-center gap-4">
                        <h3 id="materialModalTitle" class="font-black uppercase tracking-tighter text-slate-900">Sa√≠da de Ferramentas</h3>
                        <div class="flex-1 flex justify-end gap-2">
                            <input type="text" id="barcodeInput" class="absolute -left-[9999px]" onchange="handleBarcodeScan(this.value)">
                            <button onclick="focusBarcode()" class="bg-white border-2 border-slate-200 text-slate-500 px-3 py-2 rounded-lg font-bold flex items-center gap-2 text-[10px] uppercase hover:bg-slate-100 transition-all"><i data-lucide="barcode" size="14"></i> Bipar</button>
                            <button onclick="startQrScanner()" class="bg-white border-2 border-slate-200 text-slate-500 px-3 py-2 rounded-lg font-bold flex items-center gap-2 text-[10px] uppercase hover:bg-slate-100 transition-all"><i data-lucide="qr-code" size="14"></i> QR Code</button>
                        </div>
                        <button onclick="closeModal('materialModal'); event.stopPropagation();" class="text-slate-400 hover:text-rose-500 bg-transparent border-none cursor-pointer"><i data-lucide="x"></i></button>
                    </div>
                    <div class="p-8">
                        <div id="qrScannerContainer" class="hidden">
                            <div id="qr-reader" class="w-full rounded-xl overflow-hidden border-2 border-slate-200"></div>
                        </div>
                        <div id="step-material-tool" class="">
                            <p id="materialModalStep1" class="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-widest">1. Qual item ser√° retirado?</p>
                            <div class="relative mb-4">
                                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size="16"></i>
                                <input type="text" id="materialSearchInput" onkeyup="handleSearchInput(this, () => openMaterialModal(true))" placeholder="BUSCAR POR NOME, C√ìDIGO OU MARCA..." class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl pl-12 pr-10 py-3 font-bold uppercase text-xs outline-none focus:border-blue-500 transition-all">
                                <button onclick="clearSearch('materialSearchInput', () => openMaterialModal(true))" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-rose-500 hidden z-10"><i data-lucide="x-circle" size="16"></i></button>
                            </div>
                            <div id="toolGridMaterial" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 max-h-[55vh] overflow-y-auto p-1 custom-scrollbar"></div>
                        </div>
                        <div id="step-material-qty" class="hidden text-center py-6">
                            <p class="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-widest">2. Qual a quantidade?</p>
                            <div id="selectedToolMaterial" class="mb-6"></div>
                            <input type="number" id="materialQtyInput" placeholder="QTD" class="w-32 text-center border-2 border-slate-200 rounded-xl px-4 py-3 font-black text-lg outline-none focus:border-blue-500 transition-all">
                            <div class="flex gap-3 mt-6">
                                <button onclick="resetMaterial(0)" class="flex-1 py-4 bg-slate-100 text-slate-500 rounded-2xl font-black uppercase text-[10px] cursor-pointer border-none">Voltar</button>
                                <button onclick="processQtyStep()" class="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-black uppercase text-[10px] shadow-lg border-none cursor-pointer hover:bg-blue-700">Avan√ßar</button>
                            </div>
                        </div>
                        <div id="step-material-worker" class="hidden">
                            <p class="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-widest">3. Quem est√° retirando?</p>
                            <div id="teamGridMaterial" class="grid grid-cols-2 sm:grid-cols-3 gap-3 max-h-64 overflow-y-auto pr-2 custom-scrollbar"></div>
                                <button onclick="resetMaterial(1)" class="w-full mt-4 py-3 bg-slate-100 text-slate-500 rounded-xl font-black uppercase text-[10px] cursor-pointer border-none">Voltar</button>
                        </div>
                        <div id="step-material-confirm" class="hidden text-center py-6">
                            <div id="confirmationDetails" class="mb-6"></div>
                            <h4 class="text-xl font-black text-slate-900 uppercase mb-8">Confirmar Retirada?</h4>
                            <div class="flex gap-3">
                                    <button onclick="resetMaterial(2)" class="flex-1 py-4 bg-slate-100 text-slate-500 rounded-2xl font-black uppercase text-[10px] cursor-pointer border-none">Voltar</button>
                                    <button id="btnFinalizeMaterial" class="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black uppercase text-[10px] shadow-lg border-none cursor-pointer hover:bg-indigo-700">Confirmar Sa√≠da</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="manageMaintenanceModal" class="fixed inset-0 bg-slate-900/90 hidden z-[850] flex items-center justify-center p-4 backdrop-blur-md" onclick="closeModal('manageMaintenanceModal')">
                <div class="bg-white rounded-[2.5rem] w-full max-w-3xl overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
                    <div class="bg-slate-50 p-6 border-b border-slate-100 flex justify-between items-center">
                        <div>
                            <h3 class="font-black uppercase tracking-tighter text-slate-900">Gerenciar Manuten√ß√£o</h3>
                            <p id="maintenanceToolName" class="text-xs font-bold text-slate-500 uppercase"></p>
                        </div>
                        <button onclick="closeModal('manageMaintenanceModal');" class="text-slate-400 hover:text-rose-500 bg-transparent border-none cursor-pointer"><i data-lucide="x"></i></button>
                    </div>
                    <div class="p-8 max-h-[80vh] overflow-y-auto custom-scrollbar">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                            <!-- Coluna de Informa√ß√µes -->
                            <div class="md:col-span-1">
                                <div id="maintenanceToolInfo" class="text-center"></div>
                                <div id="maintenanceStatusTimeline" class="mt-8">
                                    <!-- Stepper Timeline -->
                                    <ol class="relative border-l-2 border-slate-100 ml-4">                  
                                        <li id="timeline-step-1" class="mb-5 ml-8">            
                                            <span class="absolute flex items-center justify-center w-8 h-8 bg-slate-100 rounded-full -left-4"><i data-lucide="flag" size="16" class="text-slate-500"></i></span>
                                            <h3 class="font-black text-slate-700">Reportado</h3>
                                        </li>
                                        <li id="timeline-step-2" class="mb-5 ml-8">
                                            <span class="absolute flex items-center justify-center w-8 h-8 bg-slate-100 rounded-full -left-4"><i data-lucide="clipboard-list" size="16" class="text-slate-500"></i></span>
                                            <h3 class="font-black text-slate-700">Or√ßamento</h3>
                                        </li>
                                        <li id="timeline-step-3" class="mb-5 ml-8">
                                            <span class="absolute flex items-center justify-center w-8 h-8 bg-slate-100 rounded-full -left-4"><i data-lucide="check-check" size="16" class="text-slate-500"></i></span>
                                            <h3 class="font-black text-slate-700">em conserto</h3>
                                        </li>
                                        <li id="timeline-step-4" class="ml-8">
                                            <span class="absolute flex items-center justify-center w-8 h-8 bg-slate-100 rounded-full -left-4"><i data-lucide="package-check" size="16" class="text-slate-500"></i></span>
                                            <h3 class="font-black text-slate-700">finalizado</h3>
                                        </li>
                                    </ol>
                                </div>
                            </div>

                            <!-- Coluna de A√ß√µes -->
                            <div id="maintenanceActions" class="md:col-span-2 space-y-6">
                                <!-- Passo 1: Registrar Or√ßamento -->
                                <div id="maintenance-step-quote" class="hidden">
                                    <h4 class="font-black uppercase text-slate-600 mb-3">Registrar Or√ßamento</h4>
                                    <div class="space-y-4">
                                        <div>
                                            <label for="quoteProviderInput" class="text-[10px] font-black uppercase text-slate-400 ml-4">Fornecedor</label>
                                            <input type="text" id="quoteProviderInput" placeholder="NOME DA EMPRESA/FORNECEDOR" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 font-bold uppercase text-xs outline-none focus:border-blue-500 h-[47px]">
                                        </div>
                                        <div>
                                            <label for="quoteCostInput" class="text-[10px] font-black uppercase text-slate-400 ml-4">Custo (R$)</label>
                                            <input type="number" id="quoteCostInput" placeholder="350,00" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 font-bold text-xs outline-none focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label for="quoteNoteInput" class="text-[10px] font-black uppercase text-slate-400 ml-4">Detalhes do Or√ßamento</label>
                                            <textarea id="quoteNoteInput" placeholder="Descreva os detalhes do or√ßamento..." class="w-full h-20 border-2 border-slate-100 rounded-xl p-3 font-medium text-sm outline-none focus:border-blue-500"></textarea>
                                        </div>
                                        <button id="btnSaveQuote" class="w-full mt-4 py-3 bg-blue-600 text-white rounded-xl font-black uppercase text-xs shadow-lg hover:bg-blue-700">Salvar Or√ßamento</button>
                                    </div>
                                </div>

                                <!-- Passo 2: Aprovar Or√ßamento -->
                                <div id="maintenance-step-approval" class="hidden">
                                    <h4 class="font-black uppercase text-slate-600 mb-3">Aprova√ß√£o do Or√ßamento</h4>
                                    <div id="quoteDetailsDisplay" class="bg-slate-50 p-4 rounded-xl space-y-3 mb-4"></div>
                                    <div class="flex gap-3">
                                        <button id="btnRejectRepair" class="flex-1 py-3 bg-rose-600 text-white rounded-xl font-bold uppercase text-[10px] shadow-lg hover:bg-rose-700">Recusar</button>
                                        <button id="btnApproveRepair" class="flex-1 py-3 bg-emerald-500 text-white rounded-xl font-bold uppercase text-[10px] shadow-lg hover:bg-emerald-600">Aprovar Conserto</button>
                                    </div>
                                </div>

                                <!-- Passo 3: Finalizar Conserto -->
                                <div id="maintenance-step-finish" class="hidden">
                                    <h4 class="font-black uppercase text-slate-600 mb-3">Finalizar Conserto</h4>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="text-[10px] font-black uppercase text-slate-400 ml-4">Nota Fiscal (Upload)</label>
                                            <div class="mt-1 border-2 border-dashed border-slate-200 rounded-2xl p-4 text-center h-40 flex items-center justify-center cursor-pointer hover:bg-slate-50 transition-colors group" id="drop-area" onclick="document.getElementById('invoiceFileInput').click()">
                                                <input type="file" id="invoiceFileInput" class="hidden" accept="image/*,application/pdf" onchange="handleFileSelect(this)">
                                                <div id="drop-area-text" class="text-slate-400">
                                                    <i data-lucide="upload-cloud" class="mx-auto" size="24"></i>
                                                    <p class="text-[8px] font-black uppercase">ARRASTE A NOTA FISCAL AQUI<br>OU CLIQUE PARA SELECIONAR</p>
                                                    <p class="text-[8px] text-slate-300 mt-2">PDF ou Imagem, m√°x 1MB</p>
                                                </div>
                                                <div id="file-name-display" class="hidden relative h-full text-slate-600 font-bold text-sm flex items-center justify-center"></div>
                                            </div>
                                        </div>
                                        <p class="text-sm text-slate-500">A manuten√ß√£o foi conclu√≠da e o item pode voltar ao estoque como "Dispon√≠vel"?</p>
                                    </div>
                                    <div class="flex gap-3 mt-4">
                                        <button id="btnBackToQuote" class="flex-1 py-3 bg-amber-500 text-white rounded-xl font-bold uppercase text-[10px] shadow-lg hover:bg-amber-600">N√£o, refazer or√ßamento</button>
                                        <button id="btnFinishRepair" class="flex-1 py-3 bg-emerald-500 text-white rounded-xl font-bold uppercase text-[10px] shadow-lg hover:bg-emerald-600">Sim, Finalizar</button>
                                    </div>
                                </div>
                                <!-- Passo 4: Concluir Manuten√ß√£o -->
                                <div id="maintenance-step-conclude" class="hidden">
                                    <h4 class="font-black uppercase text-slate-600 mb-3">Conclus√£o</h4>
                                    <div class="space-y-4">
                                        <div id="invoiceDisplay" class="hidden">
                                            <!-- Invoice link will be inserted here -->
                                        </div>
                                        <p class="text-sm text-slate-500">O processo de manuten√ß√£o foi finalizado. O item est√° pronto para retornar ao estoque?</p>
                                        <button id="btnConcludeMaintenance" class="w-full py-3 bg-blue-600 text-white rounded-xl font-black uppercase text-[10px] shadow-lg hover:bg-blue-700">Retornar ao Estoque</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="overdueModal" class="fixed inset-0 bg-slate-900/90 hidden z-[800] flex items-center justify-center p-4 backdrop-blur-md" onclick="closeModal('overdueModal')">
                <div class="bg-white rounded-[2.5rem] w-full max-w-2xl overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
                    <div class="bg-rose-50 p-6 border-b border-rose-100 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <i data-lucide="alert-triangle" class="text-rose-600"></i>
                            <h3 class="font-black uppercase tracking-tighter text-rose-900">Ferramentas com Devolu√ß√£o Atrasada</h3>
                        </div>
                        <button onclick="closeModal('overdueModal'); event.stopPropagation();" class="text-rose-400 hover:text-rose-600 bg-transparent border-none cursor-pointer"><i data-lucide="x"></i></button>
                    </div>
                    <div id="overdueList" class="p-8 max-h-[70vh] overflow-y-auto custom-scrollbar">
                        <!-- Overdue items will be rendered here -->
                    </div>
                </div>
            </div>

            <!--
                [PROMPT_SUGGESTION]Como posso adicionar um campo de "localiza√ß√£o" para cada ferramenta e exibi-lo nos relat√≥rios?[/PROMPT_SUGGESTION]
                [PROMPT_SUGGESTION]Poderia me ajudar a melhorar a responsividade da interface para telas de celular?[/PROMPT_SUGGESTION]
            -->

            <script>
                let tools = JSON.parse(localStorage.getItem('ldc_pro_db')) || [];
                let team = JSON.parse(localStorage.getItem('ldc_team_db')) || [{id: 1, name: 'ALMOXARIFADO', company: 'LDC'}];
                let history = JSON.parse(localStorage.getItem('ldc_history_db')) || [];
                
                let currentImageBase64 = "";
                let pendingStatus = "disponivel";
                let catalogFilter = 'all';
                let maintenanceFilter = 'all';
                let itemToDeleteId = null;
                let itemToReturnId = null;
                let itemToManageMaintenanceId = null;
                let historyItemToDeleteId = null;
                let maintenanceData = { toolId: null };
                let materialData = { toolId: null, workerId: null, qty: null };
                let zoomState = { level: 1, isPanning: false, startX: 0, startY: 0, translateX: 0, translateY: 0 };
                let qrScanner = null;
                let historyDatePicker = null;

                function openExternalLink(url, event) {
                    if(event) event.stopPropagation();
                    if (url && (url.startsWith('http://') || url.startsWith('https://'))) { window.open(url, '_blank'); }
                }
                const formatBRL = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);
                const capitalize = (s) => {
                    if (typeof s !== 'string' || !s) return '';
                    return s.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
                };

                function save() { 
                    localStorage.setItem('ldc_pro_db', JSON.stringify(tools)); 
                    localStorage.setItem('ldc_team_db', JSON.stringify(team));
                    localStorage.setItem('ldc_history_db', JSON.stringify(history));
                    render(); 
                    renderCatalog(); 
                    renderHistory(); 
                    renderMaintenance(); 
                    renderOverdueAlert();
                    renderTeam(); 
                }

                function handleSearchInput(input, renderCallback) {
                    const clearBtn = input.nextElementSibling;
                    if (clearBtn && clearBtn.tagName === 'BUTTON') {
                        clearBtn.classList.toggle('hidden', !input.value);
                    }
                    renderCallback();
                }

                function clearSearch(inputId, renderCallback) {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.value = '';
                        input.nextElementSibling.classList.add('hidden');
                        renderCallback();
                        input.focus();
                    }
                }

                function showSection(s) {
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.main-content').forEach(c => c.classList.remove('active-section'));
                    document.getElementById(`btn-${s}`).classList.add('active');
                    const section = document.getElementById(`section-${s}`);
                    if (section) {
                        if (qrScanner) stopQrScanner();
                        section.classList.add('active-section');
                    }
                    if (s === 'catalog') {
                        renderCatalog();
                        renderOverdueAlert();
                    }
                    if (s === 'logs') renderHistory();
                    if (s === 'maintenance') renderMaintenance();
                    if (s === 'team') renderTeam();
                    render();
                }

                function toggleSidebar() { 
                    document.getElementById('sidebar').classList.toggle('collapsed'); 
                    document.querySelectorAll('.sidebar-text').forEach(e => e.classList.toggle('hidden')); 
                }

                function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
                function closeModal(id) { 
                    const modal = document.getElementById(id);
                    if (modal) modal.classList.add('hidden');
                    if (id === 'materialModal' && qrScanner) stopQrScanner();
                    
                    if (id === 'zoomModal') {
                        const zoomModal = document.getElementById('zoomModal');
                        zoomModal.onmousemove = null;
                        zoomModal.onmouseup = null;
                        zoomModal.onmouseleave = null;
                        document.getElementById('zoomContainer').onwheel = null;
                    }
                }

                function addWorker() {
                    const nameInput = document.getElementById('workerNameInput');
                    const companyInput = document.getElementById('workerCompanyInput');
                    const name = nameInput.value.trim().toUpperCase();
                    const company = companyInput.value.trim().toUpperCase() || 'N/A';
                    if(!name) return;
                    team.push({ id: Date.now(), name, company });
                    nameInput.value = ""; companyInput.value = "";
                    save(); renderTeam();
                }

                function removeWorker(id) {
                    if (id === 1) { // Prote√ß√£o para n√£o remover o Almoxarifado
                        document.getElementById('alertModalTitle').innerText = "A√ß√£o Bloqueada";
                        document.getElementById('alertModalText').innerText = "N√£o √© poss√≠vel remover o Almoxarifado.";
                        openModal('alertModal');
                        return;
                    }
                    const worker = team.find(w => w.id === id);
                    if (worker) {
                        const toolsInPossession = tools.filter(t => t.user === worker.name).length;
                        if (toolsInPossession > 0) {
                            document.getElementById('alertModalTitle').innerText = "A√ß√£o Bloqueada";
                            document.getElementById('alertModalText').innerText = `N√£o √© poss√≠vel remover ${worker.name}. Este colaborador ainda possui ${toolsInPossession} ferramenta(s) em sua posse.`;
                            openModal('alertModal');
                            return;
                        }
                        const modal = document.getElementById('deleteModal');
                        modal.querySelector('h3').innerText = `Remover ${worker.name}?`;
                        modal.querySelector('p').innerText = 'Voc√™ tem certeza que deseja remover este colaborador da equipe?';
                        document.getElementById('confirmDeleteBtn').onclick = () => {
                        team = team.filter(w => w.id !== id);
                            closeModal('deleteModal');
                        save();
                        };
                        openModal('deleteModal');
                    }
                }

                function renderTeam() {
                    const grid = document.getElementById('teamGrid');
                    if (!grid) return;
                    const search = document.getElementById('teamSearchInput').value.toLowerCase();

                    const filteredTeam = team.filter(w => w.name.toLowerCase().includes(search) || w.company.toLowerCase().includes(search));
                    
                    if (filteredTeam.length === 0) {
                        grid.innerHTML = `<p class="text-center text-sm text-slate-400 col-span-full py-20">Nenhum colaborador encontrado.</p>`;
                        return;
                    }

                    grid.innerHTML = filteredTeam.map(w => {
                        const toolsInPossession = tools.filter(t => t.user === w.name).length;
                        const historyCount = history.filter(h => h.workerName === w.name).length;
                        return `
                        <div class="bg-white rounded-2xl p-5 shadow-md border border-slate-100 flex flex-col relative group">
                            <div class="absolute top-4 right-4">${w.id !== 1 ? `<button onclick="removeWorker(${w.id})" class="p-2 text-slate-400 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity" title="Excluir Colaborador"><i data-lucide="trash-2" size="16"></i></button>` : ''}</div>
                            <div class="flex items-center gap-4 mb-4"><div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-2xl font-black">${w.name.charAt(0)}</div><div class="flex-1"><h3 class="font-black text-slate-800 uppercase truncate" title="${w.name}">${w.name}</h3><p class="text-xs font-bold text-slate-400 uppercase truncate" title="${w.company}">${w.company}</p></div></div>
                            <div class="mt-auto pt-4 border-t border-slate-100 grid grid-cols-2 gap-4 text-center"><div><p class="text-[9px] font-black text-slate-400 uppercase">Em Posse</p><p class="text-2xl font-black ${toolsInPossession > 0 ? 'text-orange-500' : 'text-slate-600'}">${toolsInPossession}</p></div><div><p class="text-[9px] font-black text-slate-400 uppercase">Movimenta√ß√µes</p><p class="text-2xl font-black text-slate-600">${historyCount}</p></div></div>
                        </div>
                    `}).join('');
                    lucide.createIcons();
                }

                // Fun√ß√µes de Imagem e Modais de Ferramenta
                function previewImage(input) {
                    if (input.files && input.files[0]) {
                        const file = input.files[0];
                        const reader = new FileReader();
                        reader.onload = e => {
                            const img = new Image();
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                const maxWidth = 800; // Redimensiona para max 800px para economizar espa√ßo
                                const maxHeight = 800;
                                let width = img.width;
                                let height = img.height;

                                if (width > height) {
                                    if (width > maxWidth) {
                                        height *= maxWidth / width;
                                        width = maxWidth;
                                    }
                                } else {
                                    if (height > maxHeight) {
                                        width *= maxHeight / height;
                                        height = maxHeight;
                                    }
                                }
                                canvas.width = width;
                                canvas.height = height;
                                ctx.drawImage(img, 0, 0, width, height);
                                const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7); // Qualidade 70%
                                
                                currentImageBase64 = compressedBase64;
                                document.getElementById('imagePreview').src = compressedBase64;
                                document.getElementById('imagePreviewContainer').classList.remove('hidden');
                                document.getElementById('uploadPlaceholder').classList.add('hidden');
                            };
                            img.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                }

                function removeImage(event) {
                    event.stopPropagation();
                    currentImageBase64 = "";
                    document.getElementById('fileInput').value = null;
                    document.getElementById('imagePreview').src = "";
                    document.getElementById('imagePreviewContainer').classList.add('hidden');
                    document.getElementById('uploadPlaceholder').classList.remove('hidden');                    
                    lucide.createIcons();
                }

                function openAddModal(s) { 
                    pendingStatus = s; 
                    currentImageBase64 = "";
                    document.getElementById('fileInput').value = null;
                    document.getElementById('addModalTitle').innerText = "Novo Equipamento";
                    document.getElementById('toolCodeInput').value = "";
                    document.getElementById('toolNameInput').value = "";
                    document.getElementById('toolBrandInput').value = "";
                    document.getElementById('toolWeightInput').value = "";
                    document.getElementById('toolValueInput').value = "";
                    document.getElementById('toolQtyInput').value = "1";
                    document.getElementById('imagePreview').src = "";
                    document.getElementById('imagePreviewContainer').classList.add('hidden');
                    document.getElementById('uploadPlaceholder').classList.remove('hidden');
                    document.getElementById('btnSaveTool').onclick = addTool;
                    openModal('addModal'); 
                }

                function addTool() {
                    if (document.getElementById('addModal').classList.contains('hidden')) return;
                    const name = document.getElementById('toolNameInput').value;
                    if(!name) return;

                    const code = document.getElementById('toolCodeInput').value.trim();
                    if (code && tools.some(t => t.code === code)) {
                        document.getElementById('alertModalTitle').innerText = "C√≥digo Duplicado";
                        document.getElementById('alertModalText').innerText = `O c√≥digo/tag "${code}" j√° est√° cadastrado no sistema.`;
                        openModal('alertModal');
                        return;
                    }

                    const qtyInput = document.getElementById('toolQtyInput');

                    let newId = Date.now();
                    while(tools.some(t => t.id === newId)) {
                        newId++;
                    }

                    const tool = {
                        id: newId,
                        name: name,
                        code: code,
                        brand: document.getElementById('toolBrandInput').value.toUpperCase(),
                        weight: document.getElementById('toolWeightInput').value,
                        value: parseFloat(document.getElementById('toolValueInput').value) || 0,
                        img: currentImageBase64,
                        status: pendingStatus,
                        user: '-',
                        maintenanceNote: "",
                        maintenanceInfo: null
                    };
                    if (qtyInput.value && parseInt(qtyInput.value) > 0) {
                        tool.qty = parseInt(qtyInput.value);
                    }
                    tools.unshift(tool);
                    closeModal('addModal');
                    save();
                }

                function editTool(id) {
                    const t = tools.find(x => x.id === id);
                    if(!t) return;
                    document.getElementById('addModalTitle').innerText = "Editar Equipamento";
                    document.getElementById('toolCodeInput').value = t.code;
                    document.getElementById('toolNameInput').value = t.name;
                    document.getElementById('toolBrandInput').value = t.brand || "";
                    document.getElementById('toolWeightInput').value = t.weight || "";
                    document.getElementById('toolValueInput').value = t.value;
                    document.getElementById('toolQtyInput').value = t.qty || 0;
                    if(t.img) {
                        currentImageBase64 = t.img;
                        document.getElementById('imagePreview').src = t.img;
                        document.getElementById('imagePreviewContainer').classList.remove('hidden');
                        document.getElementById('uploadPlaceholder').classList.add('hidden');
                    } else {
                        removeImage({ stopPropagation: () => {} });
                    }
                    document.getElementById('btnSaveTool').onclick = () => {
                        t.name = document.getElementById('toolNameInput').value;
                        t.code = document.getElementById('toolCodeInput').value;
                        t.brand = document.getElementById('toolBrandInput').value.toUpperCase();
                        t.weight = document.getElementById('toolWeightInput').value;
                        t.value = parseFloat(document.getElementById('toolValueInput').value) || 0;
                        t.qty = parseInt(document.getElementById('toolQtyInput').value) || 0;
                        t.img = currentImageBase64;
                        const newQty = parseInt(document.getElementById('toolQtyInput').value) || 0;
                        if (newQty > 0) {
                            t.qty = newQty;
                        } else {
                            delete t.qty;
                        }
                        // A nota de manuten√ß√£o s√≥ √© alterada na tela de manuten√ß√£o
                        save(); closeModal('addModal');
                    };
                    openModal('addModal');
                    lucide.createIcons();
                }

                function requestDelete(id) {
                    const tool = tools.find(t => t.id === id);
                    if (tool && tool.status === 'em uso') {
                        document.getElementById('alertModalTitle').innerText = "A√ß√£o Bloqueada";
                        document.getElementById('alertModalText').innerText = "N√£o √© poss√≠vel excluir um item que est√° 'Em Uso'. Realize a devolu√ß√£o primeiro.";
                        openModal('alertModal');
                        return;
                    }
                    itemToDeleteId = id;
                    const modal = document.getElementById('deleteModal');
                    modal.querySelector('h3').innerText = 'Excluir Item?';
                    modal.querySelector('p').innerText = 'Voc√™ tem certeza que deseja remover este item? Esta a√ß√£o n√£o pode ser desfeita.';
                    document.getElementById('confirmDeleteBtn').onclick = () => {
                        tools = tools.filter(t => t.id !== itemToDeleteId);
                        closeModal('deleteModal');
                        save();
                    }; 
                    openModal('deleteModal');
                }
                
                function openZoom(src) { // --- FUN√á√ÉO DE ZOOM ATUALIZADA ---
                    if (!src) return;

                    const zoomModal = document.getElementById('zoomModal');
                    const zoomContainer = document.getElementById('zoomContainer');
                    const zoomImage = document.getElementById('zoomImage');
                    const zoomIframe = document.getElementById('zoomIframe');
                    let zoomTarget;

                    // Reset state
                    zoomState = { level: 1, isPanning: false, startX: 0, startY: 0, translateX: 0, translateY: 0 };
                    
                    if (src.startsWith('data:application/pdf')) {
                        zoomImage.classList.add('hidden');
                        zoomImage.src = "";
                        zoomIframe.classList.remove('hidden');
                        zoomIframe.src = src;
                        zoomTarget = zoomIframe;
                    } else {
                        zoomIframe.classList.add('hidden');
                        zoomIframe.src = "";
                        zoomImage.classList.remove('hidden');
                        zoomImage.src = src;
                        zoomTarget = zoomImage;
                    }
                    
                    zoomTarget.style.transform = 'scale(1) translate(0px, 0px)';
                    zoomTarget.style.cursor = 'default';
                    zoomTarget.classList.add('max-w-full', 'max-h-full');

                    const updateTransform = () => {
                        zoomTarget.style.transform = `scale(${zoomState.level}) translate(${zoomState.translateX}px, ${zoomState.translateY}px)`;
                    };

                    zoomContainer.onwheel = (e) => {
                        e.preventDefault();
                        const scaleAmount = 0.15;
                        if (e.deltaY < 0) { // Zoom in
                            zoomState.level = Math.min(8, zoomState.level + scaleAmount);
                        } else { // Zoom out
                            zoomState.level = Math.max(1, zoomState.level - scaleAmount);
                        }

                        if (zoomState.level > 1) {
                            zoomTarget.style.cursor = 'move';
                            zoomTarget.classList.remove('max-w-full', 'max-h-full');
                        } else {
                            zoomState.level = 1; // Snap to 1
                            zoomTarget.style.cursor = 'default';
                            zoomTarget.classList.add('max-w-full', 'max-h-full');
                            zoomState.translateX = 0;
                            zoomState.translateY = 0;
                        }
                        updateTransform();
                    };

                    zoomContainer.onmousedown = (e) => {
                        if (zoomState.level > 1) {
                            e.preventDefault();
                            zoomState.isPanning = true;
                            zoomState.startX = e.clientX - zoomState.translateX;
                            zoomState.startY = e.clientY - zoomState.translateY;
                            zoomTarget.style.cursor = 'grabbing';
                        }
                    };

                    zoomModal.onmousemove = (e) => {
                        if (zoomState.isPanning) {
                            e.preventDefault();
                            zoomState.translateX = e.clientX - zoomState.startX;
                            zoomState.translateY = e.clientY - zoomState.startY;
                            updateTransform();
                        }
                    };

                    zoomModal.onmouseup = () => {
                        if (zoomState.isPanning) {
                            zoomState.isPanning = false;
                            zoomTarget.style.cursor = 'move';
                        }
                    };
                    
                    zoomModal.onmouseleave = zoomModal.onmouseup;

                    openModal('zoomModal');
                }

                function setCatalogFilter(f) {
                    catalogFilter = f;
                document.querySelectorAll('#section-catalog .filter-pill').forEach(b => b.classList.remove('active'));
                    document.getElementById('filter-' + (f === 'em uso' ? 'uso' : f)).classList.add('active');
                    renderCatalog();
                }

                function createCatalogCardHTML(t) {
                    const statusInfo = {
                        disponivel: { class: 'bg-emerald-50 text-emerald-600', text: t.status },
                        'em uso': { class: 'bg-orange-100 text-orange-600', text: `Com ${t.user || 'N/A'}` },
                        quebrado: { class: 'bg-red-50 text-red-600', text: t.maintenanceInfo ? t.maintenanceInfo.status : 'Manuten√ß√£o' }
                    };
                    if (t.status === 'quebrado' && t.maintenanceInfo && t.maintenanceInfo.status === 'Em Conserto') {
                        statusInfo.quebrado.class = 'bg-indigo-100 text-indigo-600';
                    }
                    const currentStatus = statusInfo[t.status] || { class: 'bg-slate-100 text-slate-600', text: t.status };

                    let qtyDisplay = t.qty || 0;
                    if (qtyDisplay >= 1000) {
                        qtyDisplay = (qtyDisplay / 1000).toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + ' TON';
                    }

                    return `
                        <div id="tool-card-${t.id}" class="bg-white rounded-[2rem] p-4 shadow-lg border border-slate-100 flex flex-col group relative transition-all hover:shadow-2xl hover:-translate-y-1">
                            <div class="absolute top-6 right-6 flex gap-2 z-10 opacity-0 group-hover:opacity-100 transition-opacity">
                                ${t.status === 'em uso' ? `<button onclick="requestReturn(${t.id}); event.stopPropagation();" class="bg-orange-500 text-white p-2 rounded-lg shadow-sm border border-orange-500 cursor-pointer hover:bg-orange-600" title="Devolver"><i data-lucide="rotate-ccw" size="14"></i></button>` : ''}
                                <button onclick="editTool(${t.id}); event.stopPropagation();" class="bg-white/90 p-2 rounded-lg text-slate-600 hover:text-blue-600 shadow-sm border border-slate-200 cursor-pointer backdrop-blur" title="Editar"><i data-lucide="pencil" size="14"></i></button>
                                <button onclick="requestDelete(${t.id}); event.stopPropagation();" class="bg-white/90 p-2 rounded-lg text-rose-500 hover:bg-rose-50 shadow-sm border border-slate-200 cursor-pointer backdrop-blur" title="Excluir"><i data-lucide="trash-2" size="14"></i></button>
                            </div>
                            <div onclick="openZoom('${t.img || ''}')" class="img-container relative w-full aspect-square bg-slate-50 rounded-2xl mb-4 flex items-center justify-center overflow-hidden border border-slate-50">
                                ${t.img ? `<img src="${t.img}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">` : `<i data-lucide="wrench" class="text-slate-200" size="40"></i>`}
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-all flex items-center justify-center">
                                    <i data-lucide="expand" class="text-white opacity-0 group-hover:opacity-100 transition-all transform scale-50 group-hover:scale-100" size="32"></i>
                                </div>
                            </div>
                            <div class="px-2">
                                <span class="text-[9px] font-black uppercase px-2 py-1 rounded-lg mb-2 inline-block ${currentStatus.class}">${currentStatus.text}</span>
                                <h3 class="font-black text-slate-900 uppercase text-xs truncate" title="${t.name}">${t.name}</h3>
                                ${t.status === 'quebrado' && t.maintenanceNote ? 
                                    `<p class="text-[9px] font-bold text-rose-500 mt-1 truncate" title="${t.maintenanceNote}"><i data-lucide="wrench" size="10" class="inline-block -mt-px"></i> ${t.maintenanceNote}</p>` :
                                    `<p class="text-[9px] font-bold text-slate-400 mt-1 uppercase tracking-tighter">
                                        ${t.code || ''} 
                                        ${t.brand ? '<span class="text-indigo-500 font-black"> | ' + t.brand + '</span>' : ''}
                                        ${t.weight ? '<span class="text-slate-500 font-black"> | ' + t.weight + ' KG <i data-lucide="weight" width="10" height="15" class="inline-block -mt-px"></i></span>' : ''}
                                    </p>`}
                                
                                <div class="mt-4 pt-4 border-t border-slate-50 flex items-center justify-between">
                                    <div class="flex flex-col">
                                        <span class="text-[8px] font-black text-slate-400 uppercase">Valor Estimado</span>
                                        <span class="text-emerald-600 font-black text-sm">${formatBRL(t.value)}</span>
                                    </div>
                                    <div class="flex flex-col items-end">
                                        <span class="text-[8px] font-black text-slate-400 uppercase">Estoque</span>
                                        <div class="flex items-center gap-1 text-slate-900 font-black">
                                            <i data-lucide="box" size="10"></i>
                                            <span>${qtyDisplay}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // --- RENDERIZA√á√ÉO DO CAT√ÅLOGO ATUALIZADA ---
                function renderCatalog() {
                    const grid = document.getElementById('catalogGrid');
                    if (!grid) return;
                    const searchTerm = document.getElementById('catalogSearchInput').value.toLowerCase();

                    let filteredTools = tools.filter(t => {
                        // Hide items with qty 0 (stock placeholders) completely from catalog
                        if (t.hasOwnProperty('qty') && t.qty === 0) {
                            return false;
                        }

                        const matchesFilter = catalogFilter === 'all' || t.status === catalogFilter;
                        const matchesSearch = !searchTerm || 
                                            t.name.toLowerCase().includes(searchTerm) ||
                                            (t.code && t.code.toLowerCase().includes(searchTerm)) ||
                                            (t.brand && t.brand.toLowerCase().includes(searchTerm));
                        return matchesFilter && matchesSearch;
                    });

                    const totalValue = filteredTools.reduce((sum, tool) => sum + ((tool.value || 0) * (tool.qty || 1)), 0);
                    const totalQty = filteredTools.reduce((sum, tool) => sum + (tool.qty || 1), 0);

                    document.getElementById('catalogTotalValue').innerText = formatBRL(totalValue);
                    document.getElementById('catalogTotalQty').innerText = totalQty;

                    if(filteredTools.length === 0) {
                        grid.innerHTML = `<p class="text-center text-sm text-slate-400 col-span-full py-10">Nenhum item encontrado para sua busca.</p>`;
                        return;
                    }
                    grid.innerHTML = filteredTools.map(t => createCatalogCardHTML(t)).join('');
                    lucide.createIcons();
                }

                function render() {
                    const toolListEl = document.getElementById('toolList');
                    if (!toolListEl) return;
                    
                    // Filter out stock placeholders (qty 0) from display and counts
                    const visibleTools = tools.filter(t => !t.hasOwnProperty('qty') || t.qty > 0 || t.status !== 'disponivel');

                    document.getElementById('totalCount').innerText = visibleTools.length;
                    document.getElementById('availCount').innerText = visibleTools.filter(t => t.status === 'disponivel').length;
                    document.getElementById('loanCount').innerText = visibleTools.filter(t => t.status === 'em uso').length;
                    document.getElementById('brokenCount').innerText = visibleTools.filter(t => t.status === 'quebrado').length;
                    document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('pt-BR', { day: 'numeric', month: 'long', year: 'numeric' });

                    document.getElementById('toolList').innerHTML = visibleTools.map(t => `
                        <tr class="group hover:bg-slate-50">
                            <td class="px-8 py-5">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-lg bg-slate-100 overflow-hidden border">
                                        ${t.img ? `<img src="${t.img}" class="w-full h-full object-cover">` : `<div class="flex items-center justify-center h-full text-slate-300 text-[8px]">FOTO</div>`}
                                    </div>
                                    <div><p class="font-black text-slate-800 uppercase text-xs">${t.name}</p><p class="text-[9px] font-bold text-slate-400">${t.code || ''} <span class="text-indigo-500 font-black">${t.brand ? ' | ' + t.brand + '</span>' : ''}</span></p></div>
                                </div>
                            </td>
                            <td class="px-8 py-5">
                                <div class="flex flex-col">
                                    <span class="text-[9px] font-black uppercase px-2 py-1 rounded-lg w-fit ${
                                        t.status === 'disponivel' ? 'bg-emerald-50 text-emerald-600' :
                                        t.status === 'em uso' ? 'bg-orange-100 text-orange-600' :
                                        t.status === 'quebrado' && t.maintenanceInfo && t.maintenanceInfo.status === 'Em Conserto' ? 'bg-indigo-100 text-indigo-600' :
                                        'bg-red-50 text-red-600'
                                    }">${t.status === 'quebrado' ? (t.maintenanceInfo ? t.maintenanceInfo.status : 'Manuten√ß√£o') : (t.status === 'em uso' ? `Com ${t.user || 'N/A'}` : (t.hasOwnProperty('qty') && t.qty === 0 ? 'ESGOTADO' : t.status))}
                                    </span>
                                    ${t.status === 'quebrado' && t.maintenanceNote ? `<span class="text-[9px] text-rose-500 font-bold mt-1 block truncate" title="${t.maintenanceNote}">${t.maintenanceNote}</span>` : ''}
                                </div>
                            </td>
                            <td class="px-8 py-5 text-right">
                                <div class="flex justify-end gap-2">
                                    ${t.status === 'em uso' ? 
                                        `<button onclick="requestReturn(${t.id})" class="p-2 text-orange-500 hover:bg-orange-50 rounded-lg transition-colors" title="Devolver"><i data-lucide="rotate-ccw" size="16"></i></button>` :
                                        '<div class="w-10 p-2"></div>'
                                    }
                                    <button onclick="editTool(${t.id})" class="p-2 text-slate-400 hover:text-blue-600 bg-transparent border-none cursor-pointer"><i data-lucide="pencil" size="16"></i></button>
                                    <button onclick="requestDelete(${t.id})" class="p-2 text-slate-400 hover:text-rose-600 bg-transparent border-none cursor-pointer"><i data-lucide="trash-2" size="16"></i></button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                    lucide.createIcons();
                }

                // --- FUN√á√ïES DE HIST√ìRICO ---
                function formatISODate(iso) {
                    if (!iso) return '-';
                    return new Date(iso).toLocaleString('pt-BR', {dateStyle: 'short', timeStyle: 'short'});
                }

                function formatDuration(start, end) {
                    if (!end || !start) return '-';
                    let diff = new Date(end) - new Date(start);
                    const days = Math.floor(diff / 86400000);
                    diff -= days * 86400000;
                    const hours = Math.floor(diff / 3600000);
                    diff -= hours * 3600000;
                    const mins = Math.floor(diff / 60000);

                    let result = '';
                    if (days > 0) result += `${days}d`;
                    if (hours > 0) result += `${hours}h`;
                    if (mins > 0 || (days === 0 && hours === 0)) result += `${mins}min`;
                    return result || '0min';
                }

                function requestDeleteHistory(id) {
                    historyItemToDeleteId = id;
                    const modal = document.getElementById('deleteModal');
                    modal.querySelector('h3').innerText = 'Excluir Registro?';
                    modal.querySelector('p').innerText = 'Deseja remover este registro do hist√≥rico? Esta a√ß√£o n√£o pode ser desfeita.';
                    document.getElementById('confirmDeleteBtn').onclick = deleteHistoryEntry;
                    openModal('deleteModal');
                }

                function deleteHistoryEntry() {
                    history = history.filter(h => h.historyId !== historyItemToDeleteId);
                    save();
                    closeModal('deleteModal');
                }

                function clearHistoryDateFilter() {
                    if (historyDatePicker) {
                        historyDatePicker.clear();
                    }
                }

                function renderHistory() {
                    const grid = document.getElementById('historyGrid');
                    if (!grid) return;
                    const searchTerm = document.getElementById('historySearchInput').value.toLowerCase();
                    const dateInput = document.getElementById('historyDateInput');
                    const dateStr = dateInput.value;

                    let dateFilter = null;
                    if (dateStr) {
                        const parts = dateStr.split('/');
                        if (parts.length === 3) {
                            dateFilter = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                        }
                    }

                    const filteredHistory = history.filter(h => {
                        const matchesSearch = !searchTerm || (h.toolName && h.toolName.toLowerCase().includes(searchTerm)) || (h.workerName && h.workerName.toLowerCase().includes(searchTerm));
                        const matchesDate = !dateFilter || (h.checkoutDate && h.checkoutDate.startsWith(dateFilter)) || (h.returnDate && h.returnDate.startsWith(dateFilter));
                        return matchesSearch && matchesDate;
                    });

                    if (filteredHistory.length === 0) {
                        grid.innerHTML = `<p class="text-center text-sm text-slate-400 col-span-full py-20">Nenhum registro de hist√≥rico encontrado.</p>`;
                        return;
                    }

                    grid.innerHTML = filteredHistory.map(h => {
                        let typeLabel, typeColor;
                        if (h.returnDate) {
                            if (h.type === 'manutencao') {
                                typeLabel = 'Finalizada';
                                typeColor = 'bg-emerald-100 text-emerald-700';
                            } else { // emprestimo
                                if (h.condition === 'quebrado') {
                                    typeLabel = 'Devolvido Quebrado';
                                    typeColor = 'bg-rose-100 text-rose-700';
                                } else {
                                    typeLabel = 'Devolvido';
                                    typeColor = 'bg-emerald-100 text-emerald-700';
                                }
                            }
                        } else {
                            typeLabel = h.type === 'manutencao' ? 'Em Manuten√ß√£o' : 'Em Uso';
                            typeColor = h.type === 'manutencao' ? 'bg-red-100 text-red-700' : 'bg-orange-100 text-orange-700';
                        }
                        const tool = tools.find(t => t.id === h.toolId) || {};
                        const toolImg = h.toolImg || tool.img;

                        return `
                        <div class="bg-white rounded-2xl p-5 shadow-md border border-slate-100 flex flex-col gap-4 relative group">
                            <div class="absolute top-4 right-4">
                                <button onclick="requestDeleteHistory(${h.historyId})" class="p-2 text-slate-400 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity" title="Excluir Registro"><i data-lucide="trash-2" size="16"></i></button>
                            </div>
                            <div class="flex items-start gap-4">
                                <div class="w-16 h-16 bg-slate-50 rounded-xl flex items-center justify-center overflow-hidden border border-slate-100">
                                    ${toolImg ? `<img src="${toolImg}" class="w-full h-full object-cover">` : `<i data-lucide="wrench" class="text-slate-300" size="24"></i>`}
                                </div>
                                <div class="flex-1">
                                    <span class="text-[10px] font-black uppercase px-2 py-1 rounded-md ${typeColor}">${typeLabel}</span>
                                    <h3 class="font-black text-slate-800 uppercase mt-1">${h.toolName}</h3>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase">${tool.code || ''}</p>
                                </div>
                            </div>
                            <div class="text-xs space-y-2">
                                <div class="flex justify-between">
                                    <span class="font-bold text-slate-400">Respons√°vel:</span>
                                    <span class="font-black text-slate-700 uppercase">${h.workerName}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-bold text-slate-400">Quantidade:</span>
                                    <span class="font-black text-slate-700">${h.qty}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-bold text-slate-400">Data da Retirada:</span>
                                    <span class="font-semibold text-slate-600">${formatISODate(h.checkoutDate)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-bold text-slate-400">Data da Devolu√ß√£o:</span>
                                    <span class="font-semibold text-slate-600">${formatISODate(h.returnDate)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-bold text-slate-400">Tempo de Posse:</span>
                                    <span class="font-black text-blue-600">${formatDuration(h.checkoutDate, h.returnDate)}</span>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('');
                    lucide.createIcons();
                }

                // --- FUN√á√ÉO DE SIMULA√á√ÉO DE ATRASO ---
                function simulateOverdue() {
                    // Encontra a primeira ferramenta de item √∫nico que esteja dispon√≠vel
                    const availableTool = tools.find(t => t.status === 'disponivel' && (!t.hasOwnProperty('qty') || t.qty === 0));
                    
                    if (!availableTool) {
                        document.getElementById('alertModalTitle').innerText = "Simula√ß√£o Falhou";
                        document.getElementById('alertModalText').innerText = "Nenhuma ferramenta de item √∫nico (n√£o consum√≠vel) est√° dispon√≠vel para simular o atraso.";
                        openModal('alertModal');
                        return;
                    }

                    // Altera o status da ferramenta para "em uso" por um usu√°rio de teste
                    availableTool.status = 'em uso';
                    availableTool.user = 'SIMULA√á√ÉO';

                    // Cria um registro de hist√≥rico com data de retirada de 25 horas atr√°s
                    const now = new Date();
                    const twentyFiveHoursAgo = new Date(now.getTime() - (25 * 60 * 60 * 1000));

                    const historyEntry = {
                        historyId: Date.now(),
                        toolId: availableTool.id,
                        toolName: availableTool.name,
                        toolImg: availableTool.img,
                        workerName: 'SIMULA√á√ÉO',
                        qty: 1,
                        checkoutDate: twentyFiveHoursAgo.toISOString(),
                        returnDate: null,
                        type: 'emprestimo'
                    };
                    history.unshift(historyEntry);

                    // Salva os dados e atualiza a interface, mostrando o alerta
                    save();
                    openOverdueModal();
                }

                // --- FUN√á√ÉO DE PARAR SIMULA√á√ÉO DE ATRASO ---
                function stopSimulation() {
                    const simulatedTool = tools.find(t => t.status === 'em uso' && t.user === 'SIMULA√á√ÉO');
                    
                    if (!simulatedTool) {
                        document.getElementById('alertModalTitle').innerText = "Simula√ß√£o N√£o Ativa";
                        document.getElementById('alertModalText').innerText = "Nenhuma simula√ß√£o de atraso est√° ativa no momento para ser interrompida.";
                        openModal('alertModal');
                        return;
                    }

                    simulatedTool.status = 'disponivel';
                    simulatedTool.user = '-';

                    const historyIndex = history.findIndex(h => h.toolId === simulatedTool.id && h.workerName === 'SIMULA√á√ÉO' && h.returnDate === null);
                    if (historyIndex > -1) {
                        history.splice(historyIndex, 1);
                    }

                    save();
                    document.getElementById('alertModalTitle').innerText = "Simula√ß√£o Finalizada";
                    document.getElementById('alertModalText').innerText = "A simula√ß√£o de atraso foi revertida com sucesso.";
                    openModal('alertModal');
                }

                window.onload = () => { 
                    render(); 
                    renderOverdueAlert();
                    lucide.createIcons(); 

                    historyDatePicker = flatpickr("#historyDateInput", {
                        locale: "pt",
                        dateFormat: "d/m/Y",
                        onChange: function(selectedDates, dateStr, instance) {
                            document.getElementById('clearDateBtn').classList.toggle('hidden', !dateStr);
                            renderHistory();
                        }
                    });

                    setInterval(renderOverdueAlert, 30000); // Verifica atrasos a cada 30 segundos

                    // Configura√ß√£o de tecla Enter para salvar/confirmar
                    const setupEnter = (inputId, action) => {
                        const el = document.getElementById(inputId);
                        if (el) {
                            el.addEventListener('keydown', (e) => {
                                if (e.key === 'Enter') {
                                    e.preventDefault();
                                    action();
                                }
                            });
                        }
                    };

                    // Equipe
                    setupEnter('workerNameInput', addWorker);
                    setupEnter('workerCompanyInput', addWorker);

                    // Ferramentas (Adicionar/Editar)
                    const saveToolAction = () => document.getElementById('btnSaveTool').click();
                    setupEnter('toolCodeInput', saveToolAction);
                    setupEnter('toolNameInput', saveToolAction);
                    setupEnter('toolBrandInput', saveToolAction);
                    setupEnter('toolWeightInput', saveToolAction);
                    setupEnter('toolValueInput', saveToolAction);
                    setupEnter('toolQtyInput', saveToolAction);

                    // Sa√≠da de Materiais (Quantidade)
                    setupEnter('materialQtyInput', processQtyStep);

                    // Manuten√ß√£o (Or√ßamento)
                    setupEnter('quoteProviderInput', () => saveQuote(itemToManageMaintenanceId));
                    setupEnter('quoteCostInput', () => saveQuote(itemToManageMaintenanceId));
                };

                // --- FUN√á√ïES DE BACKUP ---
                function exportData() {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ tools, team, history }));
                const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", "backup_ferramentaria_" + new Date().toISOString().split('T')[0] + ".json");
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                }

                function importData(input) {
                    const file = input.files[0];
                    if(!file) return;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.tools) tools = data.tools;
                            if (data.team) team = data.team;
                            if (data.history) history = data.history;
                            save();
                            document.getElementById('alertModalTitle').innerText = "Sucesso";
                            document.getElementById('alertModalText').innerText = "Dados importados com sucesso!";
                            openModal('alertModal');
                        } catch(e) { 
                            document.getElementById('alertModalTitle').innerText = "Erro";
                            document.getElementById('alertModalText').innerText = "Erro ao importar arquivo. Verifique se o arquivo √© um backup v√°lido.";
                            openModal('alertModal');
                        } finally {
                            // Reseta o t√≠tulo do modal de alerta para o padr√£o depois de usar
                            setTimeout(() => {
                                document.getElementById('alertModalTitle').innerText = "Aten√ß√£o";
                            }, 500);
                        }
                    };
                    reader.readAsText(file);
                }

                // --- FUN√á√ïES DE CHECKOUT / DEVOLU√á√ÉO ---
                function requestReturn(id) {
                    itemToReturnId = id; // This is used by handleReturnCondition
                    const tool = tools.find(t => t.id === id);
                    if (!tool) return;
                    
                    document.getElementById('returnModalTitle').innerText = `Devolver: ${tool.name}`;
                    document.getElementById('returnModalText').innerText = `Qual o estado de devolu√ß√£o do item por ${tool.user}?`;
                    document.getElementById('btnReturnBroken').onclick = () => handleReturnCondition(id, 'quebrado');
                    document.getElementById('btnReturnWorking').onclick = () => handleReturnCondition(id, 'funcionando');
                    openModal('returnModal');
                }
                function handleReturnCondition(id, condition) {
                    const tool = tools.find(t => t.id === id);
                    if (!tool) return;

                    const historyEntry = history.find(h => h.toolId === tool.id && h.returnDate === null && h.type === 'emprestimo');

                    if (condition === 'funcionando') {
                        if (historyEntry) {
                            historyEntry.returnDate = new Date().toISOString();
                            historyEntry.condition = 'boa';
                        }

                        if (tool.original_id) { // It's a consumable part
                            const originalTool = tools.find(ot => ot.id === tool.original_id);
                            if (originalTool) {
                                originalTool.qty = (originalTool.qty || 0) + (tool.qty || 1);
                            }
                            tools = tools.filter(t => t.id !== tool.id);
                        } else { // It's a unique tool
                            tool.status = 'disponivel';
                            tool.user = '-';
                        }
                        closeModal('returnModal');
                        document.getElementById(`tool-card-${id}`)?.remove();
                        save();
                    } else if (condition === 'quebrado') {
                        if (historyEntry) {
                            historyEntry.returnDate = new Date().toISOString();
                            historyEntry.condition = 'quebrado';
                        }
            
            if (tool.original_id) { // √â um item consum√≠vel que quebrou/se perdeu
                tools = tools.filter(t => t.id !== tool.id); // Remove o item "emprestado" da lista principal
            } else {
                // Para ferramentas normais, inicia o fluxo de manuten√ß√£o
                maintenanceData.toolId = itemToReturnId;
                document.getElementById('step-selecionar-ferramenta').classList.add('hidden');
                document.getElementById('step-detalhes-manutencao').classList.remove('hidden');
                document.getElementById('selectedToolMaintenance').innerHTML = `<div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl mb-3">
                    <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center overflow-hidden">${tool.img ? `<img src="${tool.img}" class="w-full h-full object-cover">` : `<i data-lucide="image" class="text-slate-300"></i>`}</div>
                    <div><p class="font-bold text-xs uppercase text-slate-800">${tool.name}</p><p class="text-[9px] font-black text-slate-400 uppercase">${tool.code}</p></div>
                </div>`;
                document.getElementById('maintenanceNoteInput').value = '';
                document.getElementById('btnFinalizeMaintenance').onclick = finalizeMaintenanceReport;
                openModal('maintenanceModal');
            }
            closeModal('returnModal');
                        document.getElementById(`tool-card-${id}`)?.remove();
                        save();
                    }
                }
                function finishRepair(id) {
                    const tool = tools.find(t => t.id === id);
                    if (!tool || !tool.maintenanceInfo) return;

                    isSaving = true; // Prevent cloud sync conflicts

                    const fileInput = document.getElementById('invoiceFileInput');
                    const file = fileInput.files[0];

                    if (!file) {
                        document.getElementById('alertModalTitle').innerText = "Aten√ß√£o";
                        document.getElementById('alertModalText').innerText = "Por favor, anexe o arquivo da nota fiscal para finalizar o conserto.";
                        openModal('alertModal');
                        isSaving = false;
                        return;
                    }

                    const processAndSave = (invoiceData) => {
                        const currentTool = tools.find(t => t.id === id) || tool;
                        currentTool.maintenanceInfo.invoiceFile = invoiceData;
                        currentTool.maintenanceInfo.status = 'Finalizado';
                        closeModal('manageMaintenanceModal');
                        setTimeout(save, 50);
                    };

                    // Image compression
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = new Image();
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                const maxWidth = 800;
                                const maxHeight = 800;
                                let width = img.width;
                                let height = img.height;

                                if (width > height) {
                                    if (width > maxWidth) {
                                        height *= maxWidth / width;
                                        width = maxWidth;
                                    }
                                } else {
                                    if (height > maxHeight) {
                                        width *= maxHeight / height;
                                        height = maxHeight;
                                    }
                                }
                                canvas.width = width;
                                canvas.height = height;
                                ctx.fillStyle = "#FFFFFF";
                                ctx.fillRect(0, 0, width, height);
                                ctx.drawImage(img, 0, 0, width, height);
                                const compressedBase64 = canvas.toDataURL('image/jpeg', 0.5);
                                processAndSave(compressedBase64);
                            };
                            img.src = e.target.result;
                        };
                        reader.onerror = () => { isSaving = false; };
                        reader.readAsDataURL(file);
                        return;
                    }

                    // PDF and other files size limit (1MB)
                    if (file.size > 1 * 1024 * 1024) {
                        document.getElementById('alertModalTitle').innerText = "Arquivo Muito Grande";
                        document.getElementById('alertModalText').innerText = "Para arquivos PDF, o limite √© 1MB. Para imagens, o sistema tentar√° comprimir automaticamente.";
                        openModal('alertModal');
                        isSaving = false;
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => processAndSave(e.target.result);
                    reader.onerror = () => { isSaving = false; };
                    reader.readAsDataURL(file);
                }

                function concludeAndMoveToStock(id) {
                    closeModal('manageMaintenanceModal');
                    const t = tools.find(x => x.id === id);
                    if (t) {
                        // Atualiza hist√≥rico de manuten√ß√£o se existir
                        const historyEntry = history.find(h => h.toolId === t.id && h.returnDate === null && h.type === 'manutencao');
                        if (historyEntry) {
                            historyEntry.returnDate = new Date().toISOString();
                        }
                        t.status = 'disponivel';
                        t.user = '-';
                        t.maintenanceNote = "";
                        t.maintenanceInfo = null;
                        document.getElementById(`tool-card-${id}`)?.remove();
                        save();
                    }
                }

                // --- FUN√á√ïES DE MANUTEN√á√ÉO ---
                function openMaintenanceModal(isSearchUpdate = false) {
                    if (!isSearchUpdate) {
                        maintenanceData = { toolId: null };
                        const searchInput = document.getElementById('maintenanceToolSearchInput');
                        if (searchInput) {
                            searchInput.value = "";
                            searchInput.nextElementSibling.classList.add('hidden');
                        }
                        document.getElementById('step-selecionar-ferramenta').classList.remove('hidden');
                        document.getElementById('step-detalhes-manutencao').classList.add('hidden');
                        openModal('maintenanceModal');
                    }
                    
                    const list = document.getElementById('toolGridMaintenance');
                    const searchInput = document.getElementById('maintenanceToolSearchInput');
                    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

                    const availableTools = tools.filter(t => {
                        const notBroken = t.status !== 'quebrado';                        const hasStock = !t.hasOwnProperty('qty') || t.qty > 0;
                        const matchesSearch = !searchTerm || 
                                            t.name.toLowerCase().includes(searchTerm) ||
                                            (t.code && t.code.toLowerCase().includes(searchTerm)) ||
                                            (t.brand && t.brand.toLowerCase().includes(searchTerm));
                        return notBroken && matchesSearch;
                    });

                    list.innerHTML = availableTools.map(t => {
                        let stockInfo;
                        if (t.status === 'disponivel') {
                            stockInfo = `
                                <span class="text-[8px] font-black text-slate-400 uppercase">Estoque</span>
                                <div class="flex items-center justify-center gap-1 text-slate-900 font-black text-lg"><i data-lucide="box" size="12"></i><span>${t.qty || 0}</span></div>
                            `;
                        } else {
                            stockInfo = `<span class="text-[8px] font-black uppercase text-slate-400 uppercase">Em Uso Por</span><p class="text-orange-600 font-black text-lg">${t.user}</p>`;
                        }
                        return `
                        <div onclick="selectToolForMaintenance(${t.id})" class="bg-white rounded-2xl p-3 shadow-lg border border-slate-100 cursor-pointer hover:border-red-500 hover:shadow-xl transition-all flex flex-col text-center group">
                            <div class="relative w-full aspect-square bg-white rounded-xl mb-3 flex items-center justify-center overflow-hidden border border-slate-100">
                                ${t.img ? `<img src="${t.img}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110">` : `<i data-lucide="wrench" class="text-slate-200" size="40"></i>`}
                            </div>
                            <div class="flex-1 flex flex-col justify-between"><h3 class="font-black text-slate-700 uppercase text-[10px] leading-tight h-8 flex items-center justify-center px-1" title="${t.name}">${t.name}</h3><div class="mt-2 pt-2 border-t border-slate-100">${stockInfo}</div></div>
                        </div>`;
                    }).join('');
                    if(availableTools.length === 0) {
                        list.innerHTML = `<p class="text-center text-xs text-slate-400 col-span-full">${searchTerm ? 'Nenhuma ferramenta encontrada.' : 'Nenhuma ferramenta dispon√≠vel para manuten√ß√£o.'}</p>`;
                    }
                    lucide.createIcons();
                }

                function selectToolForMaintenance(id) {
                    maintenanceData.toolId = id;
                    const tool = tools.find(t => t.id === id);
                    document.getElementById('step-selecionar-ferramenta').classList.add('hidden');
                    document.getElementById('step-detalhes-manutencao').classList.remove('hidden');
                    document.getElementById('selectedToolMaintenance').innerHTML = `<div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl mb-3">
                        <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center overflow-hidden">${tool.img ? `<img src="${tool.img}" class="w-full h-full object-cover">` : `<i data-lucide="image" class="text-slate-300"></i>`}</div>
                        <div><p class="font-bold text-xs uppercase text-slate-800">${tool.name}</p><p class="text-[9px] font-black text-slate-400 uppercase">${tool.code}</p></div>
                    </div>`;
                    
                    // Configura√ß√£o do campo de quantidade
                    const qtyContainer = document.getElementById('maintenanceQtyContainer');
                    const qtyInput = document.getElementById('maintenanceQtyInput');
                    const maxQtySpan = document.getElementById('maintenanceMaxQty');
                    const isBulk = tool.hasOwnProperty('qty');
                    
                    if (isBulk) {
                        qtyContainer.classList.remove('hidden');
                        qtyInput.max = tool.qty;
                        qtyInput.value = 1;
                        if(maxQtySpan) maxQtySpan.innerText = `Dispon√≠vel: ${tool.qty}`;
                    } else {
                        document.getElementById('maintenanceQtyContainer').classList.add('hidden');
                        qtyInput.value = 1;
                    }

                    document.getElementById('maintenanceNoteInput').value = tool.maintenanceNote || '';
                    document.getElementById('btnFinalizeMaintenance').onclick = finalizeMaintenanceReport;
                    lucide.createIcons();
                    
                }

                function resetMaintenance() {
                    document.getElementById('step-selecionar-ferramenta').classList.remove('hidden');
                    document.getElementById('step-detalhes-manutencao').classList.add('hidden');
                }

                function finalizeMaintenanceReport() {
                    const t = tools.find(x => x.id === maintenanceData.toolId);
                    const note = document.getElementById('maintenanceNoteInput').value.trim();
                    const qtyInput = document.getElementById('maintenanceQtyInput');
                    let qtyToMaintenance = parseInt(qtyInput.value);
                    
                    if (!qtyToMaintenance || qtyToMaintenance < 1) qtyToMaintenance = 1;

                    if (t && !note) { // Valida√ß√£o para nota de manuten√ß√£o
                        document.getElementById('alertModalText').innerText = 'Por favor, descreva o problema para registrar a manuten√ß√£o.';
                        openModal('alertModal');
                        return;
                    }
                    
                    if (!t) return;

                    // Verifica se √© necess√°rio dividir o item (quantidade parcial)
                    const isBulk = t.hasOwnProperty('qty');
                    
                    if (isBulk) {
                        if (qtyToMaintenance > t.qty) {
                             document.getElementById('alertModalText').innerText = 'Quantidade inv√°lida.';
                             openModal('alertModal');
                             return;
                        }

                        // L√≥gica de divis√£o: reduz a quantidade do item original
                        t.qty -= qtyToMaintenance;
                        
                        // Cria novo item para manuten√ß√£o com a quantidade especificada
                        const maintenanceTool = {
                            ...t,
                            id: Date.now(),
                            qty: qtyToMaintenance,
                            status: 'quebrado',
                            user: 'MANUTEN√á√ÉO',
                            maintenanceNote: note,
                            original_id: t.original_id || t.id, // Se t j√° √© clone, mant√©m. Se √© original, aponta para t.
                            maintenanceInfo: {
                                status: 'Aguardando Or√ßamento',
                                provider: '',
                                cost: 0,
                                quoteNote: '',
                                reportDate: new Date().toISOString(),
                                reportedBy: t.user !== '-' ? t.user : 'ALMOXARIFADO',
                                approvalDate: null,
                                invoiceFile: null
                            }
                        };
                        
                        // Se for um item em uso (clone) e a quantidade zerar, remove da lista e fecha hist√≥rico
                        if (t.status === 'em uso') {
                            const activeLoan = history.find(h => h.toolId === t.id && h.returnDate === null && h.type === 'emprestimo');
                            if (t.qty === 0) {
                                if (activeLoan) {
                                    activeLoan.returnDate = new Date().toISOString();
                                    activeLoan.condition = 'quebrado';
                                }
                                tools = tools.filter(tool => tool.id !== t.id);
                            } else if (activeLoan) {
                                // Se for parcial, atualiza a quantidade no hist√≥rico
                                activeLoan.qty = t.qty;
                            }
                        }

                        // Adiciona hist√≥rico de manuten√ß√£o para o novo item
                        history.unshift({
                            historyId: Date.now() + 1,
                            toolId: maintenanceTool.id,
                            toolName: maintenanceTool.name,
                            toolImg: maintenanceTool.img,
                            workerName: t.user !== '-' ? t.user : 'ALMOXARIFADO', // Quem reportou
                            qty: qtyToMaintenance,
                            checkoutDate: new Date().toISOString(),
                            returnDate: null,
                            type: 'manutencao'
                        });
                        
                        tools.unshift(maintenanceTool);

                    } else {
                        // Quantidade total ou item √∫nico (comportamento padr√£o)
                        
                        // Se a ferramenta j√° estava em uso, primeiro finaliza o hist√≥rico de empr√©stimo
                        const activeLoan = history.find(h => h.toolId === t.id && h.returnDate === null && h.type === 'emprestimo');
                        if (activeLoan) {
                            activeLoan.returnDate = new Date().toISOString();
                            activeLoan.condition = 'quebrado';
                        }

                        const responsibleUser = t.user !== '-' ? t.user : 'ALMOXARIFADO';
                        t.status = 'quebrado';
                        t.user = 'MANUTEN√á√ÉO';
                        t.maintenanceNote = note;
                        
                        history.unshift({
                            historyId: Date.now(),
                            toolId: t.id,
                            toolName: t.name,
                            toolImg: t.img,
                            workerName: responsibleUser,
                            qty: t.qty || 1,
                            checkoutDate: new Date().toISOString(),
                            returnDate: null,
                            type: 'manutencao'
                        });
                        t.maintenanceInfo = {
                            status: 'Aguardando Or√ßamento',
                            provider: '',
                            cost: 0,
                            quoteNote: '',
                            reportDate: new Date().toISOString(),
                            reportedBy: responsibleUser,
                            approvalDate: null,
                            invoiceFile: null
                        };
                    }

                    closeModal('maintenanceModal');
                    setTimeout(save, 50);
                }

                // --- FUN√á√ïES DE SA√çDA DE MATERIAL ---
                function openMaterialModal(isSearchUpdate = false, toolId = null) {
                    if (!isSearchUpdate) {
                        materialData = { toolId: null, workerId: null, qty: null };
                        resetMaterial(0);
                        document.getElementById('materialSearchInput').value = "";
                        if (toolId) {
                            selectToolForMaterial(toolId);
                        return;
                        }
                    }

                    document.getElementById('materialModalTitle').innerText = "Sa√≠da de Ferramentas";
                    document.getElementById('materialModalStep1').innerText = "1. Qual item ser√° retirado?";
                    
                    const list = document.getElementById('toolGridMaterial');
                    const searchInput = document.getElementById('materialSearchInput');                    
                    const searchTerm = searchInput.value.toLowerCase();

                    const availableItems = tools.filter(t => 
                        t.status === 'disponivel' &&
                        (!searchTerm || t.name.toLowerCase().includes(searchTerm) || (t.code && t.code.toLowerCase().includes(searchTerm)) || (t.brand && t.brand.toLowerCase().includes(searchTerm)))
                    );

                    list.innerHTML = availableItems.map(t => {
                        const stockInfo = `
                            <span class="text-[8px] font-black text-slate-400 uppercase">Estoque</span>
                            <div class="flex items-center justify-center gap-1 text-slate-900 font-black text-lg"><i data-lucide="box" size="12"></i><span>${t.qty || 0}</span></div>
                        `;

                        return `
                        <div onclick="selectToolForMaterial(${t.id})"
                            class="bg-white rounded-2xl p-3 shadow-lg border border-slate-100 cursor-pointer hover:border-blue-500 hover:shadow-xl transition-all flex flex-col text-center group">
                            <div class="relative w-full aspect-square bg-white rounded-xl mb-3 flex items-center justify-center overflow-hidden border border-slate-100">
                                ${t.img ? `<img src="${t.img}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110">` : `<i data-lucide="wrench" class="text-slate-200" size="40"></i>`}
                            </div>
                            <div class="flex-1 flex flex-col justify-between">
                                <h3 class="font-black text-slate-700 uppercase text-[10px] leading-tight h-8 flex items-center justify-center px-1" title="${t.name}">${t.name}</h3>
                                <div class="mt-2 pt-2 border-t border-slate-100">
                                    ${stockInfo}
                                </div>
                            </div>
                        </div>
                    `}).join('');

                    if(availableItems.length === 0) {
                        list.innerHTML = `<p class="text-center text-xs text-slate-400 col-span-full py-10">${searchTerm ? 'Nenhum item encontrado para "' + searchTerm + '".' : 'Nenhum item dispon√≠vel.'}</p>`;
                    }
                    lucide.createIcons();

                    if (!isSearchUpdate) openModal('materialModal');
                }

                function selectToolForMaterial(id) {
                    materialData.toolId = id;
                    resetMaterial(1);
                }

                function processQtyStep() {
                    const tool = tools.find(t => t.id === materialData.toolId);
                    const qtyInput = document.getElementById('materialQtyInput');
                    const qty = parseInt(qtyInput.value);

                    if (!qty || qty <= 0) { // Valida√ß√£o de quantidade
                        document.getElementById('alertModalText').innerText = "Por favor, insira uma quantidade v√°lida.";
                        openModal('alertModal');
                        return;
                    }

                    const isConsumable = tool.hasOwnProperty('qty') && tool.qty > 0;
                    if (isConsumable && qty > tool.qty) { // Valida√ß√£o de estoque
                        document.getElementById('alertModalText').innerText = `Quantidade indispon√≠vel. M√°ximo em estoque: ${tool.qty}`;
                        openModal('alertModal');
                        return;
                    }
                    if (!isConsumable && qty > 1) { // Valida√ß√£o para item √∫nico
                        document.getElementById('alertModalText').innerText = "S√≥ √© poss√≠vel emprestar uma unidade desta ferramenta por vez.";
                        openModal('alertModal');                        
                        return;
                    }

                    materialData.qty = qty;
                    resetMaterial(2);
                }

                function selectWorkerForMaterial(workerId) {
                    materialData.workerId = workerId;
                    resetMaterial(3);
                }

                function resetMaterial(step) {
                    document.getElementById('step-material-tool').classList.toggle('hidden', step !== 0);
                    document.getElementById('step-material-qty').classList.toggle('hidden', step !== 1);
                    document.getElementById('step-material-worker').classList.toggle('hidden', step !== 2);
                    document.getElementById('step-material-confirm').classList.toggle('hidden', step !== 3);

                    if (step === 1) { // Etapa de Quantidade
                        const tool = tools.find(t => t.id === materialData.toolId);
                        const isConsumable = tool.hasOwnProperty('qty');
                        const stockInfo = isConsumable ? `EM ESTOQUE: ${tool.qty}` : 'FERRAMENTA';
                        document.getElementById('selectedToolMaterial').innerHTML = `<div class="w-24 h-24 bg-slate-100 rounded-2xl mx-auto mb-4 overflow-hidden border border-slate-200">${tool.img ? `<img src="${tool.img}" class="w-full h-full object-cover">` : `<div class="flex items-center justify-center h-full text-slate-300"><i data-lucide="wrench"></i></div>`}</div><h3 class="font-black text-slate-900 uppercase text-sm">${tool.name}</h3><p class="text-slate-400 text-[10px] font-bold uppercase">${stockInfo}</p>`;
                        const qtyInput = document.getElementById('materialQtyInput');
                        qtyInput.value = 1;
                        qtyInput.disabled = !isConsumable;
                        if (isConsumable) qtyInput.max = tool.qty;
                        lucide.createIcons();
                    } else if (step === 2) { // Etapa de Colaborador
                        const list = document.getElementById('teamGridMaterial');
                        list.innerHTML = team.map(w => `
                            <div onclick="selectWorkerForMaterial(${w.id})" class="bg-slate-50 p-4 rounded-xl border border-slate-100 cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all flex flex-col items-center gap-2 text-center">
                                <div class="w-10 h-10 bg-white text-blue-600 rounded-full flex items-center justify-center font-black shadow-sm">${w.name.charAt(0)}</div>
                                <div><p class="font-bold text-[10px] uppercase text-slate-700">${w.name}</p><p class="text-[8px] font-black text-slate-400 uppercase">${w.company}</p></div>
                            </div>
                        `).join('');
                        lucide.createIcons();
                    } else if (step === 3) { // Etapa de Confirma√ß√£o
                        const tool = tools.find(t => t.id === materialData.toolId);
                        const worker = team.find(w => w.id === materialData.workerId);
                        const isTool = !tool.hasOwnProperty('qty');
                        const operationType = isTool ? 'Empr√©stimo' : 'Retirada';

                        document.getElementById('confirmationDetails').innerHTML = `
                            <div class="w-24 h-24 bg-slate-100 rounded-2xl mx-auto mb-4 overflow-hidden border border-slate-200">${tool.img ? `<img src="${tool.img}" class="w-full h-full object-cover">` : `<div class="flex items-center justify-center h-full text-slate-300"><i data-lucide="wrench"></i></div>`}</div>
                            <h3 class="font-black text-slate-900 uppercase text-sm">${tool.name}</h3>
                            <p class="text-slate-500 text-xs font-bold">QTD: <span class="text-blue-600">${materialData.qty}</span> | RESPONS√ÅVEL: <span class="text-blue-600">${worker.name}</span></p>
                        `;
                        document.querySelector('#step-material-confirm h4').innerText = `Confirmar ${operationType}?`;
                        document.getElementById('btnFinalizeMaterial').innerText = `Confirmar ${operationType}`;
                        document.getElementById('btnFinalizeMaterial').onclick = finalizeMaterialCheckout;
                        lucide.createIcons();
                    }
                }

                function finalizeMaterialCheckout() {
                    const t = tools.find(x => x.id === materialData.toolId);
                    const w = team.find(x => x.id === materialData.workerId);
                    const qty = materialData.qty;
                    
                    if (!t || !w || !qty) return;

                    const isTool = !t.hasOwnProperty('qty');
                    const hasStock = t.hasOwnProperty('qty');

                    if (isTool) {
                        t.status = 'em uso';
                        t.user = w.name;
                        history.unshift({ 
                            historyId: Date.now(), 
                            toolId: t.id, 
                            toolName: t.name, 
                            toolImg: t.img,
                            workerName: w.name, 
                            qty: 1, 
                            checkoutDate: new Date().toISOString(), 
                            returnDate: null,
                            type: 'emprestimo' 
                        });
                    } else if (hasStock) {
                        if (t.qty < qty) {
                            alert(`Quantidade insuficiente em estoque. Dispon√≠vel: ${t.qty}`);
                            return;
                        }
                        t.qty -= qty;
                        const newTool = { ...t, status: 'em uso', user: w.name, id: Date.now(), original_id: t.id, qty: qty };
                        tools.unshift(newTool);
                        history.unshift({ 
                            historyId: Date.now() + 1, toolId: newTool.id, toolName: t.name, toolImg: t.img, workerName: w.name, qty: qty, 
                            checkoutDate: new Date().toISOString(), returnDate: null, type: 'emprestimo' 
                        });
                    }
                    closeModal('materialModal');
                    save();
                }

                // --- FUN√á√ïES DE C√ìDIGO DE BARRAS E QR CODE ---
                function focusBarcode() {
                    document.getElementById('barcodeInput').focus();
                }

                function handleBarcodeScan(code) {
                    if (!code) return;
                    document.getElementById('materialSearchInput').value = code;
                    openMaterialModal(true);
                    document.getElementById('barcodeInput').value = ""; // Limpa para a pr√≥xima leitura
                }

                function startQrScanner() {
                    document.getElementById('step-material-tool').style.display = 'none';
                    document.getElementById('qrScannerContainer').style.display = 'block';

                    qrScanner = new Html5Qrcode("qr-reader");
                    const config = { fps: 10, qrbox: { width: 200, height: 200 } };
                    
                    qrScanner.start({ facingMode: "environment" }, config, 
                        (decodedText, decodedResult) => {
                            handleBarcodeScan(decodedText);
                            stopQrScanner();
                            closeModal('materialModal');
                        },
                        (errorMessage) => { /* ignore */ }
                    ).catch(err => console.error("QR Scanner Error:", err));
                }

                function stopQrScanner() {
                    if (qrScanner) {
                        qrScanner.stop().then(() => {
                            document.getElementById('step-material-tool').style.display = 'block';
                            document.getElementById('qrScannerContainer').style.display = 'none';
                            qrScanner = null;
                        }).catch(err => console.error("QR Stop Error:", err));
                    }
                }

                // --- FUN√á√ïES DE ALERTA DE ATRASO ---
                function checkOverdueTools() {
                    const now = new Date();
                    const overdueTools = history.filter(h => {
                        if (h.returnDate || h.type !== 'emprestimo') {
                            return false;
                        }
                        const checkoutDate = new Date(h.checkoutDate);
                        const diffHours = (now - checkoutDate) / (1000 * 60 * 60);
                        return diffHours > 24;
                    });
                    return overdueTools;
                }

                function renderOverdueAlert() {
                    const overdueTools = checkOverdueTools();
                    const overdueBtn = document.getElementById('overdueBtn');
                    const overdueBadge = document.getElementById('overdueCountBadge');

                    if (overdueBtn && overdueBadge) {
                        if (overdueTools.length > 0) {
                            overdueBtn.classList.remove('hidden');
                            overdueBadge.innerText = overdueTools.length;
                            const textSpan = overdueBtn.querySelector('span:last-child');
                            if (textSpan) {
                                textSpan.innerText = `Ferramenta${overdueTools.length > 1 ? 's' : ''} com devolu√ß√£o atrasada. Clique para ver.`;
                            }
                        } else {
                            overdueBtn.classList.add('hidden');
                        }
                    }

                    // Bolinha de alerta no bot√£o do Painel Principal
                    const mainOverdueBadge = document.getElementById('mainOverdueBadge');
                    if (mainOverdueBadge) {
                        mainOverdueBadge.classList.toggle('hidden', overdueTools.length === 0);                        
                    }
                }

                function openOverdueModal() {
                    const overdueTools = checkOverdueTools();
                    const listEl = document.getElementById('overdueList');
                    
                    if (overdueTools.length === 0) {
                        listEl.innerHTML = '<p class="text-center text-slate-500 py-8">Nenhuma ferramenta com devolu√ß√£o atrasada.</p>';
                    } else {
                        listEl.innerHTML = overdueTools.map(h => {
                            const checkoutDate = new Date(h.checkoutDate);
                            const now = new Date();
                            const diffHours = Math.floor((now - checkoutDate) / (1000 * 60 * 60));
                            const diffDays = Math.floor(diffHours / 24);
                            const remainingHours = diffHours % 24;
                            let timeString = `${diffDays}d ${remainingHours}h`;
                            
                            const tool = tools.find(t => t.id === h.toolId) || {};
                            const toolImg = h.toolImg || tool.img;

                            return `<div class="flex items-center gap-4 p-4 mb-3 bg-slate-50 rounded-xl border border-slate-100"><div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center overflow-hidden border">${toolImg ? `<img src="${toolImg}" class="w-full h-full object-cover">` : `<i data-lucide="wrench" class="text-slate-300"></i>`}</div><div class="flex-1"><p class="font-bold text-xs uppercase text-slate-800">${h.toolName}</p><p class="text-[10px] font-bold text-slate-400">COM: <span class="text-orange-600">${h.workerName}</span></p></div><div class="text-right"><p class="text-xs font-bold text-rose-600">Atrasado h√°</p><p class="text-lg font-black text-rose-600">${timeString.trim()}</p></div></div>`;
                        }).join('');
                    }

                    openModal('overdueModal');
                    lucide.createIcons();
                }

                // --- FUN√á√ïES DE RELAT√ìRIO ---
                function exportToolsToExcel() {
                    // --- 0. Common Styles ---
                    const headerStyle = {
                        font: { bold: true, color: { rgb: "FFFFFF" }, sz: 12 },
                        fill: { fgColor: { rgb: "107C41" } }, // Green Header
                        alignment: { horizontal: "center", vertical: "center" }
                    };
                    const centerAlign = { alignment: { horizontal: "center", vertical: "center" } };
                    const currencyFormat = { numFmt: 'R$ #,##0.00' };
                    const borderAll = {
                        border: {
                            top: { style: "thin", color: { rgb: "E2E8F0" } },
                            bottom: { style: "thin", color: { rgb: "E2E8F0" } },
                            left: { style: "thin", color: { rgb: "E2E8F0" } },
                            right: { style: "thin", color: { rgb: "E2E8F0" } }
                        }
                    };

                    const workbook = XLSX.utils.book_new();

                    // --- 1. GUIA ESTOQUE ---
                    (() => {
                        const statusStyles = {
                            disponivel: { fill: { fgColor: { rgb: "D1FAE5" } } },
                            'em uso':   { fill: { fgColor: { rgb: "FFEDD5" } } },
                            quebrado:   { fill: { fgColor: { rgb: "FEE2E2" } } }
                        };
                        const sortedTools = [...tools].sort((a, b) => (a.code || '').localeCompare(b.code || '', undefined, { numeric: true, sensitivity: 'base' }));
                        const headers = ['Nome', 'C√≥digo', 'Local', 'Status', 'Respons√°vel', 'Valor', 'Quantidade'];
                        const data = sortedTools.map(t => [
                            capitalize(t.name), t.code, t.location, capitalize(t.status), capitalize(t.user), t.value || 0, t.qty || 0
                        ]);
                        const worksheetData = [headers, ...data];
                        const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);

                        worksheetData.forEach((row, r) => {
                            row.forEach((cell, c) => {
                                const cellRef = XLSX.utils.encode_cell({ r, c });
                                if (!worksheet[cellRef]) return;
                                worksheet[cellRef].s = { ...borderAll };
                                if (r === 0) {
                                    worksheet[cellRef].s = { ...headerStyle, ...borderAll };
                                } else {
                                    if (c === 5 || c === 6) { // Valor & Quantidade
                                        worksheet[cellRef].t = 'n';
                                    }
                                    if ([1, 2, 3, 4, 6].includes(c)) worksheet[cellRef].s.alignment = centerAlign.alignment;
                                    if (c === 5) { worksheet[cellRef].s.numFmt = currencyFormat.numFmt; } // Valor

                                    if (c === 3) {
                                        const status = (typeof cell === 'string' ? cell.toLowerCase() : '');
                                        if (statusStyles[status]) worksheet[cellRef].s.fill = statusStyles[status].fill;
                                    }
                                }
                            });
                        });

                        worksheet['!cols'] = [ { wch: 40 }, { wch: 15 }, { wch: 25 }, { wch: 15 }, { wch: 25 }, { wch: 15 }, { wch: 12 } ];
                        worksheet['!autofilter'] = { ref: `A1:G${data.length + 1}` };
                        XLSX.utils.book_append_sheet(workbook, worksheet, "Estoque");
                    })();

                    // --- 2. GUIA FOLLOW-UP ---
                    (() => {
                        const maintenanceTools = tools.filter(t => t.status === 'quebrado' && t.maintenanceInfo);
                        const headers = ['Equipamento', 'C√≥digo', 'Problema', 'Status Atual', 'Fornecedor', 'Custo Or√ßado', 'Reportado Por', 'Data Reporte'];
                        const data = maintenanceTools.map(t => {
                            const info = t.maintenanceInfo || {};
                            return [ t.name, t.code, t.maintenanceNote, info.status, info.provider, info.cost || 0, info.reportedBy, formatISODate(info.reportDate) ];
                        });
                        const worksheetData = [headers, ...data];
                        const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);

                        worksheetData.forEach((row, r) => {
                            row.forEach((cell, c) => {
                                const cellRef = XLSX.utils.encode_cell({ r, c });
                                if (!worksheet[cellRef]) return;
                                worksheet[cellRef].s = { ...borderAll };
                                if (r === 0) {
                                    worksheet[cellRef].s = { ...headerStyle, ...borderAll };
                                } else {
                                    if ([1, 3, 4, 6, 7].includes(c)) worksheet[cellRef].s.alignment = centerAlign.alignment;
                                    if (c === 5) { worksheet[cellRef].t = 'n'; worksheet[cellRef].s.numFmt = currencyFormat.numFmt; }
                                }
                            });
                        });

                        worksheet['!cols'] = [ { wch: 40 }, { wch: 15 }, { wch: 50 }, { wch: 20 }, { wch: 25 }, { wch: 15 }, { wch: 25 }, { wch: 20 } ];
                        worksheet['!autofilter'] = { ref: `A1:H${data.length + 1}` };
                        XLSX.utils.book_append_sheet(workbook, worksheet, "FollowUp");
                    })();

                    // --- 3. GUIA HIST√ìRICO ---
                    (() => {
                        const headers = ['Ferramenta', 'Respons√°vel', 'Qtd', 'Data Retirada', 'Data Devolu√ß√£o', 'Status', 'Tempo de Posse'];
                        const data = history.sort((a,b) => new Date(b.checkoutDate) - new Date(a.checkoutDate)).map(h => {
                            let statusLabel;
                            if (h.returnDate) {
                                statusLabel = h.condition === 'quebrado' ? 'Devolvido (Quebrado)' : 'Devolvido';
                            } else {
                                statusLabel = h.type === 'manutencao' ? 'Em Manuten√ß√£o' : 'Em Uso';
                            }
                            return [ h.toolName, h.workerName, h.qty, formatISODate(h.checkoutDate), formatISODate(h.returnDate), statusLabel, formatDuration(h.checkoutDate, h.returnDate) ];
                        });
                        const worksheetData = [headers, ...data];
                        const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);

                        worksheetData.forEach((row, r) => {
                            row.forEach((cell, c) => {
                                const cellRef = XLSX.utils.encode_cell({ r, c });
                                if (!worksheet[cellRef]) return;
                                worksheet[cellRef].s = { ...borderAll };
                                if (r === 0) {
                                    worksheet[cellRef].s = { ...headerStyle, ...borderAll };
                                } else {
                                    if (c === 2) { // Qtd column
                                        worksheet[cellRef].t = 'n';
                                    }
                                    if ([2, 3, 4, 5, 6].includes(c)) worksheet[cellRef].s.alignment = centerAlign.alignment;
                                }
                            });
                        });
                        worksheet['!cols'] = [ { wch: 40 }, { wch: 25 }, { wch: 10 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 15 } ];
                        worksheet['!autofilter'] = { ref: `A1:G${data.length + 1}` };
                        XLSX.utils.book_append_sheet(workbook, worksheet, "Historico");
                    })();

                    // --- Download Workbook ---
                    XLSX.writeFile(workbook, "Relatorio_Completo_Ferramentaria.xlsx");
                }

                function exportToPDF() {
                    try {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF({ orientation: 'landscape' });

                        // --- 1. GUIA ESTOQUE ---
                        doc.text("Relat√≥rio de Estoque", 14, 16);
                        const estoqueHead = [['Nome', 'C√≥digo', 'Local', 'Status', 'Respons√°vel', 'Valor', 'Quantidade']];
                        const sortedTools = [...tools].sort((a, b) => (a.code || '').localeCompare(b.code || '', undefined, { numeric: true, sensitivity: 'base' }));
                        const estoqueBody = sortedTools.map(t => [
                            capitalize(t.name),
                            t.code || '',
                            t.location || '',
                            capitalize(t.status),
                            capitalize(t.user),
                            formatBRL(t.value || 0),
                            t.qty || 0
                        ]);
                        doc.autoTable({
                            head: estoqueHead,
                            body: estoqueBody,
                            startY: 22,
                            theme: 'grid',
                            headStyles: { fillColor: [16, 124, 65] }
                        });

                        // --- 2. GUIA FOLLOW-UP ---
                        doc.addPage();
                        doc.text("Relat√≥rio de Follow-Up de Manuten√ß√£o", 14, 16);
                        const maintHead = [['Equipamento', 'C√≥digo', 'Problema', 'Status Atual', 'Fornecedor', 'Custo Or√ßado', 'Reportado Por', 'Data Reporte']];
                        const maintenanceTools = tools.filter(t => t.status === 'quebrado' && t.maintenanceInfo);
                        const maintBody = maintenanceTools.map(t => {
                            const info = t.maintenanceInfo || {};
                            return [
                                t.name,
                                t.code || '',
                                t.maintenanceNote || '',
                                info.status || '',
                                info.provider || '',
                                formatBRL(info.cost || 0),
                                info.reportedBy || '',
                                formatISODate(info.reportDate)
                            ];
                        });
                        doc.autoTable({
                            head: maintHead,
                            body: maintBody,
                            startY: 22,
                            theme: 'grid',
                            headStyles: { fillColor: [16, 124, 65] }
                        });

                        // --- 3. GUIA HIST√ìRICO ---
                        doc.addPage();
                        doc.text("Relat√≥rio de Hist√≥rico de Movimenta√ß√µes", 14, 16);
                        const historyHead = [['Ferramenta', 'Respons√°vel', 'Qtd', 'Data Retirada', 'Data Devolu√ß√£o', 'Status', 'Tempo de Posse']];
                        const historyBody = history.sort((a, b) => new Date(b.checkoutDate) - new Date(a.checkoutDate)).map(h => {
                            let statusLabel;
                            if (h.returnDate) {
                                statusLabel = h.condition === 'quebrado' ? 'Devolvido (Quebrado)' : 'Devolvido';
                            } else {
                                statusLabel = h.type === 'manutencao' ? 'Em Manuten√ß√£o' : 'Em Uso';
                            }
                            return [h.toolName, h.workerName, h.qty, formatISODate(h.checkoutDate), formatISODate(h.returnDate), statusLabel, formatDuration(h.checkoutDate, h.returnDate)];
                        });
                        doc.autoTable({
                            head: historyHead,
                            body: historyBody,
                            startY: 22,
                            theme: 'grid',
                            headStyles: { fillColor: [16, 124, 65] }
                        });

                        doc.save("Relatorio_Completo_Ferramentaria.pdf");
                    } catch (e) {
                        console.error("Erro ao gerar PDF:", e);
                        alert("Ocorreu um erro ao gerar o PDF. Verifique o console para mais detalhes.");
                    }
                }
            </script>
            <script>
                // --- FUN√á√ïES DE GEST√ÉO DE MANUTEN√á√ÉO ---

                function setMaintenanceFilter(f) {
                    maintenanceFilter = f;
                    document.querySelectorAll('#section-maintenance .filter-pill').forEach(b => b.classList.remove('active'));
                    document.getElementById(`maint-filter-${f.toLowerCase().replace(/ /g, '-')}`).classList.add('active');
                    renderMaintenance();
                }

                function renderMaintenance() {
                    const grid = document.getElementById('maintenanceGrid');
                    if (!grid) return;
                    const searchTerm = document.getElementById('maintenanceSearchInput').value.toLowerCase();

                    const allMaintenanceTools = tools.filter(t => t.status === 'quebrado' && t.maintenanceInfo);
                    document.getElementById('maintenanceTotalCount').innerText = allMaintenanceTools.length;

                    const maintenanceTools = tools.filter(t => {
                        const hasMaintInfo = t.status === 'quebrado' && t.maintenanceInfo;
                        if (!hasMaintInfo) return false;

                        const matchesFilter = maintenanceFilter === 'all' || (t.maintenanceInfo && t.maintenanceInfo.status === maintenanceFilter);

                        const info = t.maintenanceInfo || {};
                        const matchesSearch = !searchTerm || 
                                              (t.name && t.name.toLowerCase().includes(searchTerm)) ||
                                              (t.code && t.code.toLowerCase().includes(searchTerm)) ||
                                              (info.reportedBy && info.reportedBy.toLowerCase().includes(searchTerm));
                        
                        return matchesFilter && matchesSearch;
                    });

                    if (maintenanceTools.length === 0) {
                        grid.innerHTML = `<p class="text-center text-sm text-slate-400 col-span-full py-20">Nenhum item em manuten√ß√£o encontrado.</p>`;
                        return;
                    }

                    grid.innerHTML = maintenanceTools.map(t => {
                        const info = t.maintenanceInfo || {};
                        return `
                        <div class="bg-white rounded-2xl p-5 shadow-lg border border-slate-100 flex flex-col gap-4 group cursor-pointer hover:shadow-xl hover:-translate-y-1 transition-all relative" onclick="openManageMaintenanceModal(${t.id})">
                            <div class="absolute top-4 right-4 z-10">
                                <button onclick="requestDeleteMaintenance(${t.id}, event)" class="p-2 text-slate-400 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity" title="Excluir Manuten√ß√£o"><i data-lucide="trash-2" size="16"></i></button>
                            </div>
                            <div class="flex items-start gap-4">
                                <div class="w-16 h-16 bg-slate-50 rounded-xl flex items-center justify-center overflow-hidden border border-slate-100 shadow-sm">
                                    ${t.img ? `<img src="${t.img}" class="w-full h-full object-cover">` : `<i data-lucide="wrench" class="text-slate-300" size="24"></i>`}
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-black text-slate-800 uppercase leading-tight">${t.name}</h3>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase">${t.code || 'S/C√ìDIGO'}</p>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <div class="bg-amber-50/50 border border-amber-200/50 rounded-lg p-3 text-center">
                                    <div class="flex items-center justify-center gap-1">
                                        <i data-lucide="alert-circle" class="text-amber-500" size="14"></i>
                                        <p class="text-[9px] font-black text-amber-700 uppercase">Problema Reportado</p>
                                    </div>
                                    <p class="text-xs font-semibold text-amber-900 mt-1 truncate" title="${t.maintenanceNote || ''}">${t.maintenanceNote || 'N/A'}</p>
                                </div>
                                ${info.provider ? `
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="bg-blue-50/50 border border-blue-200/50 rounded-lg p-3 text-center">
                                        <div class="flex items-center justify-center gap-1">
                                            <i data-lucide="building-2" class="text-blue-600" size="14"></i>
                                            <p class="text-[9px] font-black text-blue-700 uppercase">Empresa</p>
                                        </div>
                                        <p class="text-xs font-bold text-blue-900 mt-1 truncate" title="${info.provider}">${info.provider}</p>
                                    </div>
                                    <div class="bg-rose-50/50 border border-rose-200/50 rounded-lg p-3 text-center">
                                        <div class="flex items-center justify-center gap-1">
                                            <i data-lucide="dollar-sign" class="text-rose-600" size="14"></i>
                                            <p class="text-[9px] font-black text-rose-700 uppercase">Or√ßamento</p>
                                        </div>
                                        <p class="text-sm font-black text-rose-900 mt-1">${formatBRL(info.cost)}</p>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                             <!-- Mini Timeline -->
                            <div class="mt-auto pt-4">
                                <p class="text-[9px] font-bold text-slate-400 uppercase mb-2">Status</p>
                                <div class="flex items-center gap-1"><div class="flex-1 h-1.5 rounded-full ${info.status === 'Aguardando Or√ßamento' || info.status === 'Aguardando Aprova√ß√£o' || info.status === 'Em Conserto' || info.status === 'Finalizado' ? 'bg-amber-400' : 'bg-slate-200'}"></div><div class="flex-1 h-1.5 rounded-full ${info.status === 'Aguardando Aprova√ß√£o' || info.status === 'Em Conserto' || info.status === 'Finalizado' ? 'bg-sky-400' : 'bg-slate-200'}"></div><div class="flex-1 h-1.5 rounded-full ${info.status === 'Em Conserto' || info.status === 'Finalizado' ? 'bg-indigo-400' : 'bg-slate-200'}"></div><div class="flex-1 h-1.5 rounded-full ${info.status === 'Finalizado' ? 'bg-emerald-400' : 'bg-slate-200'}"></div></div>
                                <p class="text-center text-xs font-black uppercase mt-2 ${info.status === 'Aguardando Or√ßamento' ? 'text-amber-600' : info.status === 'Aguardando Aprova√ß√£o' ? 'text-sky-600' : info.status === 'Em Conserto' ? 'text-indigo-600' : info.status === 'Finalizado' ? 'text-emerald-600' : 'text-red-600'}">${info.status}</p>
                            </div>
                        </div>
                        `
                    }).join('');
                    lucide.createIcons();
                }

                function handleFileSelect(input) {
                    const file = input.files[0];
                    const dropAreaText = document.getElementById('drop-area-text');
                    const fileNameDisplay = document.getElementById('file-name-display');
                    if (file) {
                        fileNameDisplay.textContent = file.name;
                        dropAreaText.classList.add('hidden');
                        fileNameDisplay.classList.remove('hidden');
                    } else {
                        dropAreaText.classList.remove('hidden');
                        fileNameDisplay.classList.add('hidden');
                    }
                }

            function updateMaintenanceTimeline(status) {
                const statusOrder = ['Aguardando Or√ßamento', 'Aguardando Aprova√ß√£o', 'Em Conserto', 'Finalizado'];
                const currentStatusIndex = statusOrder.indexOf(status);

                for (let i = 1; i <= 4; i++) {
                    const stepEl = document.getElementById(`timeline-step-${i}`);
                    if (stepEl) {
                        const iconContainer = stepEl.querySelector('span');
                        const title = stepEl.querySelector('h3');
                        
                        iconContainer.className = 'absolute flex items-center justify-center w-8 h-8 bg-slate-100 rounded-full -left-4';
                        title.className = 'font-black text-slate-700';

                        if (i - 1 < currentStatusIndex || (status === 'Finalizado' && i <= 4)) {
                            iconContainer.classList.add('bg-emerald-100', 'text-emerald-700');
                            title.classList.add('text-emerald-700');
                        }
                        if (i - 1 === currentStatusIndex && status !== 'Finalizado') {
                            iconContainer.classList.add('bg-blue-100', 'text-blue-700');
                            title.classList.add('text-blue-700');
                        }
                    }
                }
            }

                function openManageMaintenanceModal(id) {
                    itemToManageMaintenanceId = id;
                    const tool = tools.find(t => t.id === id);
                    if (!tool || !tool.maintenanceInfo) return;

                    const info = tool.maintenanceInfo;

                updateMaintenanceTimeline(info.status);

                    // Preenche informa√ß√µes gerais
                    document.getElementById('maintenanceToolName').innerText = `${tool.name} (#${tool.code || 'S/C'})`;
                    document.getElementById('maintenanceToolInfo').innerHTML = `
                        <div class="w-24 h-24 bg-slate-100 rounded-2xl mx-auto mb-4 overflow-hidden border border-slate-200">
                            ${tool.img ? `<img src="${tool.img}" class="w-full h-full object-cover">` : `<i data-lucide="wrench" class="text-slate-300" size="40"></i>`}
                        </div>
                        <p class="text-xs text-slate-500 font-bold">Reportado por: <span class="text-blue-600">${info.reportedBy}</span></p>
                        <p class="text-xs text-slate-500 font-bold">Data: <span class="text-blue-600">${formatISODate(info.reportDate)}</span></p>
                    `;

                    // Esconde todos os passos de a√ß√£o
                    document.querySelectorAll('#maintenanceActions > div').forEach(div => div.classList.add('hidden'));

                    // Mostra o passo correto
                    switch (info.status) {
                        case 'Aguardando Or√ßamento':
                            document.getElementById('maintenance-step-quote').classList.remove('hidden');
                            document.getElementById('quoteProviderInput').value = info.provider || '';
                            document.getElementById('quoteCostInput').value = info.cost || '';
                            document.getElementById('quoteNoteInput').value = info.quoteNote || '';
                            document.getElementById('btnSaveQuote').onclick = () => saveQuote(id);
                            break;
                        case 'Aguardando Aprova√ß√£o':
                            document.getElementById('maintenance-step-approval').classList.remove('hidden');
                            document.getElementById('quoteDetailsDisplay').innerHTML = `
                                <p class="text-xs font-bold text-slate-500">Fornecedor: <span class="font-semibold text-slate-700">${info.provider}</span></p>
                                <p class="text-xs font-bold text-slate-500">Custo: <span class="font-semibold text-emerald-600">${formatBRL(info.cost)}</span></p>
                                <p class="text-xs font-bold text-slate-500">Detalhes: <span class="font-semibold text-slate-700">${info.quoteNote || 'N/A'}</span></p>
                            `;
                            document.getElementById('btnApproveRepair').onclick = () => approveRepair(id);
                            document.getElementById('btnRejectRepair').onclick = () => rejectRepair(id);
                            break;
                        case 'Em Conserto':                            
                            document.getElementById('maintenance-step-finish').classList.remove('hidden');
                            // Limpa o estado do input de arquivo ao abrir o modal
                            const fileInput = document.getElementById('invoiceFileInput');
                            const dropAreaText = document.getElementById('drop-area-text');
                            const fileNameDisplay = document.getElementById('file-name-display');
                            if(fileInput) fileInput.value = null;
                            if(dropAreaText) dropAreaText.classList.remove('hidden');
                            if(fileNameDisplay) fileNameDisplay.classList.add('hidden');
                            document.getElementById('btnFinishRepair').onclick = () => finishRepair(id);
                            document.getElementById('btnBackToQuote').onclick = () => sendBackToQuote(id);
                            break;
                        case 'Finalizado':
                            document.getElementById('maintenance-step-conclude').classList.remove('hidden');
                            const invoiceDisplay = document.getElementById('invoiceDisplay');
                            if (info.invoiceFile) {
                                invoiceDisplay.classList.remove('hidden');
                                invoiceDisplay.innerHTML = `
                                    <div class="flex gap-2 items-center bg-slate-100 p-3 rounded-xl border border-slate-200 cursor-pointer hover:bg-slate-200" onclick="openZoom('${info.invoiceFile}')">
                                        <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center text-slate-400 border border-slate-200">
                                            <i data-lucide="file-text" size="20"></i>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-xs font-bold text-slate-700 truncate">Nota Fiscal Anexada</p>
                                            <p class="text-[10px] text-slate-400 uppercase">Clique para visualizar</p>
                                        </div>
                                        <button onclick="deleteInvoice(${id}, event)" class="p-2 text-rose-500 hover:bg-rose-50 rounded-lg transition-colors" title="Excluir Nota"><i data-lucide="trash-2" size="18"></i></button>
                                    </div>
                                `;
                            } else {
                                invoiceDisplay.classList.add('hidden');
                            }
                            document.getElementById('btnConcludeMaintenance').onclick = () => concludeAndMoveToStock(id);
                            break;
                    }

                    openModal('manageMaintenanceModal');
                    lucide.createIcons();
                }

                function saveQuote(id) {
                    const tool = tools.find(t => t.id === id);
                    if (!tool || !tool.maintenanceInfo) return;

                    tool.maintenanceInfo.provider = document.getElementById('quoteProviderInput').value.toUpperCase();
                    tool.maintenanceInfo.cost = parseFloat(document.getElementById('quoteCostInput').value) || 0;
                    tool.maintenanceInfo.quoteNote = document.getElementById('quoteNoteInput').value;
                    tool.maintenanceInfo.status = 'Aguardando Aprova√ß√£o';

                    closeModal('manageMaintenanceModal');
                    setTimeout(save, 50);
                }

                function approveRepair(id) {
                    const tool = tools.find(t => t.id === id);
                    if (!tool || !tool.maintenanceInfo) return;

                    tool.maintenanceInfo.status = 'Em Conserto';
                    tool.maintenanceInfo.approvalDate = new Date().toISOString();
                    closeModal('manageMaintenanceModal');
                    setTimeout(save, 50);
                }

                function sendBackToQuote(id) {
                    const tool = tools.find(t => t.id === id);
                    if (!tool || !tool.maintenanceInfo) return;
                    tool.maintenanceInfo.status = 'Aguardando Or√ßamento';
                    tool.maintenanceInfo.provider = '';
                    tool.maintenanceInfo.cost = 0;
                    tool.maintenanceInfo.quoteNote = '';
                    tool.maintenanceInfo.approvalDate = null;
                    tool.maintenanceInfo.invoiceFile = null;
                    closeModal('manageMaintenanceModal');
                    setTimeout(save, 50);
                }

                function rejectRepair(id) {
                    const tool = tools.find(t => t.id === id);
                    if (!tool || !tool.maintenanceInfo) return;
                    tool.maintenanceInfo.status = 'Aguardando Or√ßamento';
                    tool.maintenanceInfo.provider = '';
                    tool.maintenanceInfo.cost = 0;
                    tool.maintenanceInfo.quoteNote = '';
                    tool.maintenanceInfo.approvalDate = null;
                    tool.maintenanceInfo.invoiceFile = null;
                    closeModal('manageMaintenanceModal');
                    setTimeout(save, 50);
                }

                function requestDeleteMaintenance(id, event) {
                    event.stopPropagation();
                    const tool = tools.find(t => t.id === id);
                    if (!tool) return;

                    const modal = document.getElementById('deleteModal');
                    modal.querySelector('h3').innerText = 'Cancelar Manuten√ß√£o?';
                    modal.querySelector('p').innerText = `Voc√™ tem certeza que deseja cancelar a manuten√ß√£o para "${tool.name}"? O item retornar√° ao status "Dispon√≠vel".`;
                    document.getElementById('confirmDeleteBtn').onclick = () => {
                        deleteMaintenance(id);
                    };
                    openModal('deleteModal');
                }

                function deleteInvoice(id, event) {
                    if (event) event.stopPropagation();
                    const tool = tools.find(t => t.id === id);
                    if (!tool || !tool.maintenanceInfo) return;

                    const modal = document.getElementById('deleteModal');
                    modal.querySelector('h3').innerText = 'Excluir Nota Fiscal?';
                    modal.querySelector('p').innerText = 'Deseja realmente excluir a nota fiscal? O status do item ser√° revertido para "Em Conserto".';
                    document.getElementById('confirmDeleteBtn').onclick = () => {
                        tool.maintenanceInfo.invoiceFile = null;
                        tool.maintenanceInfo.status = 'Em Conserto';
                        closeModal('deleteModal');
                        setTimeout(() => {
                            save();
                            openManageMaintenanceModal(id);
                        }, 50);
                    };
                    openModal('deleteModal');
                }

                function deleteMaintenance(id) {
                    const tool = tools.find(t => t.id === id);
                    if (tool && tool.status === 'quebrado') {
                        tool.status = 'disponivel';
                        tool.user = '-';
                        tool.maintenanceNote = '';
                        tool.maintenanceInfo = null;
                        history = history.filter(h => !(h.toolId === id && h.type === 'manutencao' && h.returnDate === null));
                        closeModal('deleteModal');
                        setTimeout(save, 50);
                    }
                }

            </script>
        </body>
        </html> 