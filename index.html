    <!DOCTYPE html>
        <html lang="pt-br">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>LDC | Ferramentaria Pro</title>
            
            <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ†Ô∏è</text></svg>">
            <script src="https://cdn.tailwindcss.com"></script>
            <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
            <script src="https://unpkg.com/lucide@latest"></script>

            <script>
                tailwind.config = { darkMode: 'class' }
            </script>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
            <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
            <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

            <style>
                @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap');
                
                :root {
                    --brand-primary: #0F172A;
                    --brand-action: #2563EB;
                    --bg-main: #F8FAFC;
                }

                body { 
                    font-family: 'Plus Jakarta Sans', sans-serif; 
                    background-color: var(--bg-main); 
                    display: flex;
                    height: 100vh;
                    overflow-y: hidden;
                    color: #1E293B;
                }

                .sidebar { width: 280px; transition: all 0.3s ease; background-color: #0B1120; border-right: 1px solid #1E293B; }
                .sidebar.collapsed { width: 80px; }
                
                .main-content { flex: 1; display: none; opacity: 0; transform: translateY(10px); transition: all 0.4s ease; overflow-y: auto; }
                .main-content.active-section { display: block; opacity: 1; transform: translateY(0); }
                
                .nav-btn { width: 100%; display: flex; align-items: center; gap: 1rem; padding: 0.75rem 1rem; border-radius: 0.75rem; font-weight: 700; color: #64748B; transition: all 0.2s; border: none; cursor: pointer; background: transparent; }
                .nav-btn:hover { color: #F1F5F9; background-color: #1E293B; }
                .nav-btn.active { background-color: var(--brand-action); color: white; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3); }
                
                .custom-scrollbar::-webkit-scrollbar { width: 8px; }
                .custom-scrollbar::-webkit-scrollbar-thumb { background: #94A3B8; border-radius: 10px; }
                
                .status-quebrado { background-color: #FFF1F2 !important; color: #E11D48 !important; border: 1px solid #FDA4AF; font-weight: 700; }
                
                .filter-pill { padding: 0.5rem 1.25rem; border-radius: 20px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; transition: all 0.2s; border: 1px solid transparent; cursor: pointer; }
                .filter-pill.active { border-color: currentColor; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }

                .img-container { cursor: pointer !important; }

                .dashboard-filter-btn {
                    background-color: #e2e8f0;
                    color: #475569;
                    padding: 0.25rem 0.75rem;
                    border-radius: 0.5rem;
                    font-size: 0.75rem;
                    font-weight: 700;
                    text-transform: uppercase;
                    border: none;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                .dashboard-filter-btn:hover { background-color: #cbd5e1; }
                .dashboard-filter-btn.active { background-color: var(--brand-action); color: white; }

                .soft-ui-panel {
                    background: #F8FAFC;
                    border-radius: 1.5rem;
                    padding: 1.5rem;
                    box-shadow: 8px 8px 16px #d1d9e6, -8px -8px 16px #ffffff;
                }

                /* Flatpickr Customization for Gray/Silver Theme */
                .flatpickr-calendar {
                    background: #F8FAFC;
                    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                    border: 1px solid #E2E8F0;
                    border-radius: 1rem;
                }
                .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange, .flatpickr-day.selected.inRange, .flatpickr-day.startRange.inRange, .flatpickr-day.endRange.inRange, .flatpickr-day.selected:focus, .flatpickr-day.startRange:focus, .flatpickr-day.endRange:focus, .flatpickr-day.selected:hover, .flatpickr-day.startRange:hover, .flatpickr-day.endRange:hover, .flatpickr-day.selected.prevMonthDay, .flatpickr-day.startRange.prevMonthDay, .flatpickr-day.endRange.prevMonthDay, .flatpickr-day.selected.nextMonthDay, .flatpickr-day.startRange.nextMonthDay, .flatpickr-day.endRange.nextMonthDay {
                    background: #64748B; /* Slate-500 */
                    border-color: #64748B;
                    color: #fff;
                }
                .flatpickr-day.today {
                    border-color: #94A3B8; /* Slate-400 */
                }
                .flatpickr-day:hover {
                    background: #E2E8F0;
                }
                .flatpickr-months .flatpickr-month, .flatpickr-current-month .flatpickr-monthDropdown-months, .flatpickr-weekdays {
                    background: #F8FAFC;
                    color: #1E293B;
                    fill: #1E293B;
                }
                span.flatpickr-weekday {
                    color: #64748B;
                }

                /* Dark Mode Overrides */
                .dark body { background-color: #0f172a; color: #cbd5e1; }
                .dark .bg-white { background-color: #1e293b; border-color: #334155; }
                .dark .bg-slate-50 { background-color: #0f172a; border-color: #334155; }
                .dark .bg-slate-100 { background-color: #334155; border-color: #475569; }
                .dark .bg-slate-200 { background-color: #334155; border-color: #475569; }
                .dark .text-slate-900, .dark .text-slate-800, .dark .text-slate-700 { color: #e2e8f0; }
                .dark .text-slate-600, .dark .text-slate-500, .dark .text-slate-400 { color: #94a3b8; }
                .dark .border-slate-100, .dark .border-slate-200 { border-color: #334155; }
                .dark input, .dark select, .dark textarea { background-color: #334155; border-color: #475569; color: #e2e8f0; }
                .dark .sidebar { background-color: #020617; border-color: #1e293b; }
                .dark .nav-btn:hover { background-color: #1e293b; color: #e2e8f0; }
                .dark .soft-ui-panel { background: #1e293b; box-shadow: none; border: 1px solid #334155; }
            </style>
        </head>
        <body class="bg-slate-50">

            <aside id="sidebar" class="sidebar text-slate-400 flex flex-col h-screen z-50">
                <div class="p-6 flex items-center justify-between">
                    <h1 class="text-white font-black text-xl sidebar-text uppercase tracking-tighter">LDC PRO</h1>
                    <button onclick="toggleSidebar()" class="text-slate-400 hover:text-white bg-transparent border-none cursor-pointer"><i data-lucide="menu"></i></button>
                </div>
                <nav class="flex-1 px-4 space-y-2 mt-4">
                    <button id="btn-main" onclick="showSection('main')" class="nav-btn active"><i data-lucide="layout-dashboard"></i> <span class="sidebar-text">Painel Principal</span></button>
                    <button id="btn-actions" onclick="showSection('actions')" class="nav-btn relative">
                        <i data-lucide="zap"></i> 
                        <span class="sidebar-text">Opera√ß√µes</span>
                        <span id="actionsOverdueBadge" class="hidden absolute top-3 right-3 w-2 h-2 bg-rose-500 rounded-full"></span>
                    </button>
                    <button id="btn-catalog" onclick="showSection('catalog')" class="nav-btn"><i data-lucide="archive"></i> <span class="sidebar-text">Estoque</span></button>
                    <button id="btn-team" onclick="showSection('team')" class="nav-btn"><i data-lucide="users"></i> <span class="sidebar-text">Equipe</span></button>
                    <button id="btn-maintenance" onclick="showSection('maintenance')" class="nav-btn"><i data-lucide="wrench"></i> <span class="sidebar-text">FollowUp</span></button>
                    <button id="btn-logs" onclick="showSection('logs')" class="nav-btn"><i data-lucide="history"></i> <span class="sidebar-text">Hist√≥rico</span></button>
                    <button id="btn-database" onclick="showSection('database')" class="nav-btn"><i data-lucide="database"></i> <span class="sidebar-text">Backup</span></button>
                    <button id="btn-settings" onclick="showSection('settings')" class="nav-btn"><i data-lucide="settings"></i> <span class="sidebar-text">Configura√ß√µes</span></button>
                            <button id="btn-tests" onclick="showSection('tests')" class="nav-btn"><i data-lucide="beaker"></i> <span class="sidebar-text">Testes</span></button>
                </nav>
            </aside>

            <main id="section-main" class="main-content p-4 md:p-8 active-section">
                <div class="max-w-[1400px] mx-auto">
                    <!-- Header Reformulado -->
                    <div class="bg-[#0B1120] rounded-[2.5rem] p-8 mb-10 shadow-2xl relative overflow-hidden border border-slate-800">
                        <!-- Efeito de fundo -->
                        <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-blue-600/20 rounded-full blur-[100px] -mr-32 -mt-32 pointer-events-none"></div>
                        <div class="absolute bottom-0 left-0 w-[400px] h-[400px] bg-indigo-600/10 rounded-full blur-[80px] -ml-20 -mb-20 pointer-events-none"></div>

                        <div class="relative z-10 flex flex-col xl:flex-row justify-between items-start xl:items-center gap-8">
                            <div>
                                <div class="flex items-center gap-4 mb-2">
                                    <div class="p-3 bg-blue-600/20 rounded-2xl border border-blue-500/30 text-blue-400">
                                        <i data-lucide="layout-dashboard" size="28"></i>
                                    </div>
                                    <div>
                                        <h2 class="text-3xl font-black text-white uppercase tracking-tighter leading-none">Invent√°rio Operacional</h2>
                                        <p class="text-slate-400 text-sm font-medium mt-1">Vis√£o geral e controle de ativos</p>
                                    </div>
                                </div>
                            </div>

                            <div class="flex flex-col items-end gap-4 w-full xl:w-auto">
                                <div class="flex items-center gap-2 text-slate-300 bg-slate-800/80 px-5 py-2.5 rounded-full border border-slate-700/50 backdrop-blur-md shadow-lg">
                                    <i data-lucide="calendar" size="16" class="text-blue-400"></i>
                                    <span id="currentDateDisplay" class="text-xs font-bold uppercase tracking-widest"></span>
                                </div>
                                
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div class="lg:col-span-12 space-y-6">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="soft-ui-panel"><p class="text-slate-400 text-[10px] font-bold uppercase mb-1">Total Geral</p><h2 id="totalCount" class="text-2xl font-black">0</h2></div>
                                <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm"><p class="text-emerald-500 text-[10px] font-bold uppercase mb-1">Dispon√≠veis</p><h2 id="availCount" class="text-2xl font-black text-emerald-600">0</h2></div>
                                <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm"><p class="text-orange-500 text-[10px] font-bold uppercase mb-1">Em Uso</p><h2 id="loanCount" class="text-2xl font-black text-orange-500">0</h2></div>
                                <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm"><p class="text-red-500 text-[10px] font-bold uppercase mb-1">Manuten√ß√£o</p><h2 id="brokenCount" class="text-2xl font-black text-red-600">0</h2></div>
                            </div>
                            
                            <div class="bg-white rounded-[2rem] shadow-xl overflow-hidden border border-slate-100">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-slate-50 text-slate-500 text-[10px] font-bold uppercase tracking-wider">
                                        <tr><th class="px-8 py-4">Equipamento</th><th class="px-8 py-4">Status / Respons√°vel</th><th class="px-8 py-4 text-right">A√ß√µes</th></tr>
                                    </thead>
                                    <tbody id="toolList" class="divide-y divide-slate-50"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <main id="section-actions" class="main-content p-4 md:p-8">
                <div class="max-w-[1400px] mx-auto">
                    <div class="bg-[#0B1120] rounded-[2.5rem] p-8 mb-10 shadow-2xl relative overflow-hidden border border-slate-800">
                        <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-blue-600/20 rounded-full blur-[100px] -mr-32 -mt-32 pointer-events-none"></div>
                        <div class="absolute bottom-0 left-0 w-[400px] h-[400px] bg-indigo-600/10 rounded-full blur-[80px] -ml-20 -mb-20 pointer-events-none"></div>
                        <div class="relative z-10 flex items-center gap-4">
                            <div class="p-3 bg-blue-600/20 rounded-2xl border border-blue-500/30 text-blue-400">
                                <i data-lucide="zap" size="28"></i>
                            </div>
                            <div>
                                <h2 class="text-3xl font-black text-white uppercase tracking-tighter leading-none">Central de Opera√ß√µes</h2>
                                <p class="text-slate-400 text-sm font-medium mt-1">Acesso r√°pido √†s principais a√ß√µes</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div onclick="openMaterialModal()" class="bg-white p-10 rounded-[2.5rem] shadow-xl cursor-pointer border-2 border-transparent hover:border-indigo-500 transition-all group relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-50 rounded-full -mr-16 -mt-16 transition-transform group-hover:scale-110"></div>
                            <div class="relative z-10 flex flex-col items-center text-center gap-6">
                                <div class="w-24 h-24 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center shadow-inner group-hover:scale-110 transition-transform duration-300">
                                    <i data-lucide="package-minus" size="48"></i>
                                </div>
                                <div>
                                    <h3 class="text-2xl font-black text-slate-800 uppercase tracking-tight mb-2">Sa√≠da de Materiais</h3>
                                    <p class="text-slate-500 font-medium">Registrar empr√©stimo ou consumo de itens do estoque.</p>
                                </div>
                                <span class="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold uppercase text-xs tracking-widest shadow-lg shadow-indigo-200 group-hover:shadow-indigo-300 transition-all mt-2">Iniciar Sa√≠da</span>
                            </div>
                        </div>

                        <div onclick="openCheckinModal()" class="bg-white p-10 rounded-[2.5rem] shadow-xl cursor-pointer border-2 border-transparent hover:border-emerald-500 transition-all group relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-64 h-64 bg-emerald-50 rounded-full -mr-16 -mt-16 transition-transform group-hover:scale-110"></div>
                            <div class="relative z-10 flex flex-col items-center text-center gap-6">
                                <div class="w-24 h-24 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center shadow-inner group-hover:scale-110 transition-transform duration-300">
                                    <i data-lucide="package-check" size="48"></i>
                                </div>
                                <div>
                                    <h3 class="text-2xl font-black text-slate-800 uppercase tracking-tight mb-2">Devolu√ß√£o</h3>
                                    <p class="text-slate-500 font-medium">Registrar retorno de ferramentas e equipamentos.</p>
                                </div>
                                <span class="px-6 py-3 bg-emerald-600 text-white rounded-xl font-bold uppercase text-xs tracking-widest shadow-lg shadow-emerald-200 group-hover:shadow-emerald-300 transition-all mt-2">Iniciar Devolu√ß√£o</span>
                            </div>
                        </div>

                        <div onclick="openMaintenanceModal()" class="bg-white p-10 rounded-[2.5rem] shadow-xl cursor-pointer border-2 border-transparent hover:border-red-500 transition-all group relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-64 h-64 bg-red-50 rounded-full -mr-16 -mt-16 transition-transform group-hover:scale-110"></div>
                            <div class="relative z-10 flex flex-col items-center text-center gap-6">
                                <div class="w-24 h-24 bg-red-100 text-red-600 rounded-full flex items-center justify-center shadow-inner group-hover:scale-110 transition-transform duration-300">
                                    <i data-lucide="wrench" size="48"></i>
                                </div>
                                <div>
                                    <h3 class="text-2xl font-black text-slate-800 uppercase tracking-tight mb-2">Manuten√ß√£o</h3>
                                    <p class="text-slate-500 font-medium">Reportar danos ou solicitar manuten√ß√£o de equipamentos.</p>
                                </div>
                                <span class="px-6 py-3 bg-red-600 text-white rounded-xl font-bold uppercase text-xs tracking-widest shadow-lg shadow-red-200 group-hover:shadow-red-300 transition-all mt-2">Reportar Manuten√ß√£o</span>
                            </div>
                        </div>

                        <div onclick="openAuditModal()" class="bg-white p-10 rounded-[2.5rem] shadow-xl cursor-pointer border-2 border-transparent hover:border-amber-500 transition-all group relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-64 h-64 bg-amber-50 rounded-full -mr-16 -mt-16 transition-transform group-hover:scale-110"></div>
                            <div class="relative z-10 flex flex-col items-center text-center gap-6">
                                <div class="w-24 h-24 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center shadow-inner group-hover:scale-110 transition-transform duration-300">
                                    <i data-lucide="clipboard-check" size="48"></i>
                                </div>
                                <div>
                                    <h3 class="text-2xl font-black text-slate-800 uppercase tracking-tight mb-2">Auditoria</h3>
                                    <p class="text-slate-500 font-medium">Confer√™ncia f√≠sica do estoque dispon√≠vel.</p>
                                </div>
                                <span class="px-6 py-3 bg-amber-500 text-white rounded-xl font-bold uppercase text-xs tracking-widest shadow-lg shadow-amber-200 group-hover:shadow-amber-300 transition-all mt-2">Iniciar Auditoria</span>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <main id="section-catalog" class="main-content p-4 md:p-8">
                <div class="max-w-[1400px] mx-auto">
                    <!-- Header Estoque -->
                    <div class="bg-[#0B1120] rounded-[2.5rem] p-8 mb-10 shadow-2xl relative overflow-hidden border border-slate-800">
                        <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-blue-600/20 rounded-full blur-[100px] -mr-32 -mt-32 pointer-events-none"></div>
                        <div class="absolute bottom-0 left-0 w-[400px] h-[400px] bg-indigo-600/10 rounded-full blur-[80px] -ml-20 -mb-20 pointer-events-none"></div>
                        <div class="relative z-10 flex flex-col xl:flex-row justify-between items-start xl:items-center gap-8">
                            <div>
                                <div class="flex items-center gap-4 mb-2">
                                    <div class="p-3 bg-blue-600/20 rounded-2xl border border-blue-500/30 text-blue-400"><i data-lucide="archive" size="28"></i></div>
                                    <div>
                                        <h2 class="text-3xl font-black text-white uppercase tracking-tighter leading-none">Estoque</h2>
                                        <p class="text-slate-400 text-sm font-medium mt-1">Gerenciamento de ferramentas e materiais</p>
                                    </div>
                                </div>
                            </div>
                            <div class="relative w-full xl:w-96">
                                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size="16"></i>
                                <input type="text" id="catalogSearchInput" onkeyup="handleSearchInput(this, renderCatalog)" placeholder="BUSCAR POR NOME, C√ìDIGO..." class="w-full bg-slate-800/50 border border-slate-700 text-white rounded-xl pl-12 pr-10 py-3 font-bold uppercase text-xs outline-none focus:border-blue-500 transition-all placeholder-slate-500">
                                <button onclick="clearSearch('catalogSearchInput', renderCatalog)" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-rose-500 hidden z-10"><i data-lucide="x-circle" size="16"></i></button>
                            </div>
                        </div>
                    </div>
                    <button id="overdueBtn" onclick="openOverdueModal()" class="hidden w-full mb-8 relative bg-rose-600 text-white px-6 py-4 rounded-2xl font-bold flex items-center gap-3 shadow-lg text-sm uppercase tracking-widest hover:bg-rose-700 transition-all border-none cursor-pointer">
                        <i data-lucide="alert-triangle"></i>
                        <span id="overdueCountBadge" class="font-black">0</span>
                        <span>Ferramenta(s) com devolu√ß√£o atrasada. Clique para ver.</span>
                    </button>
                    <div class="flex gap-4 mb-8 flex-wrap">
                        <button onclick="setCatalogFilter('all')" id="filter-all" class="filter-pill active bg-slate-200 text-slate-700">Todos</button>
                        <button onclick="setCatalogFilter('disponivel')" id="filter-disponivel" class="filter-pill bg-emerald-100 text-emerald-600">Dispon√≠veis</button>
                        <button onclick="setCatalogFilter('em uso')" id="filter-uso" class="filter-pill bg-orange-100 text-orange-600">Em Uso</button>
                        <button onclick="setCatalogFilter('quebrado')" id="filter-quebrado" class="filter-pill bg-red-100 text-red-600">Manuten√ß√£o</button>
                        <div class="flex-1 flex justify-end gap-4">
                            <div class="bg-white p-3 px-5 rounded-xl border border-slate-100 shadow-sm text-right">
                                <p class="text-slate-400 text-[8px] font-bold uppercase">Valor Total</p><h2 id="catalogTotalValue" class="text-lg font-black text-emerald-600">R$ 0,00</h2>
                            </div>
                            <div class="bg-white p-3 px-5 rounded-xl border border-slate-100 shadow-sm text-right">
                                <p class="text-slate-400 text-[8px] font-bold uppercase">Pe√ßas Totais</p>
                                <h2 class="text-lg font-black text-slate-800 flex items-center justify-end gap-2"><i data-lucide="box" size="20" class="text-slate-400"></i><span id="catalogTotalQty">0</span></h2>
                            </div>
                        </div>
                    </div>
                    <div id="catalogGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8"></div>
                </div>
            </main>

            <main id="section-logs" class="main-content p-4 md:p-8">
                <div class="max-w-[1400px] mx-auto">
                    <!-- Header Hist√≥rico -->
                    <div class="bg-[#0B1120] rounded-[2.5rem] p-8 mb-10 shadow-2xl relative overflow-hidden border border-slate-800">
                        <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-blue-600/20 rounded-full blur-[100px] -mr-32 -mt-32 pointer-events-none"></div>
                        <div class="absolute bottom-0 left-0 w-[400px] h-[400px] bg-indigo-600/10 rounded-full blur-[80px] -ml-20 -mb-20 pointer-events-none"></div>
                        <div class="relative z-10 flex flex-col xl:flex-row justify-between items-start xl:items-center gap-8">
                            <div>
                                <div class="flex items-center gap-4 mb-2">
                                    <div class="p-3 bg-blue-600/20 rounded-2xl border border-blue-500/30 text-blue-400"><i data-lucide="history" size="28"></i></div>
                                    <div>
                                        <h2 class="text-3xl font-black text-white uppercase tracking-tighter leading-none">Hist√≥rico</h2>
                                        <p class="text-slate-400 text-sm font-medium mt-1">Registro de movimenta√ß√µes e eventos</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col md:flex-row gap-3 w-full xl:w-auto">
                                <div class="relative w-full md:w-64">
                                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size="16"></i>
                                    <input type="text" id="historySearchInput" onkeyup="handleSearchInput(this, renderHistory)" placeholder="PESQUISAR..." class="w-full bg-slate-800/50 border border-slate-700 text-white rounded-xl pl-12 pr-10 py-3 font-bold uppercase text-xs outline-none focus:border-blue-500 transition-all placeholder-slate-500">
                                    <button onclick="clearSearch('historySearchInput', renderHistory)" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-rose-500 hidden z-10"><i data-lucide="x-circle" size="16"></i></button>
                                </div>
                                <div class="relative w-full md:w-48">
                                    <i data-lucide="calendar-days" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size="16"></i>
                                    <input type="text" id="historyDateInput" placeholder="FILTRAR DATA..." class="w-full bg-slate-800/50 border border-slate-700 text-white rounded-xl pl-12 pr-10 py-3 font-bold uppercase text-xs outline-none focus:border-blue-500 transition-all placeholder-slate-500 h-[42px] cursor-pointer">
                                    <button id="clearDateBtn" onclick="clearHistoryDateFilter()" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-rose-500 hidden z-10"><i data-lucide="x-circle" size="16"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="historyGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
            </main>

            <main id="section-team" class="main-content p-4 md:p-8">
                <div class="max-w-[1400px] mx-auto">
                    <!-- Header Equipe -->
                    <div class="bg-[#0B1120] rounded-[2.5rem] p-8 mb-10 shadow-2xl relative overflow-hidden border border-slate-800">
                        <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-blue-600/20 rounded-full blur-[100px] -mr-32 -mt-32 pointer-events-none"></div>
                        <div class="absolute bottom-0 left-0 w-[400px] h-[400px] bg-indigo-600/10 rounded-full blur-[80px] -ml-20 -mb-20 pointer-events-none"></div>
                        <div class="relative z-10 flex flex-col xl:flex-row justify-between items-start xl:items-center gap-8">
                            <div>
                                <div class="flex items-center gap-4 mb-2">
                                    <div class="p-3 bg-blue-600/20 rounded-2xl border border-blue-500/30 text-blue-400"><i data-lucide="users" size="28"></i></div>
                                    <div>
                                        <h2 class="text-3xl font-black text-white uppercase tracking-tighter leading-none">Gest√£o de Equipe</h2>
                                        <p class="text-slate-400 text-sm font-medium mt-1">Colaboradores e departamentos</p>
                                    </div>
                                </div>
                            </div>
                            <div class="relative w-full xl:w-96">
                                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size="16"></i>
                                <input type="text" id="teamSearchInput" onkeyup="handleSearchInput(this, renderTeam)" placeholder="PESQUISAR POR NOME..." class="w-full bg-slate-800/50 border border-slate-700 text-white rounded-xl pl-12 pr-10 py-3 font-bold uppercase text-xs outline-none focus:border-blue-500 transition-all placeholder-slate-500">
                                <button onclick="clearSearch('teamSearchInput', renderTeam)" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-rose-500 hidden z-10"><i data-lucide="x-circle" size="16"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Add Worker Card Reformulado -->
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100 mb-8 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-slate-50 rounded-full -mr-16 -mt-16 pointer-events-none"></div>
                        
                        <div class="relative z-10">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                <div>
                                    <h3 class="font-black text-slate-800 uppercase text-lg tracking-tight">Adicionar Novo Colaborador</h3>
                                    <p class="text-sm text-slate-400 font-medium">Selecione o tipo de v√≠nculo e preencha os dados.</p>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                                <!-- Tipo de Colaborador (Cards de Sele√ß√£o) -->
                                <div class="md:col-span-4 flex gap-3">
                                    <div onclick="selectWorkerType('LDC')" id="type-card-ldc" class="flex-1 cursor-pointer bg-blue-50 border-2 border-blue-500 rounded-2xl p-4 flex flex-col items-center justify-center gap-2 transition-all shadow-md group relative overflow-hidden">
                                        <div id="indicator-ldc" class="absolute top-3 right-3 w-2.5 h-2.5 bg-blue-500 rounded-full transition-colors"></div>
                                        <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-blue-600 shadow-sm group-hover:scale-110 transition-transform">
                                            <i data-lucide="building-2" size="20"></i>
                                        </div>
                                        <span id="text-ldc" class="font-black text-blue-900 text-[10px] uppercase tracking-widest">LDC</span>
                                    </div>
                                    
                                    <div onclick="selectWorkerType('TERCEIRO')" id="type-card-terceiro" class="flex-1 cursor-pointer bg-white border-2 border-slate-100 rounded-2xl p-4 flex flex-col items-center justify-center gap-2 transition-all hover:border-slate-300 hover:shadow-md group relative overflow-hidden">
                                        <div id="indicator-terceiro" class="absolute top-3 right-3 w-2.5 h-2.5 bg-slate-200 rounded-full transition-colors"></div>
                                        <div class="w-10 h-10 bg-slate-50 rounded-full flex items-center justify-center text-slate-400 shadow-sm group-hover:scale-110 transition-transform">
                                            <i data-lucide="hard-hat" size="20"></i>
                                        </div>
                                        <span id="text-terceiro" class="font-black text-slate-400 text-[10px] uppercase tracking-widest">Terceiro</span>
                                    </div>
                                </div>

                                <!-- Inputs -->
                                <div class="md:col-span-8 flex flex-col justify-center">
                                    <div class="flex flex-col md:flex-row gap-3 items-end">
                                        <div class="flex-1 w-full space-y-1.5">
                                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-2 tracking-wider">Nome Completo</label>
                                            <input type="text" id="workerNameInput" placeholder="NOME DO COLABORADOR" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 font-bold uppercase text-xs outline-none focus:border-blue-500 transition-all h-[48px]">
                                        </div>
                                        <div class="flex-1 w-full space-y-1.5">
                                            <label id="workerCompanyLabel" class="text-[10px] font-bold text-slate-400 uppercase ml-2 tracking-wider">Matr√≠cula</label>
                                            <input type="text" id="workerCompanyInput" placeholder="000000" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 font-bold uppercase text-xs outline-none focus:border-blue-500 transition-all h-[48px]">
                                        </div>
                                        <button onclick="addWorker()" class="w-full md:w-auto h-[48px] bg-blue-600 text-white px-6 rounded-xl border-none cursor-pointer hover:bg-blue-700 transition-all shadow-lg shadow-blue-200 font-bold uppercase text-xs tracking-widest flex items-center justify-center gap-2">
                                            <i data-lucide="plus" size="16"></i> <span>Adicionar</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-10 pt-8 border-t border-slate-100">
                                <div id="teamGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <main id="section-maintenance" class="main-content p-4 md:p-8">
                <div class="max-w-[1400px] mx-auto">
                    <!-- Header Manuten√ß√£o -->
                    <div class="bg-[#0B1120] rounded-[2.5rem] p-8 mb-10 shadow-2xl relative overflow-hidden border border-slate-800">
                        <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-blue-600/20 rounded-full blur-[100px] -mr-32 -mt-32 pointer-events-none"></div>
                        <div class="absolute bottom-0 left-0 w-[400px] h-[400px] bg-indigo-600/10 rounded-full blur-[80px] -ml-20 -mb-20 pointer-events-none"></div>
                        <div class="relative z-10 flex flex-col xl:flex-row justify-between items-start xl:items-center gap-8">
                            <div>
                                <div class="flex items-center gap-4 mb-2">
                                    <div class="p-3 bg-blue-600/20 rounded-2xl border border-blue-500/30 text-blue-400"><i data-lucide="wrench" size="28"></i></div>
                                    <div>
                                        <h2 class="text-3xl font-black text-white uppercase tracking-tighter leading-none">Follow-Up</h2>
                                        <p class="text-slate-400 text-sm font-medium mt-1">Acompanhamento de reparos</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col items-end gap-4 w-full xl:w-auto">
                                <div class="flex items-center gap-3">
                                     <div class="bg-slate-800/50 px-4 py-2 rounded-xl border border-slate-700 text-right">
                                        <p class="text-white text-[8px] font-bold uppercase">Total em Manuten√ß√£o</p>
                                        <h2 class="text-lg font-black text-white flex items-center justify-end gap-2"><span id="maintenanceTotalCount">0</span></h2>
                                    </div>
                                </div>
                                <div class="relative w-full xl:w-80">
                                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size="16"></i>
                                    <input type="text" id="maintenanceSearchInput" onkeyup="handleSearchInput(this, renderMaintenance)" placeholder="PESQUISAR..." class="w-full bg-slate-800/50 border border-slate-700 text-white rounded-xl pl-12 pr-10 py-3 font-bold uppercase text-xs outline-none focus:border-blue-500 transition-all placeholder-slate-500">
                                    <button onclick="clearSearch('maintenanceSearchInput', renderMaintenance)" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-rose-500 hidden z-10"><i data-lucide="x-circle" size="16"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 mb-8 flex-wrap">
                        <button onclick="setMaintenanceFilter('all')" id="maint-filter-all" class="filter-pill active bg-slate-200 text-slate-700">Todos</button>
                        <button onclick="setMaintenanceFilter('Aguardando Or√ßamento')" id="maint-filter-aguardando-or√ßamento" class="filter-pill bg-amber-100 text-amber-600">Aguardando Or√ßamento</button>
                        <button onclick="setMaintenanceFilter('Aguardando Aprova√ß√£o')" id="maint-filter-aguardando-aprova√ß√£o" class="filter-pill bg-sky-100 text-sky-600">Aguardando Aprova√ß√£o</button>
                        <button onclick="setMaintenanceFilter('Em Conserto')" id="maint-filter-em-conserto" class="filter-pill bg-indigo-100 text-indigo-600">Em Conserto</button>
                        <button onclick="setMaintenanceFilter('Finalizado')" id="maint-filter-finalizado" class="filter-pill bg-emerald-100 text-emerald-600">Finalizados</button>
                    </div>
                    <div id="maintenanceGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
            </main>

            <div id="zoomModal" class="fixed inset-0 bg-black/90 hidden z-[950] flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeModal('zoomModal')">

                <button onclick="closeModal('zoomModal'); event.stopPropagation();" class="absolute top-5 right-5 text-white bg-transparent border-none cursor-pointer z-[951]"><i data-lucide="x" size="32"></i></button>
                <div id="zoomContainer" class="w-full h-full flex items-center justify-center overflow-hidden">
                    <img id="zoomImage" class="max-w-full max-h-full object-contain rounded-xl shadow-2xl transition-transform duration-200 ease-out cursor-zoom-in" onclick="event.stopPropagation()">
                    <iframe id="zoomIframe" class="w-full h-full max-w-5xl bg-white rounded-xl shadow-2xl hidden" onclick="event.stopPropagation()"></iframe>
                </div>
            </div>

            <div id="deleteModal" class="fixed inset-0 bg-slate-900/80 hidden z-[960] flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeModal('deleteModal')">
                <div class="bg-white rounded-[2rem] p-8 w-full max-w-sm text-center shadow-2xl" onclick="event.stopPropagation()">
                    <div class="w-16 h-16 bg-rose-50 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="alert-circle" size="32"></i></div>
                    <h3 class="text-lg font-black text-slate-900 uppercase mb-2">Excluir Item?</h3>
                    <p class="text-slate-500 text-sm mb-6">Voc√™ tem certeza que deseja remover este item? Esta a√ß√£o n√£o pode ser desfeita.</p>
                    <div class="flex gap-3">
                        <button onclick="closeModal('deleteModal')" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold uppercase text-[10px] cursor-pointer border-none">Cancelar</button>
                        <button id="confirmDeleteBtn" class="flex-1 py-3 bg-rose-600 text-white rounded-xl font-bold uppercase text-[10px] cursor-pointer border-none shadow-lg hover:bg-rose-700 transition-all">Confirmar</button>
                    </div>
                </div>
            </div>

            <div id="alertModal" class="fixed inset-0 bg-slate-900/80 hidden z-[900] flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeModal('alertModal')">
                <div class="bg-white rounded-[2rem] p-8 w-full max-w-sm text-center shadow-2xl" onclick="event.stopPropagation()">
                    <div class="w-16 h-16 bg-orange-50 text-orange-500 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="alert-triangle" size="32"></i></div>
                    <h3 id="alertModalTitle" class="text-lg font-black text-slate-900 uppercase mb-2">Aten√ß√£o</h3>
                    <p id="alertModalText" class="text-slate-500 text-sm mb-6">Mensagem de alerta.</p>
                    <button onclick="closeModal('alertModal')" class="w-full py-3 bg-slate-100 text-slate-600 rounded-xl font-bold uppercase text-[10px] cursor-pointer border-none hover:bg-slate-200 transition-all">Entendido</button>
                </div>
            </div>

            <div id="returnModal" class="fixed inset-0 bg-slate-900/80 hidden z-[700] flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeModal('returnModal')">
                <div class="bg-white rounded-[2rem] p-8 w-full max-w-sm text-center shadow-2xl" onclick="event.stopPropagation()">
                    <div class="w-16 h-16 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="activity" size="32"></i></div>
                    <h3 id="returnModalTitle" class="text-lg font-black text-slate-900 uppercase mb-2">Estado da Ferramenta</h3>
                    <p id="returnModalText" class="text-slate-500 text-sm mb-6">Qual o estado de devolu√ß√£o do item?</p>
                    <div class="flex gap-3">
                        <button id="btnReturnBroken" class="flex-1 py-3 bg-rose-600 text-white rounded-xl font-bold uppercase text-[10px] cursor-pointer border-none shadow-lg hover:bg-rose-700">Quebrado</button>
                        <button id="btnReturnWorking" class="flex-1 py-3 bg-emerald-500 text-white rounded-xl font-bold uppercase text-[10px] cursor-pointer border-none shadow-lg hover:bg-emerald-600">Funcionando</button>
                    </div>
                    <button onclick="closeModal('returnModal')" class="w-full mt-6 py-4 bg-slate-100 text-slate-600 rounded-2xl font-black uppercase text-xs border-none cursor-pointer hover:bg-slate-200">Cancelar</button>
                </div>
            </div>

            <div id="addModal" class="fixed inset-0 bg-slate-900/90 hidden z-[800] flex items-center justify-center p-4 backdrop-blur-md" onclick="closeModal('addModal')">
                <div class="bg-white rounded-[2.5rem] w-full max-w-2xl overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
                    <div class="bg-slate-50 p-6 border-b border-slate-100 flex justify-between items-center">
                        <h3 id="addModalTitle" class="font-black uppercase tracking-tighter text-slate-900">Novo Item</h3>
                        <button onclick="closeModal('addModal'); event.stopPropagation();" class="text-slate-400 hover:text-rose-500 bg-transparent border-none cursor-pointer"><i data-lucide="x"></i></button>
                    </div>
                    <div class="p-8 max-h-[80vh] overflow-y-auto custom-scrollbar">
                        <div class="space-y-3">
                            <div class="border-2 border-dashed border-slate-200 rounded-2xl p-4 text-center h-40 flex items-center justify-center cursor-pointer hover:bg-slate-50 transition-colors group" onclick="document.getElementById('fileInput').click()">
                                <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="previewImage(this)">
                                <div id="uploadPlaceholder" class="text-slate-400">
                                    <i data-lucide="camera" class="mx-auto" size="24"></i>
                                    <p class="text-[8px] font-black uppercase">Adicionar Foto</p>
                                </div>
                                <div id="imagePreviewContainer" class="hidden relative h-full" title="Clique para alterar a imagem"><img id="imagePreview" class="h-full object-contain rounded-lg transition-opacity group-hover:opacity-80"><button onclick="removeImage(event)" class="absolute top-1 right-1 bg-rose-500 text-white rounded-full p-0.5 leading-none shadow-md border-2 border-white cursor-pointer" title="Remover Imagem"><i data-lucide="x" size="14"></i></button></div>
                            </div>
                            <div>
                                <label for="toolCodeInput" class="text-[10px] font-black uppercase text-slate-400 ml-4">C√≥digo (#)</label>
                                <input type="text" id="toolCodeInput" placeholder="C√ìDIGO / TAG" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 font-bold uppercase text-xs outline-none focus:border-emerald-500 transition-all">
                            </div>
                            <div>
                                <label for="toolNameInput" class="text-[10px] font-black uppercase text-slate-400 ml-4">Nome do Equipamento</label>
                                <input type="text" id="toolNameInput" placeholder="NOME DA FERRAMENTA" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 font-bold uppercase text-xs outline-none focus:border-emerald-500 transition-all">
                            </div>
                            <div>
                                <label for="toolBrandInput" class="text-[10px] font-black uppercase text-slate-400 ml-4">Marca</label>
                                <input type="text" id="toolBrandInput" placeholder="MARCA DA FERRAMENTA" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 font-bold uppercase text-xs outline-none focus:border-emerald-500 transition-all">
                            </div>
                            <div>
                                <label for="toolWeightInput" class="text-[10px] font-black uppercase text-slate-400 ml-4">Peso</label>
                                <input type="number" id="toolWeightInput" placeholder="PESO (KG)" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 font-bold uppercase text-xs outline-none focus:border-emerald-500 transition-all">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label for="toolValueInput" class="text-[10px] font-black uppercase text-slate-400 ml-4">Valor (R$)</label>
                                    <input type="number" id="toolValueInput" placeholder="150,00" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 font-bold text-xs outline-none focus:border-emerald-500 transition-all">
                                </div>
                                <div>
                                    <label for="toolQtyInput" class="text-[10px] font-black uppercase text-slate-400 ml-4">Quantidade</label>
                                    <input type="number" id="toolQtyInput" placeholder="1" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 font-bold text-xs outline-none focus:border-emerald-500 transition-all">
                                </div>
                            </div>
                        </div>
                        <button id="btnSaveTool" class="w-full mt-6 py-4 bg-emerald-600 text-white rounded-2xl font-black uppercase text-xs shadow-lg border-none cursor-pointer hover:bg-emerald-700 transition-all">Salvar</button>
                    </div>
                </div>
            </div>

            <main id="section-database" class="main-content p-4 md:p-8">
                <div class="max-w-4xl mx-auto">
                    <!-- Header Backup -->
                    <div class="bg-[#0B1120] rounded-[2.5rem] p-8 mb-10 shadow-2xl relative overflow-hidden border border-slate-800">
                        <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-blue-600/20 rounded-full blur-[100px] -mr-32 -mt-32 pointer-events-none"></div>
                        <div class="absolute bottom-0 left-0 w-[400px] h-[400px] bg-indigo-600/10 rounded-full blur-[80px] -ml-20 -mb-20 pointer-events-none"></div>
                        <div class="relative z-10 flex items-center gap-4">
                            <div class="p-3 bg-blue-600/20 rounded-2xl border border-blue-500/30 text-blue-400">
                                <i data-lucide="database" size="28"></i>
                            </div>
                            <div>
                                <h2 class="text-3xl font-black text-white uppercase tracking-tighter leading-none">Backup e Relat√≥rios</h2>
                                <p class="text-slate-400 text-sm font-medium mt-1">Exporta√ß√£o e importa√ß√£o de dados</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div onclick="exportToolsToExcel()" class="bg-white p-10 rounded-[2.5rem] shadow-xl cursor-pointer border-2 border-transparent hover:border-teal-500 text-center">
                            <div class="w-16 h-16 bg-teal-50 text-teal-600 rounded-2xl flex items-center justify-center mx-auto mb-4"><i data-lucide="sheet"></i></div>
                            <h3 class="font-black uppercase text-slate-800">Exportar Excel</h3>
                        </div>
                        <div onclick="exportToPDF()" class="bg-white p-10 rounded-[2.5rem] shadow-xl cursor-pointer border-2 border-transparent hover:border-rose-500 text-center">
                            <div class="w-16 h-16 bg-rose-50 text-rose-600 rounded-2xl flex items-center justify-center mx-auto mb-4"><i data-lucide="file-down"></i></div>
                            <h3 class="font-black uppercase text-slate-800">Exportar PDF</h3>
                        </div>
                        <div onclick="exportData()" class="bg-white p-10 rounded-[2.5rem] shadow-xl cursor-pointer border-2 border-transparent hover:border-blue-500 text-center">
                            <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4"><i data-lucide="download-cloud"></i></div>
                            <h3 class="font-black uppercase text-slate-800">Exportar Dados</h3>
                        </div>
                        <div onclick="document.getElementById('importInput').click()" class="bg-white p-10 rounded-[2.5rem] shadow-xl cursor-pointer border-2 border-transparent hover:border-emerald-500 text-center">
                            <input type="file" id="importInput" class="hidden" accept=".json" onchange="importData(this)">
                            <div class="w-16 h-16 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center mx-auto mb-4"><i data-lucide="upload-cloud"></i></div>
                            <h3 class="font-black uppercase text-slate-800">Importar Dados</h3>
                        </div>
                        <div onclick="generateQRCodesPDF()" class="bg-white p-10 rounded-[2.5rem] shadow-xl cursor-pointer border-2 border-transparent hover:border-indigo-500 text-center">
                            <div class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4"><i data-lucide="qr-code"></i></div>
                            <h3 class="font-black uppercase text-slate-800">Gerar Etiquetas QR</h3>
                        </div>
                        <div onclick="confirmResetSystem()" class="bg-white p-10 rounded-[2.5rem] shadow-xl cursor-pointer border-2 border-transparent hover:border-red-500 text-center">
                            <div class="w-16 h-16 bg-red-50 text-red-600 rounded-2xl flex items-center justify-center mx-auto mb-4"><i data-lucide="trash-2"></i></div>
                            <h3 class="font-black uppercase text-slate-800">Resetar Sistema</h3>
                        </div>
                    </div>
                </div>
            </main>

            <main id="section-tests" class="main-content p-4 md:p-8">
                <div class="max-w-[1400px] mx-auto">
                    <h2 class="text-3xl font-black text-slate-900 tracking-tighter uppercase mb-8">Testes de Funcionalidade</h2>
                    <div class="bg-white p-8 rounded-2xl shadow-lg border border-slate-100 space-y-4">
                        <p class="text-slate-600">Use os bot√µes abaixo para simular cen√°rios espec√≠ficos e testar as funcionalidades de alerta do sistema.</p>
                        <div class="flex gap-4 pt-4 flex-wrap">
                            <button onclick="simulateOverdue()" class="bg-yellow-500 text-white px-4 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg text-[10px] uppercase tracking-widest hover:bg-yellow-600 transition-all border-none cursor-pointer"><i data-lucide="clock" size="16"></i> Simular Atraso de 24h</button>
                            <button onclick="stopSimulation()" class="bg-slate-500 text-white px-4 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg text-[10px] uppercase tracking-widest hover:bg-slate-600 transition-all border-none cursor-pointer"><i data-lucide="x-circle" size="16"></i> Parar Simula√ß√£o</button>
                        </div>
                    </div>
                </div>
            </main>

            <main id="section-settings" class="main-content p-4 md:p-8">
                <div class="max-w-[1400px] mx-auto">
                    <div class="bg-[#0B1120] rounded-[2.5rem] p-8 mb-10 shadow-2xl relative overflow-hidden border border-slate-800">
                        <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-blue-600/20 rounded-full blur-[100px] -mr-32 -mt-32 pointer-events-none"></div>
                        <div class="absolute bottom-0 left-0 w-[400px] h-[400px] bg-indigo-600/10 rounded-full blur-[80px] -ml-20 -mb-20 pointer-events-none"></div>
                        <div class="relative z-10 flex items-center gap-4">
                            <div class="p-3 bg-blue-600/20 rounded-2xl border border-blue-500/30 text-blue-400">
                                <i data-lucide="settings" size="28"></i>
                            </div>
                            <div>
                                <h2 class="text-3xl font-black text-white uppercase tracking-tighter leading-none">Configura√ß√µes</h2>
                                <p class="text-slate-400 text-sm font-medium mt-1">Ajustes do sistema</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Card 1: Par√¢metros Operacionais -->
                        <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100 relative overflow-hidden group">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-blue-50 rounded-full -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
                            <div class="relative z-10">
                                <div class="flex items-center gap-4 mb-6">
                                    <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center">
                                        <i data-lucide="sliders"></i>
                                    </div>
                                    <h3 class="font-black text-slate-800 uppercase text-lg tracking-tight">Par√¢metros Operacionais</h3>
                                </div>
                                
                                <div class="space-y-6">
                                    <div>
                                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-2 tracking-wider">Tempo para Alerta de Atraso</label>
                                        <div class="relative mt-2">
                                            <i data-lucide="clock" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size="18"></i>
                                            <select id="settingOverdueHours" onchange="saveSettings()" class="w-full bg-white border-2 border-slate-100 rounded-xl pl-12 pr-10 py-3 font-bold text-slate-700 outline-none focus:border-blue-500 transition-all appearance-none cursor-pointer">
                                                <option value="24">24 Horas (1 Dia)</option>
                                                <option value="48">48 Horas (2 Dias)</option>
                                                <option value="72">72 Horas (3 Dias)</option>
                                                <option value="168">168 Horas (1 Semana)</option>
                                                <option value="336">336 Horas (2 Semanas)</option>
                                            </select>
                                            <i data-lucide="chevron-down" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none" size="18"></i>
                                        </div>
                                        <p class="text-[10px] text-slate-400 mt-2 font-medium ml-2">Selecione o per√≠odo m√°ximo de empr√©stimo.</p>
                                    </div>

                                    <div class="pt-4 border-t border-slate-50">
                                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-2 tracking-wider">Limite de Estoque Baixo</label>
                                        <div class="relative mt-2">
                                            <i data-lucide="alert-circle" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size="18"></i>
                                            <input type="number" id="settingLowStock" value="5" onchange="saveSettings()" class="w-full bg-white border-2 border-slate-100 rounded-xl pl-12 pr-4 py-3 font-bold text-slate-700 outline-none focus:border-blue-500 transition-all" placeholder="Qtd.">
                                        </div>
                                        <p class="text-[10px] text-slate-400 mt-2 font-medium ml-2">Quantidade m√≠nima para alerta de reposi√ß√£o.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Card 2: Personaliza√ß√£o -->
                        <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100 relative overflow-hidden group">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-purple-50 rounded-full -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
                            <div class="relative z-10">
                                <div class="flex items-center gap-4 mb-6">
                                    <div class="w-12 h-12 bg-purple-100 text-purple-600 rounded-2xl flex items-center justify-center">
                                        <i data-lucide="palette"></i>
                                    </div>
                                    <h3 class="font-black text-slate-800 uppercase text-lg tracking-tight">Personaliza√ß√£o</h3>
                                </div>

                                <div class="space-y-6">
                                    <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                        <div>
                                            <h4 class="font-bold text-slate-700 text-sm">Modo Escuro</h4>
                                            <p class="text-[10px] text-slate-400 font-bold uppercase">Interface noturna</p>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="settingDarkMode" onchange="toggleDarkMode()" class="sr-only peer">
                                            <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                        </label>
                                    </div>

                                    <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                        <div>
                                            <h4 class="font-bold text-slate-700 text-sm">Sons do Sistema</h4>
                                            <p class="text-[10px] text-slate-400 font-bold uppercase">Efeitos sonoros</p>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="settingSystemSounds" onchange="saveSettings()" class="sr-only peer">
                                            <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Card 3: Dados e Sincroniza√ß√£o -->
                        <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100 relative overflow-hidden group lg:col-span-2">
                            <div class="absolute top-0 right-0 w-64 h-64 bg-emerald-50 rounded-full -mr-20 -mt-20 transition-transform group-hover:scale-110"></div>
                            <div class="relative z-10">
                                <div class="flex items-center gap-4 mb-6">
                                    <div class="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-2xl flex items-center justify-center">
                                        <i data-lucide="cloud-cog"></i>
                                    </div>
                                    <h3 class="font-black text-slate-800 uppercase text-lg tracking-tight">Dados e Sincroniza√ß√£o</h3>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div>
                                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-2 tracking-wider">Frequ√™ncia de Backup Autom√°tico</label>
                                        <select class="w-full mt-2 border-2 border-slate-100 rounded-xl px-4 py-3 font-bold text-slate-700 outline-none focus:border-emerald-500 transition-all bg-white">
                                            <option>A cada altera√ß√£o</option>
                                            <option>Diariamente</option>
                                            <option>Semanalmente</option>
                                            <option>Nunca</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-2 tracking-wider">Chave de API (Integra√ß√£o)</label>
                                        <div class="flex gap-2 mt-2">
                                            <input type="password" value="**********************" disabled class="flex-1 border-2 border-slate-100 rounded-xl px-4 py-3 font-bold text-slate-400 outline-none bg-slate-50">
                                            <button class="bg-slate-100 text-slate-500 px-4 rounded-xl font-bold hover:bg-slate-200 transition-all"><i data-lucide="key"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Card 4: Notifica√ß√µes (Substituindo Dados da Empresa) -->
                        <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100 relative overflow-hidden group">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-orange-50 rounded-full -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
                            <div class="relative z-10">
                                <div class="flex items-center gap-4 mb-6">
                                    <div class="w-12 h-12 bg-orange-100 text-orange-600 rounded-2xl flex items-center justify-center">
                                        <i data-lucide="bell-ring"></i>
                                    </div>
                                    <h3 class="font-black text-slate-800 uppercase text-lg tracking-tight">Notifica√ß√µes</h3>
                                </div>

                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <label class="text-xs font-bold text-slate-600 dark:text-slate-300">Alertar Estoque Baixo</label>
                                        <input type="checkbox" id="settingAlertLowStock" onchange="saveSettings()" class="w-5 h-5 text-orange-600 rounded focus:ring-orange-500 border-gray-300 cursor-pointer">
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <label class="text-xs font-bold text-slate-600 dark:text-slate-300">Alertar Devolu√ß√µes Atrasadas</label>
                                        <input type="checkbox" id="settingAlertOverdue" onchange="saveSettings()" class="w-5 h-5 text-orange-600 rounded focus:ring-orange-500 border-gray-300 cursor-pointer">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Card 5: Seguran√ßa -->
                        <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100 relative overflow-hidden group">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-red-50 rounded-full -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
                            <div class="relative z-10">
                                <div class="flex items-center gap-4 mb-6">
                                    <div class="w-12 h-12 bg-red-100 text-red-600 rounded-2xl flex items-center justify-center">
                                        <i data-lucide="shield-alert"></i>
                                    </div>
                                    <h3 class="font-black text-slate-800 uppercase text-lg tracking-tight">Seguran√ßa</h3>
                                </div>

                                <div class="space-y-4">
                                    <div>
                                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-2 tracking-wider">PIN de Administrador</label>
                                        <div class="flex gap-2 mt-1">
                                            <input type="password" id="settingAdminPin" placeholder="****" class="flex-1 border-2 border-slate-100 rounded-xl px-4 py-3 font-bold text-slate-700 outline-none focus:border-red-500 transition-all">
                                            <button id="btnSavePin" onclick="setAdminPin()" class="bg-slate-800 text-white px-4 rounded-xl font-bold uppercase text-[10px] hover:bg-slate-700 transition-all">Definir</button>
                                            <button id="btnDeletePin" onclick="deleteAdminPin()" class="hidden bg-red-100 text-red-600 px-4 rounded-xl font-bold uppercase text-[10px] hover:bg-red-200 transition-all border border-red-200">Excluir</button>
                                        </div>
                                        <p class="text-[10px] text-slate-400 mt-2 font-medium">
                                            <i data-lucide="info" size="12" class="inline mr-1"></i>
                                            Se definido, este PIN ser√° exigido para <strong>Resetar o Sistema</strong> ou <strong>Excluir Colaboradores</strong>.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <div id="auditModal" class="fixed inset-0 bg-slate-900/90 hidden z-[800] flex items-center justify-center p-4 backdrop-blur-md" onclick="closeModal('auditModal')">
                <div class="bg-white rounded-[2.5rem] w-full max-w-4xl h-[80vh] overflow-hidden shadow-2xl flex flex-col" onclick="event.stopPropagation()">
                    <div class="bg-slate-50 p-6 border-b border-slate-100 flex justify-between items-center">
                        <h3 class="font-black uppercase tracking-tighter text-slate-900">Auditoria de Estoque</h3>
                        <button onclick="closeModal('auditModal');" class="text-slate-400 hover:text-rose-500 bg-transparent border-none cursor-pointer"><i data-lucide="x"></i></button>
                    </div>
                    <div class="p-6 bg-slate-100 border-b border-slate-200 flex gap-4 items-center">
                        <input type="text" id="auditInput" onchange="handleAuditScan(this.value)" placeholder="BIPAR C√ìDIGO..." class="flex-1 bg-white border-2 border-slate-200 rounded-xl px-4 py-3 font-bold uppercase text-xs outline-none focus:border-amber-500 transition-all">
                        <button onclick="finishAudit()" class="bg-amber-500 text-white px-6 py-3 rounded-xl font-bold uppercase text-xs tracking-widest shadow-lg hover:bg-amber-600 transition-all">Finalizar</button>
                    </div>
                    <div class="flex-1 overflow-hidden flex flex-col md:flex-row">
                        <div class="flex-1 p-6 overflow-y-auto custom-scrollbar border-r border-slate-100 bg-rose-50/30">
                            <h4 class="font-black text-rose-500 uppercase text-xs mb-4 flex justify-between">Itens Faltantes <span id="auditMissingCount" class="bg-rose-100 px-2 py-0.5 rounded-full">0</span></h4>
                            <div id="auditMissingList" class="space-y-2"></div>
                        </div>
                        <div class="flex-1 p-6 overflow-y-auto custom-scrollbar bg-emerald-50/30">
                            <h4 class="font-black text-emerald-600 uppercase text-xs mb-4 flex justify-between">Itens Encontrados <span id="auditFoundCount" class="bg-emerald-100 px-2 py-0.5 rounded-full">0</span></h4>
                            <div id="auditFoundList" class="space-y-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="itemHistoryModal" class="fixed inset-0 bg-slate-900/90 hidden z-[850] flex items-center justify-center p-4 backdrop-blur-md" onclick="closeModal('itemHistoryModal')">
                <div class="bg-white rounded-[2.5rem] w-full max-w-md overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
                    <div class="bg-slate-50 p-6 border-b border-slate-100 flex justify-between items-center">
                        <h3 class="font-black uppercase tracking-tighter text-slate-900">Hist√≥rico do Item</h3>
                        <button onclick="closeModal('itemHistoryModal');" class="text-slate-400 hover:text-rose-500 bg-transparent border-none cursor-pointer"><i data-lucide="x"></i></button>
                    </div>
                    <div class="p-8 max-h-[70vh] overflow-y-auto custom-scrollbar" id="itemHistoryContent">
                        <!-- Content will be injected here -->
                    </div>
                </div>
            </div>

            <div id="pinModal" class="fixed inset-0 bg-slate-900/90 hidden z-[970] flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeModal('pinModal')">
                <div class="bg-white rounded-[2rem] p-8 w-full max-w-sm text-center shadow-2xl" onclick="event.stopPropagation()">
                    <div class="w-16 h-16 bg-slate-100 text-slate-600 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="lock" size="32"></i></div>
                    <h3 class="text-lg font-black text-slate-900 uppercase mb-2">Acesso Restrito</h3>
                    <p class="text-slate-500 text-sm mb-6">Esta a√ß√£o requer autoriza√ß√£o. Digite o PIN de administrador para continuar.</p>
                    <input type="password" id="pinInputModal" placeholder="****" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 font-bold text-center text-lg outline-none focus:border-blue-500 transition-all mb-6">
                    <div class="flex gap-3">
                        <button onclick="closeModal('pinModal')" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold uppercase text-[10px] cursor-pointer border-none">Cancelar</button>
                        <button onclick="validatePin()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold uppercase text-[10px] cursor-pointer border-none shadow-lg hover:bg-blue-700 transition-all">Confirmar</button>
                    </div>
                </div>
            </div>

            <main id="section-tests-old" class="hidden">
                <div class="max-w-[1400px] mx-auto">
                    <!-- Header Testes -->
                    <div class="bg-[#0B1120] rounded-[2.5rem] p-8 mb-10 shadow-2xl relative overflow-hidden border border-slate-800">
                        <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-blue-600/20 rounded-full blur-[100px] -mr-32 -mt-32 pointer-events-none"></div>
                        <div class="absolute bottom-0 left-0 w-[400px] h-[400px] bg-indigo-600/10 rounded-full blur-[80px] -ml-20 -mb-20 pointer-events-none"></div>
                        <div class="relative z-10 flex items-center gap-4">
                            <div class="p-3 bg-blue-600/20 rounded-2xl border border-blue-500/30 text-blue-400">
                                <i data-lucide="beaker" size="28"></i>
                            </div>
                            <div>
                                <h2 class="text-3xl font-black text-white uppercase tracking-tighter leading-none">Testes de Funcionalidade</h2>
                                <p class="text-slate-400 text-sm font-medium mt-1">Verifica√ß√£o de alertas e sistema</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-8 rounded-2xl shadow-lg border border-slate-100 space-y-4">
                        <p class="text-slate-600">Use os bot√µes abaixo para simular cen√°rios espec√≠ficos e testar as funcionalidades de alerta do sistema.</p>
                        <div class="flex gap-4 pt-4 flex-wrap">
                            <button onclick="simulateOverdue()" class="bg-yellow-500 text-white px-4 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg text-[10px] uppercase tracking-widest hover:bg-yellow-600 transition-all border-none cursor-pointer"><i data-lucide="clock" size="16"></i> Simular Atraso de 24h</button>
                            <button onclick="stopSimulation()" class="bg-slate-500 text-white px-4 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg text-[10px] uppercase tracking-widest hover:bg-slate-600 transition-all border-none cursor-pointer"><i data-lucide="x-circle" size="16"></i> Parar Simula√ß√£o</button>
                        </div>
                    </div>
                </div>
            </main>

            <div id="maintenanceModal" class="fixed inset-0 bg-slate-900/90 hidden z-[800] flex items-center justify-center p-4 backdrop-blur-md" onclick="closeModal('maintenanceModal')">
                <div class="bg-white rounded-[2.5rem] w-full max-w-2xl overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
                    <div class="bg-slate-50 p-6 border-b border-slate-100 flex justify-between items-center">
                        <h3 class="font-black uppercase tracking-tighter text-slate-900">Reportar Manuten√ß√£o</h3>
                        <button onclick="closeModal('maintenanceModal'); event.stopPropagation();" class="text-slate-400 hover:text-rose-500 bg-transparent border-none cursor-pointer"><i data-lucide="x"></i></button>
                    </div>
                    <div class="p-8">
                        <div id="step-selecionar-ferramenta">
                            <p class="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-widest">1. Qual ferramenta quebrou?</p>
                            <div class="relative mb-4">
                                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size="16"></i>
                                <input type="text" id="maintenanceToolSearchInput" onkeyup="handleSearchInput(this, () => openMaintenanceModal(true))" placeholder="BUSCAR POR NOME, C√ìDIGO OU MARCA..." class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl pl-12 pr-10 py-3 font-bold uppercase text-xs outline-none focus:border-blue-500 transition-all">
                                <button onclick="clearSearch('maintenanceToolSearchInput', () => openMaintenanceModal(true))" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-rose-500 hidden z-10"><i data-lucide="x-circle" size="16"></i></button>
                            </div>
                            <div id="toolGridMaintenance" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 max-h-[55vh] overflow-y-auto p-1 custom-scrollbar"></div>
                        </div>
                        <div id="step-detalhes-manutencao" class="hidden">
                            <p class="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-widest">2. Detalhes do problema</p>
                            <div id="selectedToolMaintenance" class="mb-4"></div>
                            <div id="maintenanceQtyContainer" class="hidden mb-4">
                                <div class="flex justify-between items-center ml-4 mb-1">
                                    <label for="maintenanceQtyInput" class="text-[10px] font-black uppercase text-slate-400">Quantidade para Manuten√ß√£o</label>
                                    <span id="maintenanceMaxQty" class="text-[10px] font-bold text-slate-400"></span>
                                </div>
                                <input type="number" id="maintenanceQtyInput" value="1" min="1" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 font-bold text-xs outline-none focus:border-red-500 transition-all">
                            </div>
                            <textarea id="maintenanceNoteInput" placeholder="Descreva o problema ou o motivo da manuten√ß√£o..." class="w-full h-24 border-2 border-slate-100 rounded-xl p-3 font-medium text-sm outline-none focus:border-red-500 transition-all"></textarea>
                            <div class="flex gap-3 mt-4">
                                <button onclick="resetMaintenance()" class="flex-1 py-4 bg-slate-100 text-slate-500 rounded-2xl font-black uppercase text-[10px] cursor-pointer border-none">Voltar</button>
                                <button id="btnFinalizeMaintenance" class="flex-1 py-4 bg-red-600 text-white rounded-2xl font-black uppercase text-[10px] shadow-lg border-none cursor-pointer hover:bg-red-700">Confirmar Manuten√ß√£o</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="materialModal" class="fixed inset-0 bg-slate-900/90 hidden z-[800] flex items-center justify-center p-4 backdrop-blur-md" onclick="closeModal('materialModal')">
                <div class="bg-white rounded-[2.5rem] w-full max-w-2xl overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
                    <div class="bg-slate-50 p-6 border-b border-slate-100 flex justify-between items-center gap-4">
                        <h3 id="materialModalTitle" class="font-black uppercase tracking-tighter text-slate-900">Sa√≠da de Ferramentas</h3>
                        <div class="flex-1 flex justify-end gap-2">
                            <input type="text" id="barcodeInput" class="absolute -left-[9999px]" onchange="handleBarcodeScan(this.value)">
                            <button onclick="focusBarcode()" class="bg-white border-2 border-slate-200 text-slate-500 px-3 py-2 rounded-lg font-bold flex items-center gap-2 text-[10px] uppercase hover:bg-slate-100 transition-all"><i data-lucide="barcode" size="14"></i> Bipar</button>
                            <button onclick="startQrScanner()" class="bg-white border-2 border-slate-200 text-slate-500 px-3 py-2 rounded-lg font-bold flex items-center gap-2 text-[10px] uppercase hover:bg-slate-100 transition-all"><i data-lucide="qr-code" size="14"></i> QR Code</button>
                        </div>
                        <button onclick="closeModal('materialModal'); event.stopPropagation();" class="text-slate-400 hover:text-rose-500 bg-transparent border-none cursor-pointer"><i data-lucide="x"></i></button>
                    </div>
                    <div class="p-8">
                        <div id="qrScannerContainer" class="hidden">
                            <div id="qr-reader" class="w-full rounded-xl overflow-hidden border-2 border-slate-200"></div>
                        </div>
                        <div id="step-material-tool" class="">
                            <p id="materialModalStep1" class="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-widest">1. Qual item ser√° retirado?</p>
                            <div class="relative mb-4">
                                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size="16"></i>
                                <input type="text" id="materialSearchInput" onkeyup="handleSearchInput(this, () => openMaterialModal(true))" placeholder="BUSCAR POR NOME, C√ìDIGO OU MARCA..." class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl pl-12 pr-10 py-3 font-bold uppercase text-xs outline-none focus:border-blue-500 transition-all">
                                <button onclick="clearSearch('materialSearchInput', () => openMaterialModal(true))" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-rose-500 hidden z-10"><i data-lucide="x-circle" size="16"></i></button>
                            </div>
                            <div id="toolGridMaterial" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 max-h-[55vh] overflow-y-auto p-1 custom-scrollbar"></div>
                        </div>
                        <div id="step-material-qty" class="hidden text-center py-6">
                            <p class="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-widest">2. Qual a quantidade?</p>
                            <div id="selectedToolMaterial" class="mb-6"></div>
                            <input type="number" id="materialQtyInput" placeholder="QTD" class="w-32 text-center border-2 border-slate-200 rounded-xl px-4 py-3 font-black text-lg outline-none focus:border-blue-500 transition-all">
                            <div class="flex gap-3 mt-6">
                                <button onclick="resetMaterial(0)" class="flex-1 py-4 bg-slate-100 text-slate-500 rounded-2xl font-black uppercase text-[10px] cursor-pointer border-none">Voltar</button>
                                <button onclick="processQtyStep()" class="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-black uppercase text-[10px] shadow-lg border-none cursor-pointer hover:bg-blue-700">Avan√ßar</button>
                            </div>
                        </div>
                        <div id="step-material-worker" class="hidden">
                            <p class="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-widest">3. Quem est√° retirando?</p>
                            <div id="teamGridMaterial" class="grid grid-cols-2 sm:grid-cols-3 gap-3 max-h-64 overflow-y-auto pr-2 custom-scrollbar"></div>
                                <button onclick="resetMaterial(1)" class="w-full mt-4 py-3 bg-slate-100 text-slate-500 rounded-xl font-black uppercase text-[10px] cursor-pointer border-none">Voltar</button>
                        </div>
                        <div id="step-material-confirm" class="hidden text-center py-6">
                            <div id="confirmationDetails" class="mb-6"></div>
                            <h4 class="text-xl font-black text-slate-900 uppercase mb-8">Confirmar Retirada?</h4>
                            <div class="flex gap-3">
                                    <button onclick="resetMaterial(2)" class="flex-1 py-4 bg-slate-100 text-slate-500 rounded-2xl font-black uppercase text-[10px] cursor-pointer border-none">Voltar</button>
                                    <button id="btnFinalizeMaterial" class="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black uppercase text-[10px] shadow-lg border-none cursor-pointer hover:bg-indigo-700">Confirmar Sa√≠da</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="checkinModal" class="fixed inset-0 bg-slate-900/90 hidden z-[800] flex items-center justify-center p-4 backdrop-blur-md" onclick="closeModal('checkinModal')">
                <div class="bg-white rounded-[2.5rem] w-full max-w-2xl overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
                    <div class="bg-slate-50 p-6 border-b border-slate-100 flex justify-between items-center gap-4">
                        <h3 class="font-black uppercase tracking-tighter text-slate-900">Devolu√ß√£o de Ferramentas</h3>
                        <div class="flex-1 flex justify-end gap-2">
                            <input type="text" id="checkinBarcodeInput" class="absolute -left-[9999px]" onchange="handleCheckinBarcodeScan(this.value)">
                            <button onclick="focusCheckinBarcode()" class="bg-white border-2 border-slate-200 text-slate-500 px-3 py-2 rounded-lg font-bold flex items-center gap-2 text-[10px] uppercase hover:bg-slate-100 transition-all"><i data-lucide="barcode" size="14"></i> Bipar</button>
                            <button onclick="startCheckinQrScanner()" class="bg-white border-2 border-slate-200 text-slate-500 px-3 py-2 rounded-lg font-bold flex items-center gap-2 text-[10px] uppercase hover:bg-slate-100 transition-all"><i data-lucide="qr-code" size="14"></i> QR Code</button>
                        </div>
                        <button onclick="closeModal('checkinModal');" class="text-slate-400 hover:text-rose-500 bg-transparent border-none cursor-pointer"><i data-lucide="x"></i></button>
                    </div>
                    <div class="p-8">
                        <div id="checkinQrScannerContainer" class="hidden">
                            <div id="checkin-qr-reader" class="w-full rounded-xl overflow-hidden border-2 border-slate-200"></div>
                            <button onclick="stopCheckinQrScanner()" class="w-full mt-4 py-3 bg-slate-100 text-slate-500 rounded-xl font-black uppercase text-[10px] cursor-pointer border-none">Cancelar C√¢mera</button>
                        </div>
                        <div id="checkin-step-list">
                            <p class="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-widest">Selecione o item para devolver:</p>
                            <div class="relative mb-4">
                                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size="16"></i>
                                <input type="text" id="checkinSearchInput" onkeyup="handleSearchInput(this, () => openCheckinModal(true))" placeholder="BUSCAR POR NOME, C√ìDIGO OU RESPONS√ÅVEL..." class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl pl-12 pr-10 py-3 font-bold uppercase text-xs outline-none focus:border-blue-500 transition-all">
                                <button onclick="clearSearch('checkinSearchInput', () => openCheckinModal(true))" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-rose-500 hidden z-10"><i data-lucide="x-circle" size="16"></i></button>
                            </div>
                            <div id="toolGridCheckin" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 max-h-[55vh] overflow-y-auto p-1 custom-scrollbar"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="manageMaintenanceModal" class="fixed inset-0 bg-slate-900/90 hidden z-[850] flex items-center justify-center p-4 backdrop-blur-md" onclick="closeModal('manageMaintenanceModal')">
                <div class="bg-white rounded-[2.5rem] w-full max-w-3xl overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
                    <div class="bg-slate-50 p-6 border-b border-slate-100 flex justify-between items-center">
                        <div>
                            <h3 class="font-black uppercase tracking-tighter text-slate-900">Gerenciar Manuten√ß√£o</h3>
                            <p id="maintenanceToolName" class="text-xs font-bold text-slate-500 uppercase"></p>
                        </div>
                        <button onclick="closeModal('manageMaintenanceModal');" class="text-slate-400 hover:text-rose-500 bg-transparent border-none cursor-pointer"><i data-lucide="x"></i></button>
                    </div>
                    <div class="p-8 max-h-[80vh] overflow-y-auto custom-scrollbar">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                            <!-- Coluna de Informa√ß√µes -->
                            <div class="md:col-span-1">
                                <div id="maintenanceToolInfo" class="text-center"></div>
                                <div id="maintenanceStatusTimeline" class="mt-8">
                                    <!-- Stepper Timeline -->
                                    <ol class="relative border-l-2 border-slate-100 ml-4">                  
                                        <li id="timeline-step-1" class="mb-5 ml-8">            
                                            <span class="absolute flex items-center justify-center w-8 h-8 bg-slate-100 rounded-full -left-4"><i data-lucide="flag" size="16" class="text-slate-500"></i></span>
                                            <h3 class="font-black text-slate-700">Reportado</h3>
                                        </li>
                                        <li id="timeline-step-2" class="mb-5 ml-8">
                                            <span class="absolute flex items-center justify-center w-8 h-8 bg-slate-100 rounded-full -left-4"><i data-lucide="clipboard-list" size="16" class="text-slate-500"></i></span>
                                            <h3 class="font-black text-slate-700">Or√ßamento</h3>
                                        </li>
                                        <li id="timeline-step-3" class="mb-5 ml-8">
                                            <span class="absolute flex items-center justify-center w-8 h-8 bg-slate-100 rounded-full -left-4"><i data-lucide="check-check" size="16" class="text-slate-500"></i></span>
                                            <h3 class="font-black text-slate-700">em conserto</h3>
                                        </li>
                                        <li id="timeline-step-4" class="ml-8">
                                            <span class="absolute flex items-center justify-center w-8 h-8 bg-slate-100 rounded-full -left-4"><i data-lucide="package-check" size="16" class="text-slate-500"></i></span>
                                            <h3 class="font-black text-slate-700">finalizado</h3>
                                        </li>
                                    </ol>
                                </div>
                            </div>

                            <!-- Coluna de A√ß√µes -->
                            <div id="maintenanceActions" class="md:col-span-2 space-y-6">
                                <!-- Passo 1: Registrar Or√ßamento -->
                                <div id="maintenance-step-quote" class="hidden">
                                    <h4 class="font-black uppercase text-slate-600 mb-3">Registrar Or√ßamento</h4>
                                    <div class="space-y-4">
                                        <div>
                                            <label for="quoteProviderInput" class="text-[10px] font-black uppercase text-slate-400 ml-4">Fornecedor</label>
                                            <input type="text" id="quoteProviderInput" placeholder="NOME DA EMPRESA/FORNECEDOR" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 font-bold uppercase text-xs outline-none focus:border-blue-500 h-[47px]">
                                        </div>
                                        <div>
                                            <label for="quoteCostInput" class="text-[10px] font-black uppercase text-slate-400 ml-4">Custo (R$)</label>
                                            <input type="number" id="quoteCostInput" placeholder="350,00" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 font-bold text-xs outline-none focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label for="quoteNoteInput" class="text-[10px] font-black uppercase text-slate-400 ml-4">Detalhes do Or√ßamento</label>
                                            <textarea id="quoteNoteInput" placeholder="Descreva os detalhes do or√ßamento..." class="w-full h-20 border-2 border-slate-100 rounded-xl p-3 font-medium text-sm outline-none focus:border-blue-500"></textarea>
                                        </div>
                                        <button id="btnSaveQuote" class="w-full mt-4 py-3 bg-blue-600 text-white rounded-xl font-black uppercase text-xs shadow-lg hover:bg-blue-700">Salvar Or√ßamento</button>
                                    </div>
                                </div>

                                <!-- Passo 2: Aprovar Or√ßamento -->
                                <div id="maintenance-step-approval" class="hidden">
                                    <h4 class="font-black uppercase text-slate-600 mb-3">Aprova√ß√£o do Or√ßamento</h4>
                                    <div id="quoteDetailsDisplay" class="bg-slate-50 p-4 rounded-xl space-y-3 mb-4"></div>
                                    <div class="flex gap-3">
                                        <button id="btnRejectRepair" class="flex-1 py-3 bg-rose-600 text-white rounded-xl font-bold uppercase text-[10px] shadow-lg hover:bg-rose-700">Recusar</button>
                                        <button id="btnApproveRepair" class="flex-1 py-3 bg-emerald-500 text-white rounded-xl font-bold uppercase text-[10px] shadow-lg hover:bg-emerald-600">Aprovar Conserto</button>
                                    </div>
                                </div>

                                <!-- Passo 3: Finalizar Conserto -->
                                <div id="maintenance-step-finish" class="hidden">
                                    <h4 class="font-black uppercase text-slate-600 mb-3">Finalizar Conserto</h4>
                                    <div class="space-y-4">                                        
                                        <div class="mt-1">
                                            <label class="text-[10px] font-black uppercase text-slate-400 ml-4">Anexar Nota Fiscal (PDF/Imagem)</label>
                                            <label for="invoiceFileInput" id="drop-area" class="mt-1 flex justify-center w-full h-32 px-4 transition bg-white border-2 border-slate-200 border-dashed rounded-xl appearance-none cursor-pointer hover:border-blue-400 focus:outline-none">
                                                <span class="flex items-center space-x-2">
                                                    <i data-lucide="upload-cloud" class="text-slate-500"></i>
                                                    <span class="font-medium text-slate-600">
                                                        <span id="drop-area-text">Arraste o arquivo ou <span class="text-blue-600 underline">clique para selecionar</span></span>
                                                        <span id="file-name-display" class="hidden font-bold text-emerald-600"></span>
                                                    </span>
                                                </span>
                                                <input type="file" id="invoiceFileInput" name="file_upload" class="hidden" accept="image/*,application/pdf">
                                            </label>
                                        </div>
                                        <p class="text-sm text-slate-500">A manuten√ß√£o foi conclu√≠da e o item pode voltar ao estoque como "Dispon√≠vel"?</p>
                                    </div>
                                    <div class="flex gap-3 mt-4">
                                        <button id="btnBackToQuote" class="flex-1 py-3 bg-amber-500 text-white rounded-xl font-bold uppercase text-[10px] shadow-lg hover:bg-amber-600">N√£o, refazer or√ßamento</button>
                                        <button id="btnFinishRepair" class="flex-1 py-3 bg-emerald-500 text-white rounded-xl font-bold uppercase text-[10px] shadow-lg hover:bg-emerald-600">Sim, Finalizar</button>
                                    </div>
                                </div>
                                <!-- Passo 4: Concluir Manuten√ß√£o -->
                                <div id="maintenance-step-conclude" class="hidden">
                                    <h4 class="font-black uppercase text-slate-600 mb-3">Conclus√£o</h4>
                                    <div class="space-y-4">
                                        <div id="invoiceDisplay" class="hidden">
                                            <!-- Invoice link will be inserted here -->
                                        </div>
                                        <p class="text-sm text-slate-500">O processo de manuten√ß√£o foi finalizado. O item est√° pronto para retornar ao estoque?</p>
                                        <button id="btnConcludeMaintenance" class="w-full py-3 bg-blue-600 text-white rounded-xl font-black uppercase text-[10px] shadow-lg hover:bg-blue-700">Retornar ao Estoque</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="workerDetailsModal" class="fixed inset-0 bg-slate-900/90 hidden z-[850] flex items-center justify-center p-4 backdrop-blur-md" onclick="closeModal('workerDetailsModal')">
                <div class="bg-white rounded-[2.5rem] w-full max-w-md overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
                    <div class="bg-slate-50 p-6 border-b border-slate-100 flex justify-between items-center">
                        <h3 class="font-black uppercase tracking-tighter text-slate-900">Detalhes do Colaborador</h3>
                        <button onclick="closeModal('workerDetailsModal');" class="text-slate-400 hover:text-rose-500 bg-transparent border-none cursor-pointer"><i data-lucide="x"></i></button>
                    </div>
                    <div class="p-8" id="workerDetailsContent">
                        <!-- Content will be injected here -->
                    </div>
                </div>
            </div>

            <div id="overdueModal" class="fixed inset-0 bg-slate-900/90 hidden z-[800] flex items-center justify-center p-4 backdrop-blur-md" onclick="closeModal('overdueModal')">
                <div class="bg-white rounded-[2.5rem] w-full max-w-2xl overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
                    <div class="bg-rose-50 p-6 border-b border-rose-100 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <i data-lucide="alert-triangle" class="text-rose-600"></i>
                            <h3 class="font-black uppercase tracking-tighter text-rose-900">Ferramentas com Devolu√ß√£o Atrasada</h3>
                        </div>
                        <button onclick="closeModal('overdueModal'); event.stopPropagation();" class="text-rose-400 hover:text-rose-600 bg-transparent border-none cursor-pointer"><i data-lucide="x"></i></button>
                    </div>
                    <div id="overdueList" class="p-8 max-h-[70vh] overflow-y-auto custom-scrollbar">
                        <!-- Overdue items will be rendered here -->
                    </div>
                </div>
            </div>

            <script>
                // --- CONFIGURA√á√ÉO DE NUVEM (JSONBIN.IO) ---
                // Substitua os valores abaixo pelos que voc√™ pegou no site jsonbin.io
                const BIN_ID = '695fb641ae596e708fcda778'; 
                const API_KEY = '$2a$10$T1Y5zeImcBOV2FVqLHbyQeOcqVpPQIaJWn2NxVbtFZF8akzuwjxNy';
                // ------------------------------------------

                let tools = JSON.parse(localStorage.getItem('ldc_pro_db')) || [];
                let team = JSON.parse(localStorage.getItem('ldc_team_db')) || [];
                // Remove Almoxarifado legado se existir
                team = team.filter(w => w.id !== 1 && w.name !== 'ALMOXARIFADO');

                let history = JSON.parse(localStorage.getItem('ldc_history_db')) || [];
                let appSettings = JSON.parse(localStorage.getItem('ldc_settings_db')) || { overdueHours: 24, systemSounds: true };
                let auditSession = { missing: [], found: [] };

                // Timestamp para controle de concorr√™ncia (evita sobrescrever dados novos com velhos da nuvem)
                let lastLocalUpdate = Date.now();
                let lastCloudSaveTime = 0; // Timestamp do √∫ltimo salvamento na nuvem bem-sucedido
                let hasUnsavedChanges = false; // Indica se temos dados locais que falharam ao subir pra nuvem

                // Fun√ß√£o para carregar dados da nuvem ao abrir
                async function loadFromCloud() {
                    if (BIN_ID === 'SEU_BIN_ID_AQUI') return; // N√£o configurado
                    if (isSaving) return; // N√£o carrega se estiver salvando

                    // Se temos altera√ß√µes locais que ainda n√£o foram salvas na nuvem (ex: erro de rede ou tamanho),
                    // N√ÉO baixamos da nuvem para n√£o perder o trabalho feito.
                    if (hasUnsavedChanges) return;

                    // Prote√ß√£o: N√£o atualiza se houver algum modal aberto para n√£o atrapalhar edi√ß√µes em andamento
                    const openModals = document.querySelectorAll('.fixed.inset-0:not(.hidden)');
                    if (openModals.length > 0) {
                        return;
                    }

                    // Prote√ß√£o: Se salvamos na nuvem recentemente (√∫ltimos 5s), evitamos baixar dados
                    // para n√£o pegar uma vers√£o desatualizada (cache ou propaga√ß√£o do servidor)
                    if (Date.now() - lastCloudSaveTime < 5000) return;

                    const fetchStart = Date.now(); // Marca o in√≠cio da requisi√ß√£o

                    try {
                        const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                            headers: { 'X-Master-Key': API_KEY },
                            cache: 'no-store' // Garante que n√£o estamos pegando cache do navegador
                        });
                        if (res.ok) {
                            const data = await res.json();

                            // Se houve altera√ß√£o local enquanto baixava, ignora este download para n√£o sobrescrever
                            if (lastLocalUpdate > fetchStart) return;
                            // Verifica novamente se abriu modal durante o download
                            if (document.querySelectorAll('.fixed.inset-0:not(.hidden)').length > 0) return;

                            if (isSaving) return; // Verifica novamente antes de aplicar
                            if (data.record) {
                                tools = data.record.tools || [];
                                team = data.record.team || team;
                                history = data.record.history || [];
                                save(false); // Salva localmente e atualiza a tela (false para n√£o reenviar pra nuvem)
                            }
                        }
                    } catch (e) { console.error("Erro ao carregar da nuvem", e); }
                }
                
                let currentImageBase64 = "";
                let pendingStatus = "disponivel";
                let catalogFilter = 'all';
                let maintenanceFilter = 'all';
                let itemToDeleteId = null;
                let itemToReturnId = null;
                let itemToManageMaintenanceId = null;
                let historyItemToDeleteId = null;
                let maintenanceData = { toolId: null };
                let materialData = { toolId: null, workerId: null, qty: null };
                let zoomState = { level: 1, isPanning: false, startX: 0, startY: 0, translateX: 0, translateY: 0 };
                let qrScanner = null;
                let historyDatePicker = null;

                const formatBRL = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);
                const capitalize = (s) => {
                    if (typeof s !== 'string' || !s) return '';
                    return s.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
                };

                let isSaving = false;

                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

                function playSound(type) {
                    if (appSettings.systemSounds === false) return;
                    if (audioCtx.state === 'suspended') audioCtx.resume();

                    const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioCtx.destination);

                    const now = audioCtx.currentTime;

                    if (type === 'click') {
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(600, now);
                        oscillator.frequency.exponentialRampToValueAtTime(300, now + 0.05);
                        gainNode.gain.setValueAtTime(0.03, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                        oscillator.start(now);
                        oscillator.stop(now + 0.05);
                    } else if (type === 'type') {
                        // Som de digita√ß√£o simples e seco (Click)
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(800, now);
                        oscillator.frequency.exponentialRampToValueAtTime(100, now + 0.05);
                        
                        gainNode.gain.setValueAtTime(0.05, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                        
                        oscillator.start(now);
                        oscillator.stop(now + 0.05);
                    } else if (type === 'delete') {
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(300, now);
                        oscillator.frequency.exponentialRampToValueAtTime(200, now + 0.05);
                        gainNode.gain.setValueAtTime(0.02, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                        oscillator.start(now);
                        oscillator.stop(now + 0.05);
                    } else if (type === 'open') {
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(400, now);
                        oscillator.frequency.exponentialRampToValueAtTime(600, now + 0.1);
                        gainNode.gain.setValueAtTime(0.03, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                        oscillator.start(now);
                        oscillator.stop(now + 0.1);
                    } else if (type === 'success') {
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(500, now);
                        oscillator.frequency.linearRampToValueAtTime(1000, now + 0.1);
                        gainNode.gain.setValueAtTime(0.05, now);
                        gainNode.gain.linearRampToValueAtTime(0.001, now + 0.3);
                        oscillator.start(now);
                        oscillator.stop(now + 0.3);
                    } else if (type === 'error') {
                        oscillator.type = 'triangle';
                        oscillator.frequency.setValueAtTime(150, now);
                        oscillator.frequency.linearRampToValueAtTime(100, now + 0.15);
                        gainNode.gain.setValueAtTime(0.1, now);
                        gainNode.gain.linearRampToValueAtTime(0.001, now + 0.15);
                        oscillator.start(now);
                        oscillator.stop(now + 0.15);
                    }
                }

                async function save(syncToCloud = true) { 
                    isSaving = true;
                    lastLocalUpdate = Date.now(); // Atualiza timestamp da modifica√ß√£o local
                    if (syncToCloud) hasUnsavedChanges = true; // Marca como n√£o salvo at√© confirmar o sucesso

                    try {
                        localStorage.setItem('ldc_pro_db', JSON.stringify(tools)); 
                        localStorage.setItem('ldc_team_db', JSON.stringify(team));
                        localStorage.setItem('ldc_history_db', JSON.stringify(history));
                        localStorage.setItem('ldc_settings_db', JSON.stringify(appSettings));
                    } catch (e) {
                        console.error("Erro ao salvar no LocalStorage", e);
                        document.getElementById('alertModalTitle').innerText = "Erro de Armazenamento";
                        document.getElementById('alertModalText').innerText = "Espa√ßo de armazenamento cheio! N√£o foi poss√≠vel salvar as altera√ß√µes. Tente remover itens antigos ou imagens pesadas.";
                        openModal('alertModal');
                        isSaving = false;
                        return;
                    }
                    
                    // Salvar na nuvem (apenas se syncToCloud for true)
                    if (syncToCloud && BIN_ID !== 'SEU_BIN_ID_AQUI') {
                        try {
                            const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                                body: JSON.stringify({ tools, team, history })
                            });
                            
                            if (res.ok) {
                                lastCloudSaveTime = Date.now();
                                hasUnsavedChanges = false; // Sucesso! Estamos sincronizados.
                            } else {
                                console.error("Erro ao salvar na nuvem:", res.status);
                                if (res.status === 413) {
                                    alert("ERRO: O arquivo √© muito grande para ser salvo na nuvem. Tente usar uma imagem menor ou comprimida.");
                                }
                                // Mant√©m hasUnsavedChanges = true, o que bloqueia o loadFromCloud e evita o "vai e volta"
                            }
                        } catch (e) { 
                            console.error("Erro de rede ao salvar", e); 
                            // Mant√©m hasUnsavedChanges = true
                        }
                    }

                    render(); 
                    renderCatalog(); 
                    renderHistory(); 
                    renderMaintenance(); 
                    renderOverdueAlert();
                    renderTeam(); 
                    isSaving = false;
                }

                function handleSearchInput(input, renderCallback) {
                    const clearBtn = input.nextElementSibling;
                    if (clearBtn && clearBtn.tagName === 'BUTTON') {
                        clearBtn.classList.toggle('hidden', !input.value);
                    }
                    renderCallback();
                }

                function clearSearch(inputId, renderCallback) {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.value = '';
                        input.nextElementSibling.classList.add('hidden');
                        renderCallback();
                        input.focus();
                    }
                }

                function showSection(s) {
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.main-content').forEach(c => c.classList.remove('active-section'));
                    document.getElementById(`btn-${s}`).classList.add('active');
                    const section = document.getElementById(`section-${s}`);
                    if (section) {
                        if (qrScanner) stopQrScanner();
                        section.classList.add('active-section');
                    }
                    if (s === 'catalog') {
                        renderCatalog();
                        renderOverdueAlert();
                    }
                    if (s === 'logs') renderHistory();
                    if (s === 'maintenance') renderMaintenance();
                    if (s === 'team') renderTeam();
                    if (s === 'settings') loadSettingsUI();
                    render();
                    playSound('click');
                }

                function toggleSidebar() { 
                    document.getElementById('sidebar').classList.toggle('collapsed'); 
                    document.querySelectorAll('.sidebar-text').forEach(e => e.classList.toggle('hidden')); 
                }

                function openModal(id) { 
                    document.getElementById(id).classList.remove('hidden');
                    playSound('open');
                }
                function closeModal(id) { 
                    const modal = document.getElementById(id);
                    if (modal) modal.classList.add('hidden');
                    if (id === 'materialModal' && qrScanner) stopQrScanner();
                    if (id === 'checkinModal' && qrScanner) stopCheckinQrScanner();
                    
                    if (id === 'zoomModal') {
                        const zoomModal = document.getElementById('zoomModal');
                        zoomModal.onmousemove = null;
                        zoomModal.onmouseup = null;
                        zoomModal.onmouseleave = null;
                        document.getElementById('zoomContainer').onwheel = null;
                    }
                    playSound('click');
                }

                let currentWorkerType = 'LDC';

                function selectWorkerType(type) {
                    currentWorkerType = type;
                    const ldcCard = document.getElementById('type-card-ldc');
                    const terceiroCard = document.getElementById('type-card-terceiro');
                    const ldcIndicator = document.getElementById('indicator-ldc');
                    const terceiroIndicator = document.getElementById('indicator-terceiro');
                    const ldcText = document.getElementById('text-ldc');
                    const terceiroText = document.getElementById('text-terceiro');
                    const companyLabel = document.getElementById('workerCompanyLabel');
                    const companyInput = document.getElementById('workerCompanyInput');

                    if (type === 'LDC') {
                        // Active LDC
                        ldcCard.className = "flex-1 cursor-pointer bg-blue-50 border-2 border-blue-500 rounded-2xl p-4 flex flex-col items-center justify-center gap-2 transition-all shadow-md group relative overflow-hidden";
                        ldcIndicator.className = "absolute top-3 right-3 w-2.5 h-2.5 bg-blue-500 rounded-full transition-colors";
                        ldcText.className = "font-black text-blue-900 text-[10px] uppercase tracking-widest";
                        
                        // Inactive Terceiro
                        terceiroCard.className = "flex-1 cursor-pointer bg-white border-2 border-slate-100 rounded-2xl p-4 flex flex-col items-center justify-center gap-2 transition-all hover:border-slate-300 hover:shadow-md group relative overflow-hidden";
                        terceiroIndicator.className = "absolute top-3 right-3 w-2.5 h-2.5 bg-slate-200 rounded-full transition-colors";
                        terceiroText.className = "font-black text-slate-400 text-[10px] uppercase tracking-widest";

                        companyLabel.innerText = "Matr√≠cula";
                        companyInput.placeholder = "000000";
                    } else {
                        // Inactive LDC
                        ldcCard.className = "flex-1 cursor-pointer bg-white border-2 border-slate-100 rounded-2xl p-4 flex flex-col items-center justify-center gap-2 transition-all hover:border-blue-200 hover:shadow-md group relative overflow-hidden";
                        ldcIndicator.className = "absolute top-3 right-3 w-2.5 h-2.5 bg-slate-200 rounded-full transition-colors";
                        ldcText.className = "font-black text-slate-400 text-[10px] uppercase tracking-widest";

                        // Active Terceiro
                        terceiroCard.className = "flex-1 cursor-pointer bg-orange-50 border-2 border-orange-500 rounded-2xl p-4 flex flex-col items-center justify-center gap-2 transition-all shadow-md group relative overflow-hidden";
                        terceiroIndicator.className = "absolute top-3 right-3 w-2.5 h-2.5 bg-orange-500 rounded-full transition-colors";
                        terceiroText.className = "font-black text-orange-900 text-[10px] uppercase tracking-widest";

                        companyLabel.innerText = "Centro de Custo";
                        companyInput.placeholder = "CENTRO DE CUSTO";
                    }
                }

                function addWorker() {
                    const nameInput = document.getElementById('workerNameInput');
                    const companyInput = document.getElementById('workerCompanyInput');
                    const name = nameInput.value.trim().toUpperCase();
                    const info = companyInput.value.trim().toUpperCase() || 'N/A';
                    if(!name) return;
                    const dateAdded = new Date().toLocaleDateString('pt-BR');

                    // Salva 'info' (Matr√≠cula ou CC) e 'type' (LDC ou TERCEIRO)
                    team.push({ id: Date.now(), name, info, type: currentWorkerType, dateAdded });
                    
                    nameInput.value = ""; companyInput.value = "";
                    save(); renderTeam();
                    playSound('success');
                }

                function removeWorker(id) {
                    const executeRemove = () => {
                        const worker = team.find(w => w.id === id);
                        if (worker) {
                            const toolsInPossession = tools.filter(t => t.user === worker.name).length;
                            if (toolsInPossession > 0) {
                                document.getElementById('alertModalTitle').innerText = "A√ß√£o Bloqueada";
                                document.getElementById('alertModalText').innerText = `N√£o √© poss√≠vel remover ${worker.name}. Este colaborador ainda possui ${toolsInPossession} ferramenta(s) em sua posse.`;
                                openModal('alertModal');
                                playSound('error');
                                return;
                            }
                            const modal = document.getElementById('deleteModal');
                            modal.querySelector('h3').innerText = `Remover ${worker.name}?`;
                            modal.querySelector('p').innerText = 'Voc√™ tem certeza que deseja remover este colaborador da equipe?';
                            document.getElementById('confirmDeleteBtn').onclick = () => {
                                team = team.filter(w => w.id !== id);
                                closeModal('deleteModal');
                                save();
                                playSound('success');
                            };
                            openModal('deleteModal');
                        }
                    };

                    if (appSettings.adminPin) {
                        requestPin(executeRemove);
                    } else {
                        executeRemove();
                    }
                }

                function renderTeam() {
                    const grid = document.getElementById('teamGrid');
                    if (!grid) return;
                    const search = document.getElementById('teamSearchInput').value.toLowerCase();

                    const filteredTeam = team.filter(w => w.name.toLowerCase().includes(search) || (w.info && w.info.toLowerCase().includes(search)) || (w.company && w.company.toLowerCase().includes(search)));
                    
                    if (filteredTeam.length === 0) {
                        grid.innerHTML = `<p class="text-center text-sm text-slate-400 col-span-full py-20">Nenhum colaborador encontrado.</p>`;
                        return;
                    }

                    grid.innerHTML = filteredTeam.map(w => {
                        // L√≥gica para compatibilidade com dados antigos que usavam 'company'
                        const workerType = w.type || (w.company === 'LDC' ? 'LDC' : 'TERCEIRO');
                        let displayInfo = w.info;
                        if (!displayInfo) {
                             // Fallback para dados antigos
                             displayInfo = w.company || 'N/A';
                        }
                        
                        const typeLabel = workerType === 'LDC' ? 'LDC' : 'Terceiro';
                        const typeColor = workerType === 'LDC' ? 'text-blue-500' : 'text-orange-500';
                        const infoLabel = workerType === 'LDC' ? 'Matr√≠cula' : 'C. Custo';

                        const toolsInPossession = tools.filter(t => t.user === w.name).length;
                        const historyCount = history.filter(h => h.workerName === w.name).length;
                        return `
                        <div onclick="openWorkerDetails(${w.id})" class="bg-slate-50 rounded-2xl p-5 border border-slate-200 flex flex-col relative group hover:border-blue-400 transition-all cursor-pointer hover:shadow-lg hover:-translate-y-1">
                            <div class="absolute top-2 right-2 flex flex-col items-end">
                                <button onclick="removeWorker(${w.id}); event.stopPropagation();" class="p-2 text-slate-400 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity" title="Excluir Colaborador"><i data-lucide="trash-2" size="16"></i></button>
                            </div>
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-12 h-12 ${workerType === 'TERCEIRO' ? 'bg-orange-100 text-orange-600' : 'bg-blue-100 text-blue-600'} rounded-full flex items-center justify-center text-lg font-black">
                                    ${w.name.charAt(0)}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="font-black text-slate-800 uppercase truncate text-sm" title="${w.name}">${w.name}</h3>
                                    <div class="flex items-center gap-2 text-[10px] font-bold text-slate-400 uppercase">
                                        <span class="${typeColor}">${typeLabel}</span>
                                        <span>‚Ä¢</span>
                                        <span class="truncate" title="${infoLabel}: ${displayInfo}">${displayInfo}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-auto pt-4 border-t border-slate-100 grid grid-cols-2 gap-4 text-center"><div><p class="text-[9px] font-black text-slate-400 uppercase">Em Posse</p><p class="text-2xl font-black ${toolsInPossession > 0 ? 'text-orange-500' : 'text-slate-600'}">${toolsInPossession}</p></div><div><p class="text-[9px] font-black text-slate-400 uppercase">Movimenta√ß√µes</p><p class="text-2xl font-black text-slate-600">${historyCount}</p></div></div>
                        </div>
                    `}).join('');
                    lucide.createIcons();
                }

                function openWorkerDetails(id) {
                    const w = team.find(x => x.id === id);
                    if (!w) return;

                    const workerType = w.type || (w.company === 'LDC' ? 'LDC' : 'TERCEIRO');
                    let displayInfo = w.info;
                    if (!displayInfo) {
                         displayInfo = w.company || 'N/A';
                    }
                    
                    const typeLabel = workerType === 'LDC' ? 'LDC' : 'Terceiro';
                    const typeColor = workerType === 'LDC' ? 'text-blue-600 bg-blue-50 border-blue-200' : 'text-orange-600 bg-orange-50 border-orange-200';
                    const infoLabel = workerType === 'LDC' ? 'Matr√≠cula' : 'Centro de Custo';
                    const dateAdded = w.dateAdded || '';

                    const toolsInPossession = tools.filter(t => t.user === w.name);
                    const historyCount = history.filter(h => h.workerName === w.name).length;

                    let toolsHtml = '';
                    if (toolsInPossession.length > 0) {
                        toolsHtml = `
                            <div class="mt-6">
                                <h4 class="text-xs font-bold text-slate-400 uppercase mb-3 tracking-wider">Ferramentas em Posse</h4>
                                <div class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar pr-2">
                                    ${toolsInPossession.map(t => `
                                        <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl border border-slate-100">
                                            <div class="w-8 h-8 bg-white rounded-lg flex items-center justify-center overflow-hidden border border-slate-200">
                                                ${t.img ? `<img src="${t.img}" class="w-full h-full object-cover">` : `<i data-lucide="wrench" class="text-slate-300" size="14"></i>`}
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <p class="text-xs font-bold text-slate-700 truncate">${t.name}</p>
                                                <p class="text-[10px] text-slate-400 font-bold">${t.code || 'S/C'}</p>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    } else {
                        toolsHtml = `
                            <div class="mt-6 p-4 bg-slate-50 rounded-xl border border-slate-100 text-center">
                                <p class="text-xs text-slate-400 font-medium">Nenhuma ferramenta em posse no momento.</p>
                            </div>
                        `;
                    }

                    const content = `
                        <div class="flex flex-col items-center text-center mb-6">
                            <div class="w-24 h-24 ${workerType === 'TERCEIRO' ? 'bg-orange-100 text-orange-600' : 'bg-blue-100 text-blue-600'} rounded-full flex items-center justify-center text-3xl font-black mb-4 shadow-inner">
                                ${w.name.charAt(0)}
                            </div>
                            <h2 class="text-xl font-black text-slate-900 uppercase leading-tight mb-1">${w.name}</h2>
                            <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest border ${typeColor}">${typeLabel}</span>
                            ${dateAdded ? `<p class="text-[10px] text-slate-400 font-bold mt-2 uppercase tracking-wider">Adicionado em ${dateAdded}</p>` : ''}
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-2">
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 text-center">
                                <p class="text-[9px] font-bold text-slate-400 uppercase mb-1">${infoLabel}</p>
                                <p class="text-sm font-black text-slate-700 truncate" title="${displayInfo}">${displayInfo}</p>
                            </div>
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 text-center">
                                <p class="text-[9px] font-bold text-slate-400 uppercase mb-1">Hist√≥rico</p>
                                <p class="text-sm font-black text-slate-700">${historyCount} Mov.</p>
                            </div>
                        </div>

                        ${toolsHtml}
                    `;

                    document.getElementById('workerDetailsContent').innerHTML = content;
                    openModal('workerDetailsModal');
                    lucide.createIcons();
                }

                // Fun√ß√µes de Imagem e Modais de Ferramenta
                function previewImage(input) {
                    if (input.files && input.files[0]) {
                        const file = input.files[0];
                        const reader = new FileReader();
                        reader.onload = e => {
                            const img = new Image();
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                const maxWidth = 800;
                                const maxHeight = 800;
                                let width = img.width;
                                let height = img.height;

                                if (width > height) {
                                    if (width > maxWidth) {
                                        height *= maxWidth / width;
                                        width = maxWidth;
                                    }
                                } else {
                                    if (height > maxHeight) {
                                        width *= maxHeight / height;
                                        height = maxHeight;
                                    }
                                }
                                canvas.width = width;
                                canvas.height = height;
                                ctx.fillStyle = "#FFFFFF"; // Fundo branco para evitar fundo preto em PNGs transparentes
                                ctx.fillRect(0, 0, width, height);
                                ctx.drawImage(img, 0, 0, width, height);
                                const compressedBase64 = canvas.toDataURL('image/jpeg', 0.5); // Qualidade 50% para economizar espa√ßo
                                
                                currentImageBase64 = compressedBase64;
                                document.getElementById('imagePreview').src = compressedBase64;
                                document.getElementById('imagePreviewContainer').classList.remove('hidden');
                                document.getElementById('uploadPlaceholder').classList.add('hidden');
                            };
                            img.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                }

                function removeImage(event) {
                    event.stopPropagation();
                    currentImageBase64 = "";
                    document.getElementById('fileInput').value = null;
                    document.getElementById('imagePreview').src = "";
                    document.getElementById('imagePreviewContainer').classList.add('hidden');
                    document.getElementById('uploadPlaceholder').classList.remove('hidden');
                    lucide.createIcons();
                }

                function openAddModal(s) { 
                    pendingStatus = s; 
                    currentImageBase64 = "";
                    document.getElementById('fileInput').value = null;
                    document.getElementById('addModalTitle').innerText = "Novo Equipamento";
                    document.getElementById('toolCodeInput').value = "";
                    document.getElementById('toolNameInput').value = "";
                    document.getElementById('toolBrandInput').value = "";
                    document.getElementById('toolWeightInput').value = "";
                    document.getElementById('toolValueInput').value = "";
                    document.getElementById('toolQtyInput').value = "1";
                    document.getElementById('imagePreview').src = "";
                    document.getElementById('imagePreviewContainer').classList.add('hidden');
                    document.getElementById('uploadPlaceholder').classList.remove('hidden');
                    document.getElementById('btnSaveTool').onclick = addTool;
                    openModal('addModal'); 
                }

                function addTool() {
                    if (document.getElementById('addModal').classList.contains('hidden')) return;
                    const name = document.getElementById('toolNameInput').value;
                    if(!name) return;

                    const code = document.getElementById('toolCodeInput').value.trim();
                    if (code && tools.some(t => t.code === code)) {
                        document.getElementById('alertModalTitle').innerText = "C√≥digo Duplicado";
                        document.getElementById('alertModalText').innerText = `O c√≥digo/tag "${code}" j√° est√° cadastrado no sistema.`;
                        openModal('alertModal');
                        playSound('error');
                        return;
                    }

                    const qtyInput = document.getElementById('toolQtyInput');

                    let newId = Date.now();
                    while(tools.some(t => t.id === newId)) {
                        newId++;
                    }

                    const tool = {
                        id: newId,
                        name: name,
                        code: code,
                        brand: document.getElementById('toolBrandInput').value.toUpperCase(),
                        weight: document.getElementById('toolWeightInput').value,
                        value: parseFloat(document.getElementById('toolValueInput').value) || 0,
                        img: currentImageBase64,
                        status: pendingStatus,
                        user: '-',
                        maintenanceNote: "",
                        maintenanceInfo: null
                    };
                    if (qtyInput.value && parseInt(qtyInput.value) > 0) {
                        tool.qty = parseInt(qtyInput.value);
                    }
                    tools.unshift(tool);
                    closeModal('addModal');
                    save();
                    playSound('success');
                }

                function editTool(id) {
                    const t = tools.find(x => x.id === id);
                    if(!t) return;
                    document.getElementById('fileInput').value = null;
                    document.getElementById('addModalTitle').innerText = "Editar Equipamento";
                    document.getElementById('toolCodeInput').value = t.code;
                    document.getElementById('toolNameInput').value = t.name;
                    document.getElementById('toolBrandInput').value = t.brand || "";
                    document.getElementById('toolWeightInput').value = t.weight || "";
                    document.getElementById('toolValueInput').value = t.value;
                    document.getElementById('toolQtyInput').value = t.qty || 0;
                    if(t.img) {
                        currentImageBase64 = t.img;
                        document.getElementById('imagePreview').src = t.img;
                        document.getElementById('imagePreviewContainer').classList.remove('hidden');
                        document.getElementById('uploadPlaceholder').classList.add('hidden');
                    } else {
                        removeImage({ stopPropagation: () => {} });
                    }
                    document.getElementById('btnSaveTool').onclick = () => {
                        t.name = document.getElementById('toolNameInput').value;
                        t.code = document.getElementById('toolCodeInput').value;
                        t.brand = document.getElementById('toolBrandInput').value.toUpperCase();
                        t.weight = document.getElementById('toolWeightInput').value;
                        t.value = parseFloat(document.getElementById('toolValueInput').value) || 0;
                        const newQty = parseInt(document.getElementById('toolQtyInput').value) || 0;
                        if (newQty > 0) {
                            t.qty = newQty;
                        } else {
                            delete t.qty;
                        }
                        t.img = currentImageBase64;
                        // A nota de manuten√ß√£o s√≥ √© alterada na tela de manuten√ß√£o
                        save(); closeModal('addModal');
                        playSound('success');
                    };
                    openModal('addModal');
                    lucide.createIcons();
                }

                function requestDelete(id) {
                    const tool = tools.find(t => t.id === id);
                    if (tool && tool.status === 'em uso') {
                        document.getElementById('alertModalTitle').innerText = "A√ß√£o Bloqueada";
                        document.getElementById('alertModalText').innerText = "N√£o √© poss√≠vel excluir um item que est√° 'Em Uso'. Realize a devolu√ß√£o primeiro.";
                        openModal('alertModal');
                        playSound('error');
                        return;
                    }
                    itemToDeleteId = id;
                    const modal = document.getElementById('deleteModal');
                    modal.querySelector('h3').innerText = 'Excluir Item?';
                    modal.querySelector('p').innerText = 'Voc√™ tem certeza que deseja remover este item? Esta a√ß√£o n√£o pode ser desfeita.';
                    document.getElementById('confirmDeleteBtn').onclick = () => {
                        tools = tools.filter(t => t.id !== itemToDeleteId);
                        closeModal('deleteModal');
                        save();
                        playSound('success');
                    }; 
                    openModal('deleteModal');
                }
                
                function openZoom(src) { // --- FUN√á√ÉO DE ZOOM ATUALIZADA ---
                    if (!src) return;

                    const zoomModal = document.getElementById('zoomModal');
                    const zoomContainer = document.getElementById('zoomContainer');
                    const zoomImage = document.getElementById('zoomImage');
                    const zoomIframe = document.getElementById('zoomIframe');
                    let zoomTarget;

                    // Reset state
                    zoomState = { level: 1, isPanning: false, startX: 0, startY: 0, translateX: 0, translateY: 0 };
                    
                    if (src.startsWith('data:application/pdf')) {
                        zoomImage.classList.add('hidden');
                        zoomImage.src = "";
                        zoomIframe.classList.remove('hidden');
                        zoomIframe.src = src;
                        zoomTarget = zoomIframe;
                    } else {
                        zoomIframe.classList.add('hidden');
                        zoomIframe.src = "";
                        zoomImage.classList.remove('hidden');
                        zoomImage.src = src;
                        zoomTarget = zoomImage;
                    }
                    
                    zoomTarget.style.transform = 'scale(1) translate(0px, 0px)';
                    zoomTarget.style.cursor = 'default';
                    zoomTarget.classList.add('max-w-full', 'max-h-full');

                    const updateTransform = () => {
                        zoomTarget.style.transform = `scale(${zoomState.level}) translate(${zoomState.translateX}px, ${zoomState.translateY}px)`;
                    };

                    zoomContainer.onwheel = (e) => {
                        e.preventDefault();
                        const scaleAmount = 0.15;
                        if (e.deltaY < 0) { // Zoom in
                            zoomState.level = Math.min(8, zoomState.level + scaleAmount);
                        } else { // Zoom out
                            zoomState.level = Math.max(1, zoomState.level - scaleAmount);
                        }

                        if (zoomState.level > 1) {
                            zoomTarget.style.cursor = 'move';
                            zoomTarget.classList.remove('max-w-full', 'max-h-full');
                        } else {
                            zoomState.level = 1; // Snap to 1
                            zoomTarget.style.cursor = 'default';
                            zoomTarget.classList.add('max-w-full', 'max-h-full');
                            zoomState.translateX = 0;
                            zoomState.translateY = 0;
                        }
                        updateTransform();
                    };

                    zoomContainer.onmousedown = (e) => {
                        if (zoomState.level > 1) {
                            e.preventDefault();
                            zoomState.isPanning = true;
                            zoomState.startX = e.clientX - zoomState.translateX;
                            zoomState.startY = e.clientY - zoomState.translateY;
                            zoomTarget.style.cursor = 'grabbing';
                        }
                    };

                    zoomModal.onmousemove = (e) => {
                        if (zoomState.isPanning) {
                            e.preventDefault();
                            zoomState.translateX = e.clientX - zoomState.startX;
                            zoomState.translateY = e.clientY - zoomState.startY;
                            updateTransform();
                        }
                    };

                    zoomModal.onmouseup = () => {
                        if (zoomState.isPanning) {
                            zoomState.isPanning = false;
                            zoomTarget.style.cursor = 'move';
                        }
                    };
                    
                    zoomModal.onmouseleave = zoomModal.onmouseup;

                    openModal('zoomModal');
                }

                function setCatalogFilter(f) {
                    catalogFilter = f;
                document.querySelectorAll('#section-catalog .filter-pill').forEach(b => b.classList.remove('active'));
                    document.getElementById('filter-' + (f === 'em uso' ? 'uso' : f)).classList.add('active');
                    renderCatalog();
                }

                function createCatalogCardHTML(t) {
                    const statusInfo = {
                        disponivel: { class: 'bg-emerald-50 text-emerald-600', text: t.status },
                        'em uso': { class: 'bg-orange-100 text-orange-600', text: `Com ${t.user || 'N/A'}` },
                        quebrado: { class: 'bg-red-50 text-red-600', text: t.maintenanceInfo ? t.maintenanceInfo.status : 'Manuten√ß√£o' }
                    };
                    if (t.status === 'quebrado' && t.maintenanceInfo && t.maintenanceInfo.status === 'Em Conserto') {
                        statusInfo.quebrado.class = 'bg-indigo-100 text-indigo-600';
                    }
                    const currentStatus = statusInfo[t.status] || { class: 'bg-slate-100 text-slate-600', text: t.status };

                    let qtyDisplay = t.qty || 0;
                    if (qtyDisplay >= 1000) {
                        qtyDisplay = (qtyDisplay / 1000).toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + ' TON';
                    }

                    return `
                        <div id="tool-card-${t.id}" class="bg-white rounded-[2rem] p-4 shadow-lg border border-slate-100 flex flex-col group relative transition-all hover:shadow-2xl hover:-translate-y-1">
                            <div class="absolute top-6 right-6 flex gap-2 z-10 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="openItemHistory(${t.id}); event.stopPropagation();" class="bg-white/90 p-2 rounded-lg text-slate-600 hover:text-blue-600 shadow-sm border border-slate-200 cursor-pointer backdrop-blur" title="Hist√≥rico"><i data-lucide="clock" size="14"></i></button>
                                ${t.status === 'em uso' ? `<button onclick="requestReturn(${t.id}); event.stopPropagation();" class="bg-orange-500 text-white p-2 rounded-lg shadow-sm border border-orange-500 cursor-pointer hover:bg-orange-600" title="Devolver"><i data-lucide="rotate-ccw" size="14"></i></button>` : ''}
                                <button onclick="editTool(${t.id}); event.stopPropagation();" class="bg-white/90 p-2 rounded-lg text-slate-600 hover:text-blue-600 shadow-sm border border-slate-200 cursor-pointer backdrop-blur" title="Editar"><i data-lucide="pencil" size="14"></i></button>
                                <button onclick="requestDelete(${t.id}); event.stopPropagation();" class="bg-white/90 p-2 rounded-lg text-rose-500 hover:bg-rose-50 shadow-sm border border-slate-200 cursor-pointer backdrop-blur" title="Excluir"><i data-lucide="trash-2" size="14"></i></button>
                            </div>
                            <div onclick="openZoom('${t.img || ''}')" class="img-container relative w-full aspect-square bg-slate-50 rounded-2xl mb-4 flex items-center justify-center overflow-hidden border border-slate-50">
                                ${t.img ? `<img src="${t.img}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">` : `<i data-lucide="wrench" class="text-slate-200" size="40"></i>`}
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-all flex items-center justify-center">
                                    <i data-lucide="expand" class="text-white opacity-0 group-hover:opacity-100 transition-all transform scale-50 group-hover:scale-100" size="32"></i>
                                </div>
                            </div>
                            <div class="px-2">
                                <span class="text-[9px] font-black uppercase px-2 py-1 rounded-lg mb-2 inline-block ${currentStatus.class}">${currentStatus.text}</span>
                                <h3 class="font-black text-slate-900 uppercase text-xs truncate" title="${t.name}">${t.name}</h3>
                                ${t.status === 'quebrado' && t.maintenanceNote ? 
                                    `<p class="text-[9px] font-bold text-rose-500 mt-1 truncate" title="${t.maintenanceNote}"><i data-lucide="wrench" size="10" class="inline-block -mt-px"></i> ${t.maintenanceNote}</p>` :
                                    `<p class="text-[9px] font-bold text-slate-400 mt-1 uppercase tracking-tighter">
                                        ${t.code || ''} 
                                        ${t.brand ? '<span class="text-indigo-500 font-black"> | ' + t.brand + '</span>' : ''}
                                        ${t.weight ? '<span class="text-slate-500 font-black"> | ' + t.weight + ' KG <i data-lucide="weight" width="10" height="15" class="inline-block -mt-px"></i></span>' : ''}
                                    </p>`}
                                
                                <div class="mt-4 pt-4 border-t border-slate-50 flex items-center justify-between">
                                    <div class="flex flex-col">
                                        <span class="text-[8px] font-black text-slate-400 uppercase">Valor Estimado</span>
                                        <span class="text-emerald-600 font-black text-sm">${formatBRL(t.value)}</span>
                                    </div>
                                    <div class="flex flex-col items-end">
                                        <span class="text-[8px] font-black text-slate-400 uppercase">Estoque</span>
                                        <div class="flex items-center gap-1 text-slate-900 font-black">
                                            <i data-lucide="box" size="10"></i>
                                            <span>${qtyDisplay}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // --- RENDERIZA√á√ÉO DO CAT√ÅLOGO ATUALIZADA ---
                function renderCatalog() {
                    const grid = document.getElementById('catalogGrid');
                    if (!grid) return;
                    const searchTerm = document.getElementById('catalogSearchInput').value.toLowerCase();

                    let filteredTools = tools.filter(t => {
                        // Hide items with qty 0 (stock placeholders) completely from catalog
                        if (t.hasOwnProperty('qty') && t.qty === 0) {
                            return false;
                        }

                        const matchesFilter = catalogFilter === 'all' || t.status === catalogFilter;
                        const matchesSearch = !searchTerm || 
                                            t.name.toLowerCase().includes(searchTerm) ||
                                            (t.code && t.code.toLowerCase().includes(searchTerm)) ||
                                            (t.brand && t.brand.toLowerCase().includes(searchTerm));

                        return matchesFilter && matchesSearch;
                    });

                    const totalValue = filteredTools.reduce((sum, tool) => sum + ((tool.value || 0) * (tool.qty || 1)), 0);
                    const totalQty = filteredTools.reduce((sum, tool) => sum + (tool.qty || 1), 0);

                    document.getElementById('catalogTotalValue').innerText = formatBRL(totalValue);
                    document.getElementById('catalogTotalQty').innerText = totalQty;

                    if(filteredTools.length === 0) {
                        grid.innerHTML = `<p class="text-center text-sm text-slate-400 col-span-full py-10">Nenhum item encontrado para sua busca.</p>`;
                        return;
                    }
                    grid.innerHTML = filteredTools.map(t => createCatalogCardHTML(t)).join('');
                    lucide.createIcons();
                }

                function render() {
                    const toolListEl = document.getElementById('toolList');
                    if (!toolListEl) return;
                    
                    // Filter out stock placeholders (qty 0) from display and counts
                    const visibleTools = tools.filter(t => !t.hasOwnProperty('qty') || t.qty > 0 || t.status !== 'disponivel');

                    document.getElementById('totalCount').innerText = visibleTools.length;
                    document.getElementById('availCount').innerText = visibleTools.filter(t => t.status === 'disponivel').length;
                    document.getElementById('loanCount').innerText = visibleTools.filter(t => t.status === 'em uso').length;
                    document.getElementById('brokenCount').innerText = visibleTools.filter(t => t.status === 'quebrado').length;
                    document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('pt-BR', { day: 'numeric', month: 'long', year: 'numeric' });

                    document.getElementById('toolList').innerHTML = visibleTools.map(t => `
                        <tr class="group hover:bg-slate-50">
                            <td class="px-8 py-5">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-lg bg-slate-100 overflow-hidden border">
                                        ${t.img ? `<img src="${t.img}" class="w-full h-full object-cover">` : `<div class="flex items-center justify-center h-full text-slate-300 text-[8px]">FOTO</div>`}
                                    </div>
                                    <div><p class="font-black text-slate-800 uppercase text-xs">${t.name}</p><p class="text-[9px] font-bold text-slate-400">${t.code || ''} <span class="text-indigo-500 font-black">${t.brand ? ' | ' + t.brand + '</span>' : ''}</span></p></div>
                                </div>
                            </td>
                            <td class="px-8 py-5">
                                <div class="flex flex-col">
                                    <span class="text-[9px] font-black uppercase px-2 py-1 rounded-lg w-fit ${
                                        t.status === 'disponivel' ? 'bg-emerald-50 text-emerald-600' :
                                        t.status === 'em uso' ? 'bg-orange-100 text-orange-600' :
                                        t.status === 'quebrado' && t.maintenanceInfo && t.maintenanceInfo.status === 'Em Conserto' ? 'bg-indigo-100 text-indigo-600' :
                                        'bg-red-50 text-red-600'
                                    }">
                                        ${t.status === 'quebrado' ? (t.maintenanceInfo ? t.maintenanceInfo.status : 'Manuten√ß√£o') : (t.status === 'em uso' ? `Com ${t.user || 'N/A'}` : (t.hasOwnProperty('qty') && t.qty === 0 ? 'ESGOTADO' : t.status))}
                                    </span>
                                    ${t.status === 'quebrado' && t.maintenanceNote ? `<span class="text-[9px] text-rose-500 font-bold mt-1 block truncate" title="${t.maintenanceNote}">${t.maintenanceNote}</span>` : ''}
                                </div>
                            </td>
                            <td class="px-8 py-5 text-right">
                                <div class="flex justify-end gap-2">
                                    ${t.status === 'em uso' ? 
                                        `<button onclick="requestReturn(${t.id})" class="p-2 text-orange-500 hover:bg-orange-50 rounded-lg transition-colors" title="Devolver"><i data-lucide="rotate-ccw" size="16"></i></button>` :
                                        '<div class="w-10 p-2"></div>'
                                    }
                                    <button onclick="editTool(${t.id})" class="p-2 text-slate-400 hover:text-blue-600 bg-transparent border-none cursor-pointer"><i data-lucide="pencil" size="16"></i></button>
                                    <button onclick="requestDelete(${t.id})" class="p-2 text-slate-400 hover:text-rose-600 bg-transparent border-none cursor-pointer"><i data-lucide="trash-2" size="16"></i></button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                    lucide.createIcons();
                }

                // --- FUN√á√ïES DE HIST√ìRICO ---
                function formatISODate(iso) {
                    if (!iso) return '-';
                    return new Date(iso).toLocaleString('pt-BR', {dateStyle: 'short', timeStyle: 'short'});
                }

                function formatDuration(start, end) {
                    if (!end || !start) return '-';
                    let diff = new Date(end) - new Date(start);
                    const days = Math.floor(diff / 86400000);
                    diff -= days * 86400000;
                    const hours = Math.floor(diff / 3600000);
                    diff -= hours * 3600000;
                    const mins = Math.floor(diff / 60000);

                    let result = '';
                    if (days > 0) result += `${days}d`;
                    if (hours > 0) result += `${hours}h`;
                    if (mins > 0 || (days === 0 && hours === 0)) result += `${mins}min`;
                    return result || '0min';
                }

                function requestDeleteHistory(id) {
                    historyItemToDeleteId = id;
                    const modal = document.getElementById('deleteModal');
                    modal.querySelector('h3').innerText = 'Excluir Registro?';
                    modal.querySelector('p').innerText = 'Deseja remover este registro do hist√≥rico? Esta a√ß√£o n√£o pode ser desfeita.';
                    document.getElementById('confirmDeleteBtn').onclick = deleteHistoryEntry;
                    openModal('deleteModal');
                }

                function deleteHistoryEntry() {
                    history = history.filter(h => h.historyId !== historyItemToDeleteId);
                    save();
                    closeModal('deleteModal');
                    playSound('success');
                }

                function clearHistoryDateFilter() {
                    if (historyDatePicker) {
                        historyDatePicker.clear();
                    }
                }

                function renderHistory() {
                    const grid = document.getElementById('historyGrid');
                    if (!grid) return;
                    const searchTerm = document.getElementById('historySearchInput').value.toLowerCase();
                    const dateInput = document.getElementById('historyDateInput');
                    const dateStr = dateInput.value;

                    let dateFilter = null;
                    if (dateStr) {
                        const parts = dateStr.split('/');
                        if (parts.length === 3) {
                            dateFilter = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                        }
                    }

                    const filteredHistory = history.filter(h => {
                        const matchesSearch = !searchTerm || (h.toolName && h.toolName.toLowerCase().includes(searchTerm)) || (h.workerName && h.workerName.toLowerCase().includes(searchTerm));
                        const matchesDate = !dateFilter || (h.checkoutDate && h.checkoutDate.startsWith(dateFilter)) || (h.returnDate && h.returnDate.startsWith(dateFilter));
                        return matchesSearch && matchesDate;
                    });

                    if (filteredHistory.length === 0) {
                        grid.innerHTML = `<p class="text-center text-sm text-slate-400 col-span-full py-20">Nenhum registro de hist√≥rico encontrado.</p>`;
                        return;
                    }

                    grid.innerHTML = filteredHistory.map(h => {
                        let typeLabel, typeColor;
                        if (h.returnDate) {
                            if (h.type === 'manutencao') {
                                typeLabel = 'Finalizada';
                                typeColor = 'bg-emerald-100 text-emerald-700';
                            } else { // emprestimo
                                if (h.condition === 'quebrado') {
                                    typeLabel = 'Devolvido Quebrado';
                                    typeColor = 'bg-rose-100 text-rose-700';
                                } else {
                                    typeLabel = 'Devolvido';
                                    typeColor = 'bg-emerald-100 text-emerald-700';
                                }
                            }
                        } else {
                            typeLabel = h.type === 'manutencao' ? 'Em Manuten√ß√£o' : 'Em Uso';
                            typeColor = h.type === 'manutencao' ? 'bg-red-100 text-red-700' : 'bg-orange-100 text-orange-700';
                        }
                        const tool = tools.find(t => t.id === h.toolId) || {};
                        const toolImg = h.toolImg || tool.img;

                        return `
                        <div class="bg-white rounded-2xl p-5 shadow-md border border-slate-100 flex flex-col gap-4 relative group">
                            <div class="absolute top-4 right-4">
                                <button onclick="requestDeleteHistory(${h.historyId})" class="p-2 text-slate-400 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity" title="Excluir Registro"><i data-lucide="trash-2" size="16"></i></button>
                            </div>
                            <div class="flex items-start gap-4">
                                <div class="w-16 h-16 bg-slate-50 rounded-xl flex items-center justify-center overflow-hidden border border-slate-100">
                                    ${toolImg ? `<img src="${toolImg}" class="w-full h-full object-cover">` : `<i data-lucide="wrench" class="text-slate-300" size="24"></i>`}
                                </div>
                                <div class="flex-1">
                                    <span class="text-[10px] font-black uppercase px-2 py-1 rounded-md ${typeColor}">${typeLabel}</span>
                                    <h3 class="font-black text-slate-800 uppercase mt-1">${h.toolName}</h3>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase">${tool.code || ''}</p>
                                </div>
                            </div>
                            <div class="text-xs space-y-2">
                                <div class="flex justify-between">
                                    <span class="font-bold text-slate-400">Respons√°vel:</span>
                                    <span class="font-black text-slate-700 uppercase">${h.workerName}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-bold text-slate-400">Quantidade:</span>
                                    <span class="font-black text-slate-700">${h.qty}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-bold text-slate-400">Valor (Un.):</span>
                                    <span class="font-black text-emerald-600">${formatBRL(h.toolValue || 0)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-bold text-slate-400">Data da Retirada:</span>
                                    <span class="font-semibold text-slate-600">${formatISODate(h.checkoutDate)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-bold text-slate-400">Data da Devolu√ß√£o:</span>
                                    <span class="font-semibold text-slate-600">${formatISODate(h.returnDate)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-bold text-slate-400">Tempo de Posse:</span>
                                    <span class="font-black text-blue-600">${formatDuration(h.checkoutDate, h.returnDate)}</span>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('');
                    lucide.createIcons();
                }

                function openItemHistory(id) {
                    const tool = tools.find(t => t.id === id);
                    if (!tool) return;

                    const itemHistory = history.filter(h => h.toolId === id).sort((a,b) => new Date(b.checkoutDate) - new Date(a.checkoutDate));
                    const container = document.getElementById('itemHistoryContent');
                    
                    let html = `<div class="flex items-center gap-4 mb-6 pb-6 border-b border-slate-100"><div class="w-16 h-16 bg-slate-100 rounded-xl flex items-center justify-center overflow-hidden border border-slate-200">${tool.img ? `<img src="${tool.img}" class="w-full h-full object-cover">` : `<i data-lucide="wrench" class="text-slate-300" size="24"></i>`}</div><div><h3 class="font-black text-slate-900 uppercase text-lg">${tool.name}</h3><p class="text-sm font-bold text-slate-400 uppercase">${tool.code || 'S/C'}</p></div></div><div class="space-y-3">`;

                    if (itemHistory.length === 0) {
                        html += `<p class="text-center text-slate-400 text-sm py-4">Nenhum hist√≥rico registrado para este item.</p>`;
                    } else {
                        html += itemHistory.map(h => `<div class="bg-slate-50 p-3 rounded-xl border border-slate-100 text-xs"><div class="flex justify-between mb-1"><span class="font-black text-slate-700">${h.workerName}</span><span class="text-slate-400">${formatISODate(h.checkoutDate)}</span></div><div class="flex justify-between"><span class="${h.returnDate ? 'text-emerald-600' : 'text-orange-500'} font-bold">${h.returnDate ? 'Devolvido' : 'Em Uso'}</span><span>${h.returnDate ? formatISODate(h.returnDate) : ''}</span></div></div>`).join('');
                    }
                    html += `</div>`;
                    container.innerHTML = html;
                    openModal('itemHistoryModal');
                    lucide.createIcons();
                }

                // --- FUN√á√ÉO DE SIMULA√á√ÉO DE ATRASO ---
                function simulateOverdue() {
                    // Encontra a primeira ferramenta de item √∫nico que esteja dispon√≠vel
                    const availableTool = tools.find(t => t.status === 'disponivel' && (!t.hasOwnProperty('qty') || t.qty === 0));
                    
                    if (!availableTool) {
                        document.getElementById('alertModalTitle').innerText = "Simula√ß√£o Falhou";
                        document.getElementById('alertModalText').innerText = "Nenhuma ferramenta de item √∫nico (n√£o consum√≠vel) est√° dispon√≠vel para simular o atraso.";
                        openModal('alertModal');
                        return;
                    }

                    // Altera o status da ferramenta para "em uso" por um usu√°rio de teste
                    availableTool.status = 'em uso';
                    availableTool.user = 'SIMULA√á√ÉO';

                    // Cria um registro de hist√≥rico com data de retirada de 25 horas atr√°s
                    const now = new Date();
                    const hoursBack = (appSettings.overdueHours || 24) + 1;
                    const twentyFiveHoursAgo = new Date(now.getTime() - (hoursBack * 60 * 60 * 1000));

                    const historyEntry = {
                        historyId: Date.now(),
                        toolId: availableTool.id,
                        toolName: availableTool.name,
                        toolImg: availableTool.img,
                        workerName: 'SIMULA√á√ÉO',
                        qty: 1,
                        checkoutDate: twentyFiveHoursAgo.toISOString(),
                        returnDate: null,
                        type: 'emprestimo'
                    };
                    history.unshift(historyEntry);

                    // Salva os dados e atualiza a interface, mostrando o alerta
                    save();
                    openOverdueModal();
                }

                let pendingPinAction = null;

                function requestPin(callback) {
                    pendingPinAction = callback;
                    const input = document.getElementById('pinInputModal');
                    input.value = '';
                    input.placeholder = "****";
                    input.classList.remove('border-rose-500');
                    openModal('pinModal');
                    setTimeout(() => input.focus(), 100);
                }

                function validatePin() {
                    const input = document.getElementById('pinInputModal');
                    if (input.value === appSettings.adminPin) {
                        closeModal('pinModal');
                        if (pendingPinAction) pendingPinAction();
                        pendingPinAction = null;
                    } else {
                        input.classList.add('border-rose-500');
                        input.value = '';
                        input.placeholder = "PIN Incorreto";
                        input.focus();
                    }
                }

                // --- FUN√á√ÉO DE PARAR SIMULA√á√ÉO DE ATRASO ---
                function stopSimulation() {
                    const simulatedTool = tools.find(t => t.status === 'em uso' && t.user === 'SIMULA√á√ÉO');
                    
                    if (!simulatedTool) {
                        document.getElementById('alertModalTitle').innerText = "Simula√ß√£o N√£o Ativa";
                        document.getElementById('alertModalText').innerText = "Nenhuma simula√ß√£o de atraso est√° ativa no momento para ser interrompida.";
                        openModal('alertModal');
                        return;
                    }

                    simulatedTool.status = 'disponivel';
                    simulatedTool.user = '-';

                    const historyIndex = history.findIndex(h => h.toolId === simulatedTool.id && h.workerName === 'SIMULA√á√ÉO' && h.returnDate === null);
                    if (historyIndex > -1) {
                        history.splice(historyIndex, 1);
                    }

                    save();
                    document.getElementById('alertModalTitle').innerText = "Simula√ß√£o Finalizada";
                    document.getElementById('alertModalText').innerText = "A simula√ß√£o de atraso foi revertida com sucesso.";
                    openModal('alertModal');
                }

                window.onload = () => { 
                    render(); 
                    renderOverdueAlert();
                    applyTheme(); // Aplica o tema salvo
                    loadFromCloud(); // Tenta baixar os dados mais recentes da nuvem
                    lucide.createIcons(); 
                    setInterval(loadFromCloud, 3000); // Sincroniza com a nuvem a cada 5 segundos (tempo real)

                    historyDatePicker = flatpickr("#historyDateInput", {
                        locale: "pt",
                        dateFormat: "d/m/Y",
                        onChange: function(selectedDates, dateStr, instance) {
                            document.getElementById('clearDateBtn').classList.toggle('hidden', !dateStr);
                            renderHistory();
                        }
                    });

                    setInterval(renderOverdueAlert, 30000); // Verifica atrasos a cada 30 segundos

                    // Configura√ß√£o de tecla Enter para salvar/confirmar
                    const setupEnter = (inputId, action) => {
                        const el = document.getElementById(inputId);
                        if (el) {
                            el.addEventListener('keydown', (e) => {
                                if (e.key === 'Enter') {
                                    e.preventDefault();
                                    action();
                                }
                            });
                        }
                    };

                    // Equipe
                    setupEnter('workerNameInput', addWorker);
                    setupEnter('workerCompanyInput', addWorker);

                    // Ferramentas (Adicionar/Editar)
                    const saveToolAction = () => document.getElementById('btnSaveTool').click();
                    setupEnter('toolCodeInput', saveToolAction);
                    setupEnter('toolNameInput', saveToolAction);
                    setupEnter('toolBrandInput', saveToolAction);
                    setupEnter('toolWeightInput', saveToolAction);
                    setupEnter('toolValueInput', saveToolAction);
                    setupEnter('toolQtyInput', saveToolAction);

                    // PIN Modal
                    setupEnter('pinInputModal', validatePin);

                    // Sa√≠da de Materiais (Quantidade)
                    setupEnter('materialQtyInput', processQtyStep);

                    // Manuten√ß√£o (Or√ßamento)
                    setupEnter('quoteProviderInput', () => saveQuote(itemToManageMaintenanceId));
                    setupEnter('quoteCostInput', () => saveQuote(itemToManageMaintenanceId));

                    // Sons de digita√ß√£o
                    document.addEventListener('keydown', (e) => {
                        if (e.target.matches('input, textarea')) {
                            if (e.key === 'Backspace' || e.key === 'Delete') {
                                playSound('delete');
                            } else if (e.key.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey) {
                                playSound('type');
                            }
                        }
                    });
                };

                // --- FUN√á√ïES DE CONFIGURA√á√ÉO ---
                function loadSettingsUI() {
                    // Carrega valores nos inputs
                    const hours = appSettings.overdueHours || 24;
                    document.getElementById('settingOverdueHours').value = hours;
                    
                    const lowStock = appSettings.lowStockLimit || 5;
                    document.getElementById('settingLowStock').value = lowStock;
                    
                    // PIN UI Logic
                    const pinInput = document.getElementById('settingAdminPin');
                    const btnSave = document.getElementById('btnSavePin');
                    const btnDelete = document.getElementById('btnDeletePin');
                    
                    if (appSettings.adminPin) {
                        pinInput.value = '';
                        pinInput.placeholder = "PIN Ativo (Protegido)";
                        pinInput.disabled = true;
                        pinInput.classList.add('bg-slate-50');
                        btnSave.classList.add('hidden');
                        btnDelete.classList.remove('hidden');
                    } else {
                        pinInput.value = '';
                        pinInput.placeholder = "Digite para definir...";
                        pinInput.disabled = false;
                        pinInput.classList.remove('bg-slate-50');
                        btnSave.classList.remove('hidden');
                        btnDelete.classList.add('hidden');
                    }

                    // Checkboxes
                    document.getElementById('settingDarkMode').checked = appSettings.darkMode || false;
                    document.getElementById('settingAlertLowStock').checked = appSettings.alertLowStock !== false;
                    document.getElementById('settingAlertOverdue').checked = appSettings.alertOverdue !== false;
                    document.getElementById('settingSystemSounds').checked = appSettings.systemSounds !== false;
                }

                function saveSettings() {
                    appSettings.overdueHours = parseInt(document.getElementById('settingOverdueHours').value) || 24;
                    appSettings.lowStockLimit = parseInt(document.getElementById('settingLowStock').value) || 5;
                    appSettings.darkMode = document.getElementById('settingDarkMode').checked;
                    appSettings.alertLowStock = document.getElementById('settingAlertLowStock').checked;
                    appSettings.alertOverdue = document.getElementById('settingAlertOverdue').checked;
                    appSettings.systemSounds = document.getElementById('settingSystemSounds').checked;
                    save();
                }

                function setAdminPin() {
                    const pinInput = document.getElementById('settingAdminPin');
                    const val = pinInput.value.trim();
                    if (!val) return;
                    appSettings.adminPin = val;
                    save();
                    loadSettingsUI();
                    document.getElementById('alertModalTitle').innerText = "Sucesso";
                    document.getElementById('alertModalText').innerText = "PIN de seguran√ßa definido com sucesso!";
                    openModal('alertModal');
                    playSound('success');
                }

                function deleteAdminPin() {
                    const modal = document.getElementById('deleteModal');
                    modal.querySelector('h3').innerText = 'Remover PIN?';
                    modal.querySelector('p').innerText = 'Tem certeza que deseja remover a prote√ß√£o por PIN?';
                    
                    document.getElementById('confirmDeleteBtn').onclick = () => {
                        appSettings.adminPin = null;
                        save();
                        loadSettingsUI();
                        closeModal('deleteModal');
                        document.getElementById('alertModalTitle').innerText = "Sucesso";
                        document.getElementById('alertModalText').innerText = "PIN removido com sucesso.";
                        openModal('alertModal');
                        playSound('success');
                    };
                    openModal('deleteModal');
                }

                function toggleDarkMode() {
                    appSettings.darkMode = !appSettings.darkMode;
                    applyTheme();
                    saveSettings();
                }

                function applyTheme() {
                    const html = document.documentElement;
                    if (appSettings.darkMode) {
                        html.classList.add('dark');
                    } else {
                        html.classList.remove('dark');
                    }
                }

                function confirmResetSystem() {
                    const executeReset = () => {
                        const modal = document.getElementById('deleteModal');
                        modal.querySelector('h3').innerText = 'Resetar Sistema?';
                        modal.querySelector('p').innerText = 'ATEN√á√ÉO: Esta a√ß√£o apagar√° PERMANENTEMENTE todos os dados (Ferramentas, Equipe, Hist√≥rico). Recomenda-se exportar um backup antes. Deseja continuar?';
                        
                        document.getElementById('confirmDeleteBtn').onclick = async () => {
                            // Limpa dados em mem√≥ria
                            tools = [];
                            team = [];
                            history = [];
                            // Salva estado vazio
                            await save(true);
                            location.reload();
                        };
                        openModal('deleteModal');
                    };

                    if (appSettings.adminPin) {
                        requestPin(executeReset);
                    } else {
                        executeReset();
                    }
                }

                // --- FUN√á√ïES DE BACKUP ---
                function exportData() {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ tools, team, history }));
                const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", "backup_ferramentaria_" + new Date().toISOString().split('T')[0] + ".json");
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                }

                function importData(input) {
                    const file = input.files[0];
                    if(!file) return;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.tools) tools = data.tools;
                            if (data.team) team = data.team;
                            if (data.history) history = data.history;
                            save();
                            document.getElementById('alertModalTitle').innerText = "Sucesso";
                            document.getElementById('alertModalText').innerText = "Dados importados com sucesso!";
                            openModal('alertModal');
                            playSound('success');
                        } catch(e) { 
                            document.getElementById('alertModalTitle').innerText = "Erro";
                            document.getElementById('alertModalText').innerText = "Erro ao importar arquivo. Verifique se o arquivo √© um backup v√°lido.";
                            openModal('alertModal');
                            playSound('error');
                        } finally {
                            // Reseta o t√≠tulo do modal de alerta para o padr√£o depois de usar
                            setTimeout(() => {
                                document.getElementById('alertModalTitle').innerText = "Aten√ß√£o";
                            }, 500);
                        }
                    };
                    reader.readAsText(file);
                }

                // --- FUN√á√ïES DE CHECKOUT / DEVOLU√á√ÉO ---
                function requestReturn(id) {
                    itemToReturnId = id; // This is used by handleReturnCondition
                    const tool = tools.find(t => t.id === id);
                    if (!tool) return;
                    
                    document.getElementById('returnModalTitle').innerText = `Devolver: ${tool.name}`;
                    document.getElementById('returnModalText').innerText = `Qual o estado de devolu√ß√£o do item por ${tool.user}?`;
                    document.getElementById('btnReturnBroken').onclick = () => handleReturnCondition(id, 'quebrado');
                    document.getElementById('btnReturnWorking').onclick = () => handleReturnCondition(id, 'funcionando');
                    openModal('returnModal');
                }
                function handleReturnCondition(id, condition) {
                    const tool = tools.find(t => t.id === id);
                    if (!tool) return;

                    const historyEntry = history.find(h => h.toolId === tool.id && h.returnDate === null && h.type === 'emprestimo');

                    if (condition === 'funcionando') {
                        if (historyEntry) {
                            historyEntry.returnDate = new Date().toISOString();
                            historyEntry.condition = 'boa';
                        }

                        if (tool.original_id) { // It's a consumable part
                            const originalTool = tools.find(ot => ot.id === tool.original_id);
                            if (originalTool) {
                                originalTool.qty = (originalTool.qty || 0) + (tool.qty || 1);
                            }
                            tools = tools.filter(t => t.id !== tool.id);
                        } else { // It's a unique tool
                            tool.status = 'disponivel';
                            tool.user = '-';
                        }
                        closeModal('returnModal');
                        document.getElementById(`tool-card-${id}`)?.remove();
                        save();
                        playSound('success');
                    } else if (condition === 'quebrado') {
                        // Para ferramentas normais e consum√≠veis, inicia o fluxo de manuten√ß√£o
                        maintenanceData.toolId = itemToReturnId;
                        document.getElementById('step-selecionar-ferramenta').classList.add('hidden');
                        document.getElementById('step-detalhes-manutencao').classList.remove('hidden');
                        document.getElementById('selectedToolMaintenance').innerHTML = `<div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl mb-3">
                            <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center overflow-hidden">${tool.img ? `<img src="${tool.img}" class="w-full h-full object-cover">` : `<i data-lucide="image" class="text-slate-300"></i>`}</div>
                            <div><p class="font-bold text-xs uppercase text-slate-800">${tool.name}</p><p class="text-[9px] font-black text-slate-400 uppercase">${tool.code}</p></div>
                        </div>`;
                        
                        // Configura√ß√£o do campo de quantidade
                        const qtyContainer = document.getElementById('maintenanceQtyContainer');
                        const qtyInput = document.getElementById('maintenanceQtyInput');
                        const maxQtySpan = document.getElementById('maintenanceMaxQty');

                        if (tool.hasOwnProperty('qty')) {
                            qtyContainer.classList.remove('hidden');
                            qtyInput.max = tool.qty;
                            qtyInput.value = tool.qty;
                            if(maxQtySpan) maxQtySpan.innerText = `Em posse: ${tool.qty}`;
                        } else {
                            document.getElementById('maintenanceQtyContainer').classList.add('hidden');
                            document.getElementById('maintenanceQtyInput').value = 1;
                        }

                        document.getElementById('maintenanceNoteInput').value = '';
                        document.getElementById('btnFinalizeMaintenance').onclick = finalizeMaintenanceReport;
                        
                        closeModal('returnModal');
                        openModal('maintenanceModal');
                        // N√£o salva aqui, pois o fluxo continua no modal de manuten√ß√£o
                    }
                }
                function finishRepair(id) {
                    const tool = tools.find(t => t.id === id);
                    if (!tool || !tool.maintenanceInfo) return;

                    // Bloqueia atualiza√ß√£o da nuvem imediatamente para evitar conflito durante leitura do arquivo
                    isSaving = true;

                    const fileInput = document.getElementById('invoiceFileInput');
                    const file = fileInput.files[0];

                    const processAndSave = (invoiceData) => {
                        // Re-busca a ferramenta para garantir que estamos alterando a inst√¢ncia correta
                        const currentTool = tools.find(t => t.id === id) || tool;
                        currentTool.maintenanceInfo.invoiceFile = invoiceData;
                        currentTool.maintenanceInfo.status = 'Finalizado';
                        closeModal('manageMaintenanceModal');
                        setTimeout(save, 50);
                        playSound('success');
                    };

                    if (file) {
                        // Sempre comprime imagens para economizar espa√ßo
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const img = new Image();
                                img.onload = () => {
                                    const canvas = document.createElement('canvas');
                                    const ctx = canvas.getContext('2d');
                                    const maxWidth = 800;
                                    const maxHeight = 800;
                                    let width = img.width;
                                    let height = img.height;

                                    if (width > height) {
                                        if (width > maxWidth) {
                                            height *= maxWidth / width;
                                            width = maxWidth;
                                        }
                                    } else {
                                        if (height > maxHeight) {
                                            width *= maxHeight / height;
                                            height = maxHeight;
                                        }
                                    }
                                    canvas.width = width;
                                    canvas.height = height;
                                    ctx.fillStyle = "#FFFFFF";
                                    ctx.fillRect(0, 0, width, height);
                                    ctx.drawImage(img, 0, 0, width, height);
                                    const compressedBase64 = canvas.toDataURL('image/jpeg', 0.5);
                                    processAndSave(compressedBase64);
                                };
                                img.src = e.target.result;
                            };
                            reader.onerror = () => { isSaving = false; };
                            reader.readAsDataURL(file);
                            return;
                        }

                        // Limite para PDFs e outros arquivos (1MB)
                        if (file.size > 1 * 1024 * 1024) {
                            document.getElementById('alertModalTitle').innerText = "Arquivo Muito Grande";
                            document.getElementById('alertModalText').innerText = "Para arquivos PDF, o limite √© 1MB. Para imagens, o sistema tentar√° comprimir automaticamente.";
                            openModal('alertModal');
                            playSound('error');
                            isSaving = false; // Libera sincroniza√ß√£o em caso de erro
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = (e) => processAndSave(e.target.result);
                        reader.onerror = () => { isSaving = false; };
                        reader.readAsDataURL(file);
                    } else {
                        processAndSave(tool.maintenanceInfo.invoiceFile || null);
                    }
                }

                function concludeAndMoveToStock(id) {
                    closeModal('manageMaintenanceModal');
                    const t = tools.find(x => x.id === id);
                    if (t) {
                        // Atualiza hist√≥rico de manuten√ß√£o se existir
                        const historyEntry = history.find(h => h.toolId === t.id && h.returnDate === null && h.type === 'manutencao');
                        if (historyEntry) {
                            historyEntry.returnDate = new Date().toISOString();
                        }
                        t.status = 'disponivel';
                        t.user = '-';
                        t.maintenanceNote = "";
                        t.maintenanceInfo = null;
                        document.getElementById(`tool-card-${id}`)?.remove();
                        save();
                        playSound('success');
                    }
                }

                // --- FUN√á√ïES DE MANUTEN√á√ÉO ---
                function openMaintenanceModal(isSearchUpdate = false) {
                    if (!isSearchUpdate) {
                        maintenanceData = { toolId: null };
                        const searchInput = document.getElementById('maintenanceToolSearchInput');
                        if (searchInput) {
                            searchInput.value = "";
                            searchInput.nextElementSibling.classList.add('hidden');
                        }
                        document.getElementById('step-selecionar-ferramenta').classList.remove('hidden');
                        document.getElementById('step-detalhes-manutencao').classList.add('hidden');
                        openModal('maintenanceModal');
                    }
                    
                    const list = document.getElementById('toolGridMaintenance');
                    const searchInput = document.getElementById('maintenanceToolSearchInput');
                    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

                    const availableTools = tools.filter(t => {
                        const notBroken = t.status !== 'quebrado';
                        const hasStock = !t.hasOwnProperty('qty') || t.qty > 0;
                        const matchesSearch = !searchTerm || 
                                            t.name.toLowerCase().includes(searchTerm) ||
                                            (t.code && t.code.toLowerCase().includes(searchTerm)) ||
                                            (t.brand && t.brand.toLowerCase().includes(searchTerm));
                        return notBroken && hasStock && matchesSearch;
                    });

                    list.innerHTML = availableTools.map(t => {
                        let stockInfo;
                        if (t.status === 'disponivel') {
                            stockInfo = `
                                <span class="text-[8px] font-black text-slate-400 uppercase">Estoque</span>
                                <div class="flex items-center justify-center gap-1 text-slate-900 font-black text-lg"><i data-lucide="box" size="12"></i><span>${t.qty || 0}</span></div>
                            `;
                        } else {
                            stockInfo = `<span class="text-[8px] font-black uppercase text-slate-400 uppercase">Em Uso Por</span><p class="text-orange-600 font-black text-lg">${t.user}</p>`;
                        }
                        return `
                        <div onclick="selectToolForMaintenance(${t.id})" class="bg-white rounded-2xl p-3 shadow-lg border border-slate-100 cursor-pointer hover:border-red-500 hover:shadow-xl transition-all flex flex-col text-center group">
                            <div class="relative w-full aspect-square bg-white rounded-xl mb-3 flex items-center justify-center overflow-hidden border border-slate-100">
                                ${t.img ? `<img src="${t.img}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110">` : `<i data-lucide="wrench" class="text-slate-200" size="40"></i>`}
                            </div>
                            <div class="flex-1 flex flex-col justify-between"><h3 class="font-black text-slate-700 uppercase text-[10px] leading-tight h-8 flex items-center justify-center px-1" title="${t.name}">${t.name}</h3><div class="mt-2 pt-2 border-t border-slate-100">${stockInfo}</div></div>
                        </div>`;
                    }).join('');
                    if(availableTools.length === 0) {
                        list.innerHTML = `<p class="text-center text-xs text-slate-400 col-span-full">${searchTerm ? 'Nenhuma ferramenta encontrada.' : 'Nenhuma ferramenta dispon√≠vel para manuten√ß√£o.'}</p>`;
                    }
                    lucide.createIcons();
                }

                function selectToolForMaintenance(id) {
                    maintenanceData.toolId = id;
                    const tool = tools.find(t => t.id === id);
                    document.getElementById('step-selecionar-ferramenta').classList.add('hidden');
                    document.getElementById('step-detalhes-manutencao').classList.remove('hidden');
                    document.getElementById('selectedToolMaintenance').innerHTML = `<div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl mb-3">
                        <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center overflow-hidden">${tool.img ? `<img src="${tool.img}" class="w-full h-full object-cover">` : `<i data-lucide="image" class="text-slate-300"></i>`}</div>
                        <div><p class="font-bold text-xs uppercase text-slate-800">${tool.name}</p><p class="text-[9px] font-black text-slate-400 uppercase">${tool.code}</p></div>
                    </div>`;
                    
                    // Configura√ß√£o do campo de quantidade
                    const qtyContainer = document.getElementById('maintenanceQtyContainer');
                    const qtyInput = document.getElementById('maintenanceQtyInput');
                    const maxQtySpan = document.getElementById('maintenanceMaxQty');
                    const isBulk = tool.hasOwnProperty('qty');
                    
                    if (isBulk) {
                        qtyContainer.classList.remove('hidden');
                        qtyInput.max = tool.qty;
                        qtyInput.value = 1;
                        if(maxQtySpan) maxQtySpan.innerText = `Dispon√≠vel: ${tool.qty}`;
                    } else {
                        qtyContainer.classList.add('hidden');
                        qtyInput.value = 1;
                    }

                    document.getElementById('maintenanceNoteInput').value = tool.maintenanceNote || '';
                    document.getElementById('btnFinalizeMaintenance').onclick = finalizeMaintenanceReport;
                    lucide.createIcons();
                    
                }

                function resetMaintenance() {
                    document.getElementById('step-selecionar-ferramenta').classList.remove('hidden');
                    document.getElementById('step-detalhes-manutencao').classList.add('hidden');
                }

                function finalizeMaintenanceReport() {
                    const t = tools.find(x => x.id === maintenanceData.toolId);
                    const note = document.getElementById('maintenanceNoteInput').value.trim();
                    const qtyInput = document.getElementById('maintenanceQtyInput');
                    let qtyToMaintenance = parseInt(qtyInput.value);
                    
                    if (!qtyToMaintenance || qtyToMaintenance < 1) qtyToMaintenance = 1;

                    if (t && !note) { // Valida√ß√£o para nota de manuten√ß√£o
                        document.getElementById('alertModalText').innerText = 'Por favor, descreva o problema para registrar a manuten√ß√£o.';
                        openModal('alertModal');
                        playSound('error');
                        return;
                    }
                    
                    if (!t) return;

                    // Verifica se √© necess√°rio dividir o item (quantidade parcial)
                    const isBulk = t.hasOwnProperty('qty');
                    
                    if (isBulk) {
                        if (qtyToMaintenance > t.qty) {
                             document.getElementById('alertModalText').innerText = 'Quantidade inv√°lida.';
                             openModal('alertModal');
                             playSound('error');
                             return;
                        }

                        // L√≥gica de divis√£o: reduz a quantidade do item original
                        t.qty -= qtyToMaintenance;
                        
                        // Se for um item em uso (clone) e a quantidade zerar, remove da lista e fecha hist√≥rico
                        if (t.status === 'em uso') {
                            const activeLoan = history.find(h => h.toolId === t.id && h.returnDate === null && h.type === 'emprestimo');
                            if (t.qty === 0) {
                                if (activeLoan) {
                                    activeLoan.returnDate = new Date().toISOString();
                                    activeLoan.condition = 'quebrado';
                                }
                                tools = tools.filter(tool => tool.id !== t.id);
                            } else if (activeLoan) {
                                // Se for parcial, atualiza a quantidade no hist√≥rico
                                activeLoan.qty = t.qty;
                            }
                        }

                        // Cria novo item para manuten√ß√£o com a quantidade especificada
                        const maintenanceTool = {
                            ...t,
                            id: Date.now(),
                            qty: qtyToMaintenance,
                            status: 'quebrado',
                            user: 'MANUTEN√á√ÉO',
                            maintenanceNote: note,
                            original_id: t.original_id || t.id, // Se t j√° √© clone, mant√©m. Se √© original, aponta para t.
                            maintenanceInfo: {
                                status: 'Aguardando Or√ßamento',
                                provider: '',
                                cost: 0,
                                quoteNote: '',
                                reportDate: new Date().toISOString(),
                                reportedBy: t.user !== '-' ? t.user : 'ALMOXARIFADO',
                                approvalDate: null,
                                invoiceFile: null
                            }
                        };
                        
                        // Adiciona hist√≥rico de manuten√ß√£o para o novo item
                        history.unshift({
                            historyId: Date.now() + 1,
                            toolId: maintenanceTool.id,
                            toolName: maintenanceTool.name,
                            toolImg: maintenanceTool.img,
                            workerName: t.user !== '-' ? t.user : 'ALMOXARIFADO', // Quem reportou
                            qty: qtyToMaintenance,
                            checkoutDate: new Date().toISOString(),
                            returnDate: null,
                            type: 'manutencao'
                        });
                        
                        tools.unshift(maintenanceTool);

                    } else {
                        // Quantidade total ou item √∫nico (comportamento padr√£o)
                        
                        // Se a ferramenta j√° estava em uso, primeiro finaliza o hist√≥rico de empr√©stimo
                        const activeLoan = history.find(h => h.toolId === t.id && h.returnDate === null && h.type === 'emprestimo');
                        if (activeLoan) {
                            activeLoan.returnDate = new Date().toISOString();
                            activeLoan.condition = 'quebrado';
                        }

                        const responsibleUser = t.user !== '-' ? t.user : 'ALMOXARIFADO';
                        t.status = 'quebrado';
                        t.user = 'MANUTEN√á√ÉO';
                        t.maintenanceNote = note;
                        
                        history.unshift({
                            historyId: Date.now(),
                            toolId: t.id,
                            toolName: t.name,
                            toolImg: t.img,
                            workerName: responsibleUser,
                            qty: t.qty || 1,
                            checkoutDate: new Date().toISOString(),
                            returnDate: null,
                            type: 'manutencao'
                        });
                        t.maintenanceInfo = {
                            status: 'Aguardando Or√ßamento',
                            provider: '',
                            cost: 0,
                            quoteNote: '',
                            reportDate: new Date().toISOString(),
                            reportedBy: responsibleUser,
                            approvalDate: null,
                            invoiceFile: null
                        };
                    }

                    closeModal('maintenanceModal');
                    setTimeout(save, 50);
                    playSound('success');
                }

                // --- FUN√á√ïES DE SA√çDA DE MATERIAL ---
                function openMaterialModal(isSearchUpdate = false, toolId = null) {
                    if (!isSearchUpdate) {
                        materialData = { toolId: null, workerId: null, qty: null };
                        resetMaterial(0);
                        document.getElementById('materialSearchInput').value = "";
                        if (toolId) {
                            selectToolForMaterial(toolId);
                        return;
                        }
                    }

                    document.getElementById('materialModalTitle').innerText = "Sa√≠da de Ferramentas";
                    document.getElementById('materialModalStep1').innerText = "1. Qual item ser√° retirado?";
                    
                    const list = document.getElementById('toolGridMaterial');
                    const searchInput = document.getElementById('materialSearchInput');
                    const searchTerm = searchInput.value.toLowerCase();

                    const availableItems = tools.filter(t => 
                        t.status === 'disponivel' && (!t.hasOwnProperty('qty') || t.qty > 0) &&
                        (!searchTerm || t.name.toLowerCase().includes(searchTerm) || (t.code && t.code.toLowerCase().includes(searchTerm)) || (t.brand && t.brand.toLowerCase().includes(searchTerm)))
                    );

                    list.innerHTML = availableItems.map(t => {
                        const stockInfo = `
                            <span class="text-[8px] font-black text-slate-400 uppercase">Estoque</span>
                            <div class="flex items-center justify-center gap-1 text-slate-900 font-black text-lg"><i data-lucide="box" size="12"></i><span>${t.qty || 0}</span></div>
                        `;

                        return `
                        <div onclick="selectToolForMaterial(${t.id})"
                            class="bg-white rounded-2xl p-3 shadow-lg border border-slate-100 cursor-pointer hover:border-blue-500 hover:shadow-xl transition-all flex flex-col text-center group">
                            <div class="relative w-full aspect-square bg-white rounded-xl mb-3 flex items-center justify-center overflow-hidden border border-slate-100">
                                ${t.img ? `<img src="${t.img}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110">` : `<i data-lucide="wrench" class="text-slate-200" size="40"></i>`}
                            </div>
                            <div class="flex-1 flex flex-col justify-between">
                                <h3 class="font-black text-slate-700 uppercase text-[10px] leading-tight h-8 flex items-center justify-center px-1" title="${t.name}">${t.name}</h3>
                                <div class="mt-2 pt-2 border-t border-slate-100">
                                    ${stockInfo}
                                </div>
                            </div>
                        </div>
                    `}).join('');

                    if(availableItems.length === 0) {
                        list.innerHTML = `<p class="text-center text-xs text-slate-400 col-span-full py-10">${searchTerm ? 'Nenhum item encontrado para "' + searchTerm + '".' : 'Nenhum item dispon√≠vel.'}</p>`;
                    }
                    lucide.createIcons();

                    if (!isSearchUpdate) openModal('materialModal');
                }

                function selectToolForMaterial(id) {
                    materialData.toolId = id;
                    resetMaterial(1);
                }

                function processQtyStep() {
                    const tool = tools.find(t => t.id === materialData.toolId);
                    const qtyInput = document.getElementById('materialQtyInput');
                    const qty = parseInt(qtyInput.value);

                    if (!qty || qty <= 0) { // Valida√ß√£o de quantidade
                        document.getElementById('alertModalText').innerText = "Por favor, insira uma quantidade v√°lida.";
                        openModal('alertModal');
                        playSound('error');
                        return;
                    }

                    const isConsumable = tool.hasOwnProperty('qty');
                    if (isConsumable && qty > tool.qty) { // Valida√ß√£o de estoque
                        document.getElementById('alertModalText').innerText = `Quantidade indispon√≠vel. M√°ximo em estoque: ${tool.qty}`;
                        openModal('alertModal');
                        playSound('error');
                        return;
                    }
                    if (!isConsumable && qty > 1) { // Valida√ß√£o para item √∫nico
                        document.getElementById('alertModalText').innerText = "S√≥ √© poss√≠vel emprestar uma unidade desta ferramenta por vez.";
                        openModal('alertModal');
                        playSound('error');
                        return;
                    }

                    materialData.qty = qty;
                    resetMaterial(2);
                }

                function selectWorkerForMaterial(workerId) {
                    materialData.workerId = workerId;
                    resetMaterial(3);
                }

                function resetMaterial(step) {
                    document.getElementById('step-material-tool').classList.toggle('hidden', step !== 0);
                    document.getElementById('step-material-qty').classList.toggle('hidden', step !== 1);
                    document.getElementById('step-material-worker').classList.toggle('hidden', step !== 2);
                    document.getElementById('step-material-confirm').classList.toggle('hidden', step !== 3);

                    if (step === 1) { // Etapa de Quantidade
                        const tool = tools.find(t => t.id === materialData.toolId);
                        const isConsumable = tool.hasOwnProperty('qty');
                        const stockInfo = isConsumable ? `EM ESTOQUE: ${tool.qty}` : 'FERRAMENTA';
                        document.getElementById('selectedToolMaterial').innerHTML = `<div class="w-24 h-24 bg-slate-100 rounded-2xl mx-auto mb-4 overflow-hidden border border-slate-200">${tool.img ? `<img src="${tool.img}" class="w-full h-full object-cover">` : `<div class="flex items-center justify-center h-full text-slate-300"><i data-lucide="wrench"></i></div>`}</div><h3 class="font-black text-slate-900 uppercase text-sm">${tool.name}</h3><p class="text-slate-400 text-[10px] font-bold uppercase">${stockInfo}</p>`;
                        const qtyInput = document.getElementById('materialQtyInput');
                        qtyInput.value = 1;
                        qtyInput.disabled = !isConsumable;
                        if (isConsumable) qtyInput.max = tool.qty;
                        lucide.createIcons();
                    } else if (step === 2) { // Etapa de Colaborador
                        const list = document.getElementById('teamGridMaterial');
                        list.innerHTML = team.map(w => `
                            <div onclick="selectWorkerForMaterial(${w.id})" class="bg-slate-50 p-4 rounded-xl border border-slate-100 cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all flex flex-col items-center gap-2 text-center">
                                <div class="w-10 h-10 bg-white text-blue-600 rounded-full flex items-center justify-center font-black shadow-sm">${w.name.charAt(0)}</div>
                                <div><p class="font-bold text-[10px] uppercase text-slate-700">${w.name}</p><p class="text-[8px] font-black text-slate-400 uppercase">${w.company}</p></div>
                            </div>
                        `).join('');
                        lucide.createIcons();
                    } else if (step === 3) { // Etapa de Confirma√ß√£o
                        const tool = tools.find(t => t.id === materialData.toolId);
                        const worker = team.find(w => w.id === materialData.workerId);
                        const isTool = !tool.hasOwnProperty('qty');
                        const operationType = isTool ? 'Empr√©stimo' : 'Retirada';

                        document.getElementById('confirmationDetails').innerHTML = `
                            <div class="w-24 h-24 bg-slate-100 rounded-2xl mx-auto mb-4 overflow-hidden border border-slate-200">${tool.img ? `<img src="${tool.img}" class="w-full h-full object-cover">` : `<div class="flex items-center justify-center h-full text-slate-300"><i data-lucide="wrench"></i></div>`}</div>
                            <h3 class="font-black text-slate-900 uppercase text-sm">${tool.name}</h3>
                            <p class="text-slate-500 text-xs font-bold">QTD: <span class="text-blue-600">${materialData.qty}</span> | RESPONS√ÅVEL: <span class="text-blue-600">${worker.name}</span></p>
                            <p class="text-slate-500 text-xs font-bold mt-1">VALOR UNIT: <span class="text-emerald-600">${formatBRL(tool.value)}</span></p>
                        `;
                        document.querySelector('#step-material-confirm h4').innerText = `Confirmar ${operationType}?`;
                        document.getElementById('btnFinalizeMaterial').innerText = `Confirmar ${operationType}`;
                        document.getElementById('btnFinalizeMaterial').onclick = finalizeMaterialCheckout;
                        lucide.createIcons();
                    }
                }

                function finalizeMaterialCheckout() {
                    const t = tools.find(x => x.id === materialData.toolId);
                    const w = team.find(x => x.id === materialData.workerId);
                    const qty = materialData.qty;
                    
                    if (!t || !w || !qty) return;

                    const isTool = !t.hasOwnProperty('qty');
                    const hasStock = t.hasOwnProperty('qty');

                    if (isTool) {
                        t.status = 'em uso';
                        t.user = w.name;
                        history.unshift({ 
                            historyId: Date.now(), 
                            toolId: t.id, 
                            toolName: t.name, 
                            toolImg: t.img,
                            workerName: w.name, 
                            qty: 1, 
                            toolValue: t.value || 0,
                            checkoutDate: new Date().toISOString(), 
                            returnDate: null,
                            type: 'emprestimo' 
                        });
                    } else if (hasStock) {
                        if (t.qty < qty) {
                            alert(`Quantidade insuficiente em estoque. Dispon√≠vel: ${t.qty}`);
                            return;
                        }
                        t.qty -= qty;
                        const newTool = { ...t, status: 'em uso', user: w.name, id: Date.now(), original_id: t.id, qty: qty };
                        tools.unshift(newTool);
                        history.unshift({
                            historyId: Date.now() + 1, toolId: newTool.id, toolName: t.name, toolImg: t.img, workerName: w.name, qty: qty, toolValue: t.value || 0,
                            checkoutDate: new Date().toISOString(), returnDate: null, type: 'emprestimo' 
                        });
                    }
                    closeModal('materialModal');
                    save();
                    playSound('success');
                }

                // --- FUN√á√ïES DE ENTRADA (DEVOLU√á√ÉO) ---
                function openCheckinModal(isSearchUpdate = false) {
                     if (!isSearchUpdate) {
                        document.getElementById('checkinSearchInput').value = "";
                        openModal('checkinModal');
                    }
                    
                    const list = document.getElementById('toolGridCheckin');
                    const searchInput = document.getElementById('checkinSearchInput');
                    const searchTerm = searchInput.value.toLowerCase();

                    const borrowedItems = tools.filter(t => 
                        t.status === 'em uso' &&
                        (!searchTerm || t.name.toLowerCase().includes(searchTerm) || (t.code && t.code.toLowerCase().includes(searchTerm)) || (t.user && t.user.toLowerCase().includes(searchTerm)))
                    );

                    list.innerHTML = borrowedItems.map(t => `
                        <div onclick="requestReturn(${t.id}); closeModal('checkinModal');"
                            class="bg-white rounded-2xl p-3 shadow-lg border border-slate-100 cursor-pointer hover:border-blue-500 hover:shadow-xl transition-all flex flex-col text-center group">
                            <div class="relative w-full aspect-square bg-white rounded-xl mb-3 flex items-center justify-center overflow-hidden border border-slate-100">
                                ${t.img ? `<img src="${t.img}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110">` : `<i data-lucide="wrench" class="text-slate-200" size="40"></i>`}
                            </div>
                            <div class="flex-1 flex flex-col justify-between">
                                <h3 class="font-black text-slate-700 uppercase text-[10px] leading-tight h-8 flex items-center justify-center px-1" title="${t.name}">${t.name}</h3>
                                <div class="mt-2 pt-2 border-t border-slate-100">
                                    <p class="text-[9px] font-bold text-slate-400 uppercase">Com: <span class="text-orange-600">${t.user}</span></p>
                                </div>
                            </div>
                        </div>
                    `).join('');

                    if(borrowedItems.length === 0) {
                        list.innerHTML = `<p class="text-center text-xs text-slate-400 col-span-full py-10">${searchTerm ? 'Nenhum item encontrado.' : 'Nenhum item emprestado no momento.'}</p>`;
                    }
                    lucide.createIcons();
                }

                function focusCheckinBarcode() {
                    document.getElementById('checkinBarcodeInput').focus();
                }

                function handleCheckinBarcodeScan(code) {
                    if (!code) return;
                    document.getElementById('checkinSearchInput').value = code;
                    openCheckinModal(true);
                    document.getElementById('checkinBarcodeInput').value = "";
                }

                // --- FUN√á√ïES DE C√ìDIGO DE BARRAS E QR CODE ---
                function focusBarcode() {
                    document.getElementById('barcodeInput').focus();
                }

                function handleBarcodeScan(code) {
                    if (!code) return;
                    document.getElementById('materialSearchInput').value = code;
                    openMaterialModal(true);
                    document.getElementById('barcodeInput').value = ""; // Limpa para a pr√≥xima leitura
                }

                function startQrScanner() {
                    document.getElementById('step-material-tool').style.display = 'none';
                    document.getElementById('qrScannerContainer').style.display = 'block';

                    qrScanner = new Html5Qrcode("qr-reader");
                    const config = { fps: 10, qrbox: { width: 200, height: 200 } };
                    
                    qrScanner.start({ facingMode: "environment" }, config, 
                        (decodedText, decodedResult) => {
                            handleBarcodeScan(decodedText);
                            stopQrScanner();
                        },
                        (errorMessage) => { /* ignore */ }
                    ).catch(err => console.error("QR Scanner Error:", err));
                }

                function stopQrScanner() {
                    if (qrScanner) {
                        qrScanner.stop().then(() => {
                            document.getElementById('step-material-tool').style.display = 'block';
                            document.getElementById('qrScannerContainer').style.display = 'none';
                            qrScanner = null;
                        }).catch(err => console.error("QR Stop Error:", err));
                    }
                }

                function generateQRCodesPDF() {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    let x = 10;
                    let y = 10;
                    const size = 30; 
                    const margin = 15;
                    const pageWidth = doc.internal.pageSize.getWidth();
                    
                    tools.forEach((tool, index) => {
                        if (!tool.code) return;

                        const qr = new QRious({
                            value: tool.code,
                            size: 200
                        });
                        const imgData = qr.toDataURL();

                        if (x + size > pageWidth - margin) {
                            x = 10;
                            y += size + 20;
                        }
                        
                        if (y + size + 20 > doc.internal.pageSize.getHeight() - margin) {
                            doc.addPage();
                            x = 10;
                            y = 10;
                        }

                        doc.addImage(imgData, 'JPEG', x, y, size, size);
                        doc.setFontSize(8);
                        
                        const splitTitle = doc.splitTextToSize(tool.name.toUpperCase(), size + 5);
                        doc.text(splitTitle, x + size / 2, y + size + 5, { align: 'center' });
                        doc.setFontSize(7);
                        doc.text(tool.code, x + size / 2, y + size + 12, { align: 'center' });

                        x += size + margin;
                    });

                    doc.save("etiquetas_ferramentas.pdf");
                }

                function generateLiabilityForm() {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    const borrowedTools = tools.filter(t => t.status === 'em uso');
                    
                    if (borrowedTools.length === 0) {
                        alert("N√£o h√° ferramentas emprestadas no momento para gerar termos.");
                        return;
                    }

                    // Agrupar por usu√°rio
                    const toolsByUser = borrowedTools.reduce((acc, tool) => {
                        const user = tool.user || 'Desconhecido';
                        if (!acc[user]) acc[user] = [];
                        acc[user].push(tool);
                        return acc;
                    }, {});

                    let isFirstPage = true;

                    Object.keys(toolsByUser).forEach((user) => {
                        if (!isFirstPage) doc.addPage();
                        isFirstPage = false;

                        doc.setFontSize(16);
                        doc.text("Termo de Responsabilidade", 105, 20, { align: "center" });
                        
                        doc.setFontSize(12);
                        doc.text(`Eu, ${user}, declaro que recebi os itens abaixo relacionados em perfeito estado de conserva√ß√£o e funcionamento, assumindo a responsabilidade por sua guarda e uso adequado.`, 14, 35, { maxWidth: 180 });

                        const userTools = toolsByUser[user].map(t => [t.code || '-', t.name, t.brand || '-']);
                        
                        doc.autoTable({
                            head: [['C√≥d.', 'Ferramenta', 'Marca']],
                            body: userTools,
                            startY: 50,
                            theme: 'grid',
                            headStyles: { fillColor: [51, 65, 85] }
                        });

                        const finalY = doc.lastAutoTable.finalY + 40;
                        
                        doc.line(60, finalY, 150, finalY);
                        doc.setFontSize(10);
                        doc.text("Assinatura do Colaborador", 105, finalY + 5, { align: "center" });
                        doc.text(`Data: ${new Date().toLocaleDateString()}`, 105, finalY + 12, { align: "center" });
                    });

                    doc.save("termo_responsabilidade.pdf");
                }

                function generateChecklistPDF() {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    doc.setFontSize(18);
                    doc.text("Checklist de Confer√™ncia de Estoque", 14, 20);
                    doc.setFontSize(10);
                    doc.text(`Data: ${new Date().toLocaleDateString()} - Hora: ${new Date().toLocaleTimeString()}`, 14, 28);

                    const sortedTools = [...tools].sort((a, b) => (a.name || '').localeCompare(b.name || ''));

                    const tableData = sortedTools.map(t => [
                        t.code || '',
                        t.name,
                        t.brand || '',
                        t.status === 'disponivel' ? 'Disp.' : (t.status === 'em uso' ? `Com ${t.user}` : t.status),
                        '[   ]' 
                    ]);

                    doc.autoTable({
                        head: [['C√≥d.', 'Item', 'Marca', 'Status Sist.', 'Conferido']],
                        body: tableData,
                        startY: 35,
                        theme: 'grid',
                        styles: { fontSize: 9 },
                        columnStyles: { 4: { halign: 'center', fontStyle: 'bold' } },
                        headStyles: { fillColor: [51, 65, 85] }
                    });

                    doc.save("checklist_estoque.pdf");
                }

                function startCheckinQrScanner() {
                     document.getElementById('checkin-step-list').style.display = 'none';
                     document.getElementById('checkinQrScannerContainer').style.display = 'block';
                     
                     qrScanner = new Html5Qrcode("checkin-qr-reader");
                     qrScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 200, height: 200 } },
                        (decodedText) => {
                            handleCheckinBarcodeScan(decodedText);
                            stopCheckinQrScanner();
                        },
                        () => {}
                     ).catch(err => console.error("QR Scanner Error:", err));
                }

                function stopCheckinQrScanner() {
                    if (qrScanner) {
                        qrScanner.stop().then(() => {
                             document.getElementById('checkin-step-list').style.display = 'block';
                             document.getElementById('checkinQrScannerContainer').style.display = 'none';
                             qrScanner = null;
                        }).catch(err => console.error("QR Stop Error:", err));
                    }
                }

                // --- FUN√á√ïES DE ALERTA DE ATRASO ---
                function checkOverdueTools() {
                    const now = new Date();
                    const overdueTools = history.filter(h => {
                        if (h.returnDate || h.type !== 'emprestimo') {
                            return false;
                        }
                        const checkoutDate = new Date(h.checkoutDate);
                        const diffHours = (now - checkoutDate) / (1000 * 60 * 60);
                        return diffHours > (appSettings.overdueHours || 24);
                    });
                    return overdueTools;
                }

                function renderOverdueAlert() {
                    const overdueTools = checkOverdueTools();
                    const overdueBtn = document.getElementById('overdueBtn');
                    const overdueBadge = document.getElementById('overdueCountBadge');

                    if (overdueBtn && overdueBadge) {
                        if (overdueTools.length > 0) {
                            overdueBtn.classList.remove('hidden');
                            overdueBadge.innerText = overdueTools.length;
                            const textSpan = overdueBtn.querySelector('span:last-child');
                            if (textSpan) {
                                textSpan.innerText = `Ferramenta${overdueTools.length > 1 ? 's' : ''} com devolu√ß√£o atrasada. Clique para ver.`;
                            }
                        } else {
                            overdueBtn.classList.add('hidden');
                        }
                    }

                    // Bolinha de alerta no bot√£o do Painel Principal
                    const mainOverdueBadge = document.getElementById('mainOverdueBadge');
                    if (mainOverdueBadge) {
                        mainOverdueBadge.classList.toggle('hidden', overdueTools.length === 0);
                    }

                    // Bolinha de alerta no bot√£o da Central de Opera√ß√µes
                    const actionsOverdueBadge = document.getElementById('actionsOverdueBadge');
                    if (actionsOverdueBadge) {
                        actionsOverdueBadge.classList.toggle('hidden', overdueTools.length === 0);
                    }
                }

                function openOverdueModal() {
                    const overdueTools = checkOverdueTools();
                    const listEl = document.getElementById('overdueList');
                    
                    if (overdueTools.length === 0) {
                        listEl.innerHTML = '<p class="text-center text-slate-500 py-8">Nenhuma ferramenta com devolu√ß√£o atrasada.</p>';
                    } else {
                        listEl.innerHTML = overdueTools.map(h => {
                            const checkoutDate = new Date(h.checkoutDate);
                            const now = new Date();
                            const diffHours = Math.floor((now - checkoutDate) / (1000 * 60 * 60));
                            const diffDays = Math.floor(diffHours / 24);
                            const remainingHours = diffHours % 24;
                            let timeString = `${diffDays}d ${remainingHours}h`;
                            
                            const tool = tools.find(t => t.id === h.toolId) || {};
                            const toolImg = h.toolImg || tool.img;

                            return `<div class="flex items-center gap-4 p-4 mb-3 bg-slate-50 rounded-xl border border-slate-100"><div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center overflow-hidden border">${toolImg ? `<img src="${toolImg}" class="w-full h-full object-cover">` : `<i data-lucide="wrench" class="text-slate-300"></i>`}</div><div class="flex-1"><p class="font-bold text-xs uppercase text-slate-800">${h.toolName}</p><p class="text-[10px] font-bold text-slate-400">COM: <span class="text-orange-600">${h.workerName}</span></p></div><div class="text-right"><p class="text-xs font-bold text-rose-600">Atrasado h√°</p><p class="text-lg font-black text-rose-600">${timeString.trim()}</p></div></div>`;
                        }).join('');
                    }

                    openModal('overdueModal');
                    lucide.createIcons();
                }

                // --- FUN√á√ïES DE RELAT√ìRIO ---
                function exportToolsToExcel() {
                    // --- 0. Common Styles ---
                    const headerStyle = {
                        font: { bold: true, color: { rgb: "FFFFFF" }, sz: 12 },
                        fill: { fgColor: { rgb: "107C41" } }, // Green Header
                        alignment: { horizontal: "center", vertical: "center" }
                    };
                    const centerAlign = { alignment: { horizontal: "center", vertical: "center" } };
                    const currencyFormat = { numFmt: 'R$ #,##0.00' };
                    const borderAll = {
                        border: {
                            top: { style: "thin", color: { rgb: "E2E8F0" } },
                            bottom: { style: "thin", color: { rgb: "E2E8F0" } },
                            left: { style: "thin", color: { rgb: "E2E8F0" } },
                            right: { style: "thin", color: { rgb: "E2E8F0" } }
                        }
                    };

                    const workbook = XLSX.utils.book_new();

                    // --- 1. GUIA ESTOQUE ---
                    (() => {
                        const statusStyles = {
                            disponivel: { fill: { fgColor: { rgb: "D1FAE5" } } },
                            'em uso':   { fill: { fgColor: { rgb: "FFEDD5" } } },
                            quebrado:   { fill: { fgColor: { rgb: "FEE2E2" } } }
                        };
                        const sortedTools = [...tools].sort((a, b) => (a.code || '').localeCompare(b.code || '', undefined, { numeric: true, sensitivity: 'base' }));
                        const headers = ['Nome', 'C√≥digo', 'Local', 'Status', 'Respons√°vel', 'Valor', 'Quantidade'];
                        const data = sortedTools.map(t => [
                            capitalize(t.name), t.code, t.location, capitalize(t.status), capitalize(t.user), t.value || 0, t.qty || 0
                        ]);
                        const worksheetData = [headers, ...data];
                        const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);

                        worksheetData.forEach((row, r) => {
                            row.forEach((cell, c) => {
                                const cellRef = XLSX.utils.encode_cell({ r, c });
                                if (!worksheet[cellRef]) return;
                                worksheet[cellRef].s = { ...borderAll };
                                if (r === 0) {
                                    worksheet[cellRef].s = { ...headerStyle, ...borderAll };
                                } else {
                                    if (c === 5 || c === 6) { // Valor & Quantidade
                                        worksheet[cellRef].t = 'n';
                                    }
                                    if ([1, 2, 3, 4, 6].includes(c)) worksheet[cellRef].s.alignment = centerAlign.alignment;
                                    if (c === 5) { worksheet[cellRef].s.numFmt = currencyFormat.numFmt; } // Valor

                                    if (c === 3) {
                                        const status = (typeof cell === 'string' ? cell.toLowerCase() : '');
                                        if (statusStyles[status]) worksheet[cellRef].s.fill = statusStyles[status].fill;
                                    }
                                }
                            });
                        });

                        worksheet['!cols'] = [ { wch: 40 }, { wch: 15 }, { wch: 25 }, { wch: 15 }, { wch: 25 }, { wch: 15 }, { wch: 12 } ];
                        worksheet['!autofilter'] = { ref: `A1:G${data.length + 1}` };
                        XLSX.utils.book_append_sheet(workbook, worksheet, "Estoque");
                    })();

                    // --- 2. GUIA FOLLOW-UP ---
                    (() => {
                        const maintenanceTools = tools.filter(t => t.status === 'quebrado' && t.maintenanceInfo);
                        const headers = ['Equipamento', 'C√≥digo', 'Problema', 'Status Atual', 'Fornecedor', 'Custo Or√ßado', 'Reportado Por', 'Data Reporte'];
                        const data = maintenanceTools.map(t => {
                            const info = t.maintenanceInfo || {};
                            return [ t.name, t.code, t.maintenanceNote, info.status, info.provider, info.cost || 0, info.reportedBy, formatISODate(info.reportDate) ];
                        });
                        const worksheetData = [headers, ...data];
                        const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);

                        worksheetData.forEach((row, r) => {
                            row.forEach((cell, c) => {
                                const cellRef = XLSX.utils.encode_cell({ r, c });
                                if (!worksheet[cellRef]) return;
                                worksheet[cellRef].s = { ...borderAll };
                                if (r === 0) {
                                    worksheet[cellRef].s = { ...headerStyle, ...borderAll };
                                } else {
                                    if ([1, 3, 4, 6, 7].includes(c)) worksheet[cellRef].s.alignment = centerAlign.alignment;
                                    if (c === 5) { worksheet[cellRef].t = 'n'; worksheet[cellRef].s.numFmt = currencyFormat.numFmt; }
                                }
                            });
                        });

                        worksheet['!cols'] = [ { wch: 40 }, { wch: 15 }, { wch: 50 }, { wch: 20 }, { wch: 25 }, { wch: 15 }, { wch: 25 }, { wch: 20 } ];
                        worksheet['!autofilter'] = { ref: `A1:H${data.length + 1}` };
                        XLSX.utils.book_append_sheet(workbook, worksheet, "FollowUp");
                    })();

                    // --- 3. GUIA HIST√ìRICO ---
                    (() => {
                        const headers = ['Ferramenta', 'Respons√°vel', 'Qtd', 'Data Retirada', 'Data Devolu√ß√£o', 'Status', 'Tempo de Posse'];
                        const data = history.sort((a,b) => new Date(b.checkoutDate) - new Date(a.checkoutDate)).map(h => {
                            let statusLabel;
                            if (h.returnDate) {
                                statusLabel = h.condition === 'quebrado' ? 'Devolvido (Quebrado)' : 'Devolvido';
                            } else {
                                statusLabel = h.type === 'manutencao' ? 'Em Manuten√ß√£o' : 'Em Uso';
                            }
                            return [ h.toolName, h.workerName, h.qty, formatISODate(h.checkoutDate), formatISODate(h.returnDate), statusLabel, formatDuration(h.checkoutDate, h.returnDate) ];
                        });
                        const worksheetData = [headers, ...data];
                        const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);

                        worksheetData.forEach((row, r) => {
                            row.forEach((cell, c) => {
                                const cellRef = XLSX.utils.encode_cell({ r, c });
                                if (!worksheet[cellRef]) return;
                                worksheet[cellRef].s = { ...borderAll };
                                if (r === 0) {
                                    worksheet[cellRef].s = { ...headerStyle, ...borderAll };
                                } else {
                                    if (c === 2) { // Qtd column
                                        worksheet[cellRef].t = 'n';
                                    }
                                    if ([2, 3, 4, 5, 6].includes(c)) worksheet[cellRef].s.alignment = centerAlign.alignment;
                                }
                            });
                        });
                        worksheet['!cols'] = [ { wch: 40 }, { wch: 25 }, { wch: 10 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 15 } ];
                        worksheet['!autofilter'] = { ref: `A1:G${data.length + 1}` };
                        XLSX.utils.book_append_sheet(workbook, worksheet, "Historico");
                    })();

                    // --- Download Workbook ---
                    XLSX.writeFile(workbook, "Relatorio_Completo_Ferramentaria.xlsx");
                }

                function exportToPDF() {
                    try {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF({ orientation: 'landscape' });

                        // --- 1. GUIA ESTOQUE ---
                        doc.text("Relat√≥rio de Estoque", 14, 16);
                        const estoqueHead = [['Nome', 'C√≥digo', 'Local', 'Status', 'Respons√°vel', 'Valor', 'Quantidade']];
                        const sortedTools = [...tools].sort((a, b) => (a.code || '').localeCompare(b.code || '', undefined, { numeric: true, sensitivity: 'base' }));
                        const estoqueBody = sortedTools.map(t => [
                            capitalize(t.name),
                            t.code || '',
                            t.location || '',
                            capitalize(t.status),
                            capitalize(t.user),
                            formatBRL(t.value || 0),
                            t.qty || 0
                        ]);
                        doc.autoTable({
                            head: estoqueHead,
                            body: estoqueBody,
                            startY: 22,
                            theme: 'grid',
                            headStyles: { fillColor: [11, 17, 32] }
                        });

                        // --- 2. GUIA FOLLOW-UP ---
                        doc.addPage();
                        doc.text("Relat√≥rio de Follow-Up de Manuten√ß√£o", 14, 16);
                        const maintHead = [['Equipamento', 'C√≥digo', 'Problema', 'Status Atual', 'Fornecedor', 'Custo Or√ßado', 'Reportado Por', 'Data Reporte']];
                        const maintenanceTools = tools.filter(t => t.status === 'quebrado' && t.maintenanceInfo);
                        const maintBody = maintenanceTools.map(t => {
                            const info = t.maintenanceInfo || {};
                            return [
                                t.name,
                                t.code || '',
                                t.maintenanceNote || '',
                                info.status || '',
                                info.provider || '',
                                formatBRL(info.cost || 0),
                                info.reportedBy || '',
                                formatISODate(info.reportDate)
                            ];
                        });
                        doc.autoTable({
                            head: maintHead,
                            body: maintBody,
                            startY: 22,
                            theme: 'grid',
                            headStyles: { fillColor: [11, 17, 32] }
                        });

                        // --- 3. GUIA HIST√ìRICO ---
                        doc.addPage();
                        doc.text("Relat√≥rio de Hist√≥rico de Movimenta√ß√µes", 14, 16);
                        const historyHead = [['Ferramenta', 'Respons√°vel', 'Qtd', 'Data Retirada', 'Data Devolu√ß√£o', 'Status', 'Tempo de Posse']];
                        const historyBody = history.sort((a, b) => new Date(b.checkoutDate) - new Date(a.checkoutDate)).map(h => {
                            let statusLabel;
                            if (h.returnDate) {
                                statusLabel = h.condition === 'quebrado' ? 'Devolvido (Quebrado)' : 'Devolvido';
                            } else {
                                statusLabel = h.type === 'manutencao' ? 'Em Manuten√ß√£o' : 'Em Uso';
                            }
                            return [h.toolName, h.workerName, h.qty, formatISODate(h.checkoutDate), formatISODate(h.returnDate), statusLabel, formatDuration(h.checkoutDate, h.returnDate)];
                        });
                        doc.autoTable({
                            head: historyHead,
                            body: historyBody,
                            startY: 22,
                            theme: 'grid',
                            headStyles: { fillColor: [11, 17, 32] }
                        });

                        doc.save("Relatorio_Completo_Ferramentaria.pdf");
                    } catch (e) {
                        console.error("Erro ao gerar PDF:", e);
                        alert("Ocorreu um erro ao gerar o PDF. Verifique o console para mais detalhes.");
                    }
                }

                // --- FUN√á√ïES DE AUDITORIA ---
                function openAuditModal() {
                    auditSession.missing = tools.filter(t => t.status === 'disponivel' && (!t.hasOwnProperty('qty') || t.qty === 0));
                    auditSession.found = [];
                    updateAuditUI();
                    document.getElementById('auditInput').value = '';
                    openModal('auditModal');
                    document.getElementById('auditInput').focus();
                }

                function handleAuditScan(code) {
                    if (!code) return;
                    const index = auditSession.missing.findIndex(t => t.code === code);
                    if (index > -1) {
                        const tool = auditSession.missing.splice(index, 1)[0];
                        auditSession.found.unshift(tool);
                        updateAuditUI();
                        document.getElementById('auditInput').value = '';
                    }
                }

                function updateAuditUI() {
                    document.getElementById('auditMissingCount').innerText = auditSession.missing.length;
                    document.getElementById('auditFoundCount').innerText = auditSession.found.length;
                    const renderList = (list) => list.map(t => `<div class="bg-white p-2 rounded border border-slate-200 text-xs flex justify-between"><span>${t.name}</span><span class="font-bold text-slate-400">${t.code}</span></div>`).join('');
                    document.getElementById('auditMissingList').innerHTML = renderList(auditSession.missing);
                    document.getElementById('auditFoundList').innerHTML = renderList(auditSession.found);
                }

                function finishAudit() {
                    if (auditSession.missing.length > 0) {
                        alert(`Auditoria finalizada. ${auditSession.missing.length} itens n√£o foram encontrados.`);
                    } else {
                        alert("Auditoria perfeita! Todos os itens encontrados.");
                    }
                    closeModal('auditModal');
                }
            </script>
            <script>
                // --- FUN√á√ïES DE GEST√ÉO DE MANUTEN√á√ÉO ---

                function setMaintenanceFilter(f) {
                    maintenanceFilter = f;
                    document.querySelectorAll('#section-maintenance .filter-pill').forEach(b => b.classList.remove('active'));
                    document.getElementById(`maint-filter-${f.toLowerCase().replace(/ /g, '-')}`).classList.add('active');
                    renderMaintenance();
                }

                function renderMaintenance() {
                    const grid = document.getElementById('maintenanceGrid');
                    if (!grid) return;
                    const searchTerm = document.getElementById('maintenanceSearchInput').value.toLowerCase();

                    const allMaintenanceTools = tools.filter(t => t.status === 'quebrado' && t.maintenanceInfo);
                    document.getElementById('maintenanceTotalCount').innerText = allMaintenanceTools.length;

                    const maintenanceTools = tools.filter(t => {
                        const hasMaintInfo = t.status === 'quebrado' && t.maintenanceInfo;
                        if (!hasMaintInfo) return false;

                        const matchesFilter = maintenanceFilter === 'all' || (t.maintenanceInfo && t.maintenanceInfo.status === maintenanceFilter);

                        const info = t.maintenanceInfo || {};
                        const matchesSearch = !searchTerm || 
                                              (t.name && t.name.toLowerCase().includes(searchTerm)) ||
                                              (t.code && t.code.toLowerCase().includes(searchTerm)) ||
                                              (info.reportedBy && info.reportedBy.toLowerCase().includes(searchTerm));
                        
                        return matchesFilter && matchesSearch;
                    });

                    if (maintenanceTools.length === 0) {
                        grid.innerHTML = `<p class="text-center text-sm text-slate-400 col-span-full py-20">Nenhum item em manuten√ß√£o encontrado.</p>`;
                        return;
                    }

                    grid.innerHTML = maintenanceTools.map(t => {
                        const info = t.maintenanceInfo || {};
                        return `
                        <div class="bg-white rounded-2xl p-5 shadow-lg border border-slate-100 flex flex-col gap-4 group cursor-pointer hover:shadow-xl hover:-translate-y-1 transition-all relative" onclick="openManageMaintenanceModal(${t.id})">
                            <div class="absolute top-4 right-4 z-10">
                                <button onclick="requestDeleteMaintenance(${t.id}, event)" class="p-2 text-slate-400 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity" title="Excluir Manuten√ß√£o"><i data-lucide="trash-2" size="16"></i></button>
                            </div>
                            <div class="flex items-start gap-4">
                                <div class="w-16 h-16 bg-slate-50 rounded-xl flex items-center justify-center overflow-hidden border border-slate-100 shadow-sm">
                                    ${t.img ? `<img src="${t.img}" class="w-full h-full object-cover">` : `<i data-lucide="wrench" class="text-slate-300" size="24"></i>`}
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-black text-slate-800 uppercase leading-tight">${t.name}</h3>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase">${t.code || 'S/C√ìDIGO'}</p>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <div class="bg-amber-50/50 border border-amber-200/50 rounded-lg p-3 text-center">
                                    <div class="flex items-center justify-center gap-1">
                                        <i data-lucide="alert-circle" class="text-amber-500" size="14"></i>
                                        <p class="text-[9px] font-black text-amber-700 uppercase">Problema Reportado</p>
                                    </div>
                                    <p class="text-xs font-semibold text-amber-900 mt-1 truncate" title="${t.maintenanceNote || ''}">${t.maintenanceNote || 'N/A'}</p>
                                </div>
                                ${info.provider ? `
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="bg-blue-50/50 border border-blue-200/50 rounded-lg p-3 text-center">
                                        <div class="flex items-center justify-center gap-1">
                                            <i data-lucide="building-2" class="text-blue-600" size="14"></i>
                                            <p class="text-[9px] font-black text-blue-700 uppercase">Empresa</p>
                                        </div>
                                        <p class="text-xs font-bold text-blue-900 mt-1 truncate" title="${info.provider}">${info.provider}</p>
                                    </div>
                                    <div class="bg-rose-50/50 border border-rose-200/50 rounded-lg p-3 text-center">
                                        <div class="flex items-center justify-center gap-1">
                                            <i data-lucide="dollar-sign" class="text-rose-600" size="14"></i>
                                            <p class="text-[9px] font-black text-rose-700 uppercase">Or√ßamento</p>
                                        </div>
                                        <p class="text-sm font-black text-rose-900 mt-1">${formatBRL(info.cost)}</p>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                             <!-- Mini Timeline -->
                            <div class="mt-auto pt-4">
                                <p class="text-[9px] font-bold text-slate-400 uppercase mb-2">Status</p>
                                <div class="flex items-center gap-1"><div class="flex-1 h-1.5 rounded-full ${info.status === 'Aguardando Or√ßamento' || info.status === 'Aguardando Aprova√ß√£o' || info.status === 'Em Conserto' || info.status === 'Finalizado' ? 'bg-amber-400' : 'bg-slate-200'}"></div><div class="flex-1 h-1.5 rounded-full ${info.status === 'Aguardando Aprova√ß√£o' || info.status === 'Em Conserto' || info.status === 'Finalizado' ? 'bg-sky-400' : 'bg-slate-200'}"></div><div class="flex-1 h-1.5 rounded-full ${info.status === 'Em Conserto' || info.status === 'Finalizado' ? 'bg-indigo-400' : 'bg-slate-200'}"></div><div class="flex-1 h-1.5 rounded-full ${info.status === 'Finalizado' ? 'bg-emerald-400' : 'bg-slate-200'}"></div></div>
                                <p class="text-center text-xs font-black uppercase mt-2 ${info.status === 'Aguardando Or√ßamento' ? 'text-amber-600' : info.status === 'Aguardando Aprova√ß√£o' ? 'text-sky-600' : info.status === 'Em Conserto' ? 'text-indigo-600' : info.status === 'Finalizado' ? 'text-emerald-600' : 'text-red-600'}">${info.status}</p>
                            </div>
                        </div>
                        `
                    }).join('');
                    lucide.createIcons();
                }

            function updateMaintenanceTimeline(status) {
                const statusOrder = ['Aguardando Or√ßamento', 'Aguardando Aprova√ß√£o', 'Em Conserto', 'Finalizado'];
                const currentStatusIndex = statusOrder.indexOf(status);

                for (let i = 1; i <= 4; i++) {
                    const stepEl = document.getElementById(`timeline-step-${i}`);
                    if (stepEl) {
                        const iconContainer = stepEl.querySelector('span');
                        const title = stepEl.querySelector('h3');
                        
                        iconContainer.className = 'absolute flex items-center justify-center w-8 h-8 bg-slate-100 rounded-full -left-4';
                        title.className = 'font-black text-slate-700';

                        if (i - 1 < currentStatusIndex || (status === 'Finalizado' && i <= 4)) {
                            iconContainer.classList.add('bg-emerald-100', 'text-emerald-700');
                            title.classList.add('text-emerald-700');
                        }
                        if (i - 1 === currentStatusIndex && status !== 'Finalizado') {
                            iconContainer.classList.add('bg-blue-100', 'text-blue-700');
                            title.classList.add('text-blue-700');
                        }
                    }
                }
            }

                function openManageMaintenanceModal(id) {
                    itemToManageMaintenanceId = id;
                    const tool = tools.find(t => t.id === id);
                    if (!tool || !tool.maintenanceInfo) return;

                    const info = tool.maintenanceInfo;

                updateMaintenanceTimeline(info.status);

                    // Preenche informa√ß√µes gerais
                    document.getElementById('maintenanceToolName').innerText = `${tool.name} (#${tool.code || 'S/C'})`;
                    document.getElementById('maintenanceToolInfo').innerHTML = `
                        <div class="w-24 h-24 bg-slate-100 rounded-2xl mx-auto mb-4 overflow-hidden border border-slate-200">
                            ${tool.img ? `<img src="${tool.img}" class="w-full h-full object-cover">` : `<i data-lucide="wrench" class="text-slate-300" size="40"></i>`}
                        </div>
                        <p class="text-xs text-slate-500 font-bold">Reportado por: <span class="text-blue-600">${info.reportedBy}</span></p>
                        <p class="text-xs text-slate-500 font-bold">Data: <span class="text-blue-600">${formatISODate(info.reportDate)}</span></p>
                    `;

                    // Esconde todos os passos de a√ß√£o
                    document.querySelectorAll('#maintenanceActions > div').forEach(div => div.classList.add('hidden'));

                    // Mostra o passo correto
                    switch (info.status) {
                        case 'Aguardando Or√ßamento':
                            document.getElementById('maintenance-step-quote').classList.remove('hidden');
                            document.getElementById('quoteProviderInput').value = info.provider || '';
                            document.getElementById('quoteCostInput').value = info.cost || '';
                            document.getElementById('quoteNoteInput').value = info.quoteNote || '';
                            document.getElementById('btnSaveQuote').onclick = () => saveQuote(id);
                            break;
                        case 'Aguardando Aprova√ß√£o':
                            document.getElementById('maintenance-step-approval').classList.remove('hidden');
                            document.getElementById('quoteDetailsDisplay').innerHTML = `
                                <p class="text-xs font-bold text-slate-500">Fornecedor: <span class="font-semibold text-slate-700">${info.provider}</span></p>
                                <p class="text-xs font-bold text-slate-500">Custo: <span class="font-semibold text-emerald-600">${formatBRL(info.cost)}</span></p>
                                <p class="text-xs font-bold text-slate-500">Detalhes: <span class="font-semibold text-slate-700">${info.quoteNote || 'N/A'}</span></p>
                            `;
                            document.getElementById('btnApproveRepair').onclick = () => approveRepair(id);
                            document.getElementById('btnRejectRepair').onclick = () => rejectRepair(id);
                            break;
                        case 'Em Conserto':
                            document.getElementById('maintenance-step-finish').classList.remove('hidden');
                            const fileInput = document.getElementById('invoiceFileInput');
                            const dropAreaText = document.getElementById('drop-area-text');
                            const fileNameDisplay = document.getElementById('file-name-display');
                            fileInput.value = null;
                            dropAreaText.classList.remove('hidden');
                            fileNameDisplay.classList.add('hidden');
                            document.getElementById('btnFinishRepair').onclick = () => finishRepair(id);
                            document.getElementById('btnBackToQuote').onclick = () => sendBackToQuote(id);
                            break;
                        case 'Finalizado':
                            document.getElementById('maintenance-step-conclude').classList.remove('hidden');
                            const invoiceDisplay = document.getElementById('invoiceDisplay');
                            if (info.invoiceFile) {
                                invoiceDisplay.classList.remove('hidden');
                                invoiceDisplay.innerHTML = `
                                    <div class="flex gap-2 items-center bg-slate-100 p-3 rounded-xl border border-slate-200">
                                        <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center text-slate-400 border border-slate-200">
                                            <i data-lucide="${info.invoiceFile.startsWith('data:application/pdf') ? 'file-text' : 'image'}" size="20"></i>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-xs font-bold text-slate-700 truncate">Nota Fiscal Anexada</p>
                                            <p class="text-[10px] text-slate-400 uppercase">Clique para visualizar</p>
                                        </div>
                                        <button onclick="openZoom('${info.invoiceFile}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Visualizar"><i data-lucide="eye" size="18"></i></button>
                                        <button onclick="deleteInvoice(${id})" class="p-2 text-rose-500 hover:bg-rose-50 rounded-lg transition-colors" title="Excluir Nota"><i data-lucide="trash-2" size="18"></i></button>
                                    </div>
                                `;
                            } else {
                                invoiceDisplay.classList.add('hidden');
                            }
                            document.getElementById('btnConcludeMaintenance').onclick = () => concludeAndMoveToStock(id);
                            break;
                    }

                    openModal('manageMaintenanceModal');
                    lucide.createIcons();
                }

                function saveQuote(id) {
                    const tool = tools.find(t => t.id === id);
                    if (!tool || !tool.maintenanceInfo) return;

                    tool.maintenanceInfo.provider = document.getElementById('quoteProviderInput').value.toUpperCase();
                    tool.maintenanceInfo.cost = parseFloat(document.getElementById('quoteCostInput').value) || 0;
                    tool.maintenanceInfo.quoteNote = document.getElementById('quoteNoteInput').value;
                    tool.maintenanceInfo.status = 'Aguardando Aprova√ß√£o';

                    closeModal('manageMaintenanceModal');
                    setTimeout(save, 50);
                    playSound('success');
                }

                function approveRepair(id) {
                    const tool = tools.find(t => t.id === id);
                    if (!tool || !tool.maintenanceInfo) return;

                    tool.maintenanceInfo.status = 'Em Conserto';
                    tool.maintenanceInfo.approvalDate = new Date().toISOString();
                    closeModal('manageMaintenanceModal');
                    setTimeout(save, 50);
                    playSound('success');
                }

                function sendBackToQuote(id) {
                    const tool = tools.find(t => t.id === id);
                    if (!tool || !tool.maintenanceInfo) return;
                    tool.maintenanceInfo.status = 'Aguardando Or√ßamento';
                    tool.maintenanceInfo.provider = '';
                    tool.maintenanceInfo.cost = 0;
                    tool.maintenanceInfo.quoteNote = '';
                    tool.maintenanceInfo.approvalDate = null;
                    tool.maintenanceInfo.invoiceFile = null;
                    closeModal('manageMaintenanceModal');
                    setTimeout(save, 50);
                    playSound('success');
                }

                function rejectRepair(id) {
                    const tool = tools.find(t => t.id === id);
                    if (!tool || !tool.maintenanceInfo) return;
                    tool.maintenanceInfo.status = 'Aguardando Or√ßamento';
                    tool.maintenanceInfo.provider = '';
                    tool.maintenanceInfo.cost = 0;
                    tool.maintenanceInfo.quoteNote = '';
                    tool.maintenanceInfo.approvalDate = null;
                    tool.maintenanceInfo.invoiceFile = null;
                    closeModal('manageMaintenanceModal');
                    setTimeout(save, 50);
                    playSound('success');
                }

                function requestDeleteMaintenance(id, event) {
                    event.stopPropagation();
                    const tool = tools.find(t => t.id === id);
                    if (!tool) return;

                    const modal = document.getElementById('deleteModal');
                    modal.querySelector('h3').innerText = 'Cancelar Manuten√ß√£o?';
                    modal.querySelector('p').innerText = `Voc√™ tem certeza que deseja cancelar a manuten√ß√£o para "${tool.name}"? O item retornar√° ao status "Dispon√≠vel".`;
                    document.getElementById('confirmDeleteBtn').onclick = () => {
                        deleteMaintenance(id);
                    };
                    openModal('deleteModal');
                }

                function deleteInvoice(id) {
                    const tool = tools.find(t => t.id === id);
                    if (!tool || !tool.maintenanceInfo) return;

                    const modal = document.getElementById('deleteModal');
                    modal.querySelector('h3').innerText = 'Excluir Nota Fiscal?';
                    modal.querySelector('p').innerText = 'Deseja realmente excluir a nota fiscal? O status do item ser√° revertido para "Em Conserto".';
                    document.getElementById('confirmDeleteBtn').onclick = () => {
                        tool.maintenanceInfo.invoiceFile = null;
                        tool.maintenanceInfo.status = 'Em Conserto';
                        closeModal('deleteModal');
                        setTimeout(() => {
                            save();
                            openManageMaintenanceModal(id);
                        }, 50);
                        playSound('success');
                    };
                    openModal('deleteModal');
                }

                function deleteMaintenance(id) {
                    const tool = tools.find(t => t.id === id);
                    if (tool && tool.status === 'quebrado') {
                        tool.status = 'disponivel';
                        tool.user = '-';
                        tool.maintenanceNote = '';
                        tool.maintenanceInfo = null;
                        history = history.filter(h => !(h.toolId === id && h.type === 'manutencao' && h.returnDate === null));
                        closeModal('deleteModal');
                        setTimeout(save, 50);
                        playSound('success');
                    }
                }

                const dropArea = document.getElementById('drop-area');
                if (dropArea) {
                    const fileInput = document.getElementById('invoiceFileInput');
                    const dropAreaText = document.getElementById('drop-area-text');
                    const fileNameDisplay = document.getElementById('file-name-display');

                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                        dropArea.addEventListener(eventName, preventDefaults, false);
                    });

                    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

                    ['dragenter', 'dragover'].forEach(eventName => {
                        dropArea.addEventListener(eventName, () => dropArea.classList.add('border-blue-500', 'bg-blue-50'), false);
                    });

                    ['dragleave', 'drop'].forEach(eventName => {
                        dropArea.addEventListener(eventName, () => dropArea.classList.remove('border-blue-500', 'bg-blue-50'), false);
                    });

                    dropArea.addEventListener('drop', handleDrop, false);
                    fileInput.addEventListener('change', (e) => handleFiles(e.target.files), false);

                    function handleDrop(e) {
                        fileInput.files = e.dataTransfer.files;
                        handleFiles(fileInput.files);
                    }

                    function handleFiles(files) {
                        fileNameDisplay.textContent = files.length > 0 ? files[0].name : '';
                        dropAreaText.classList.toggle('hidden', files.length > 0);
                        fileNameDisplay.classList.toggle('hidden', files.length === 0);
                    }
                }
            </script>
        </body>
        </html>